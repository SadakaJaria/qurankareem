<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ğŸ“– Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ… â€“ ØµØ¯Ù‚Ø© Ø¬Ø§Ø±ÙŠØ©</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
:root{
  --gold:#d4af37;
  --ink:#0f172a;
  --soft:#f1f5f9;
}

/* Ø§Ù„Ø£Ø³Ø§Ø³ */
body{
  font-family:"Noto Naskh Arabic UI","Segoe UI",system-ui,sans-serif;
  transition:background .25s,color .25s;
}

/* ===== Ø§Ù„Ù‡ÙŠØ¯Ø± ===== */
header#appHeader{
  padding:1rem;
  background:transparent;
}
#themeToggle{
  width:2.3rem;height:2.3rem;display:flex;align-items:center;justify-content:center;
  border-radius:.65rem;background:var(--gold);color:#1f2937;
}
.clock-box{text-align:end;line-height:1.25}
.clock-box div{font-size:.9rem}

/* ===== Ø²Ø± ÙˆØ§ØªØ³Ø§Ø¨ ===== */
#whatsappFab{
  position:fixed;inset-inline-end:1rem;inset-block-end:1rem;z-index:50;
  width:3rem;height:3rem;border-radius:999px;background:#25D366;
  display:flex;align-items:center;justify-content:center;
  box-shadow:0 8px 20px rgba(0,0,0,.25);
}
#whatsappFab img{width:1.9rem;height:1.9rem}

/* ===== Tabs ===== */
nav.top-tabs{max-width:80rem;margin:auto}
.top-tabs .btn{border-radius:1.25rem;padding:.55rem 1rem;font-weight:600}
.tab-active{background:#e6edf6;color:#0b1423}
.tab-inactive{background:transparent;color:#e6edf6;border:1px solid #2b3851}

/* ===== ØªÙ†Ø³ÙŠÙ‚ Ø¹Ø§Ù… ===== */
.card{border-radius:.75rem;box-shadow:0 4px 12px rgba(0,0,0,.1)}
.btn{padding:.4rem .75rem;border-radius:.6rem;font-weight:600}
.btn-nav{background:#e2e8f0;color:#0b1423;border:1px solid #cbd5e1}
.btn-tv{background:var(--gold);color:#1f2937}
.btn-danger{background:#ef4444;color:#fff}
.btn-ghost{border:1px solid rgba(0,0,0,.2)}
.btn-contrast{background:#f1f5f9;color:#0f172a;border:1px solid #cbd5e1}

/* ===== Ø§Ù„Ù…ØµØ­Ù ===== */
.quran-controls{
  display:flex;flex-wrap:wrap;align-items:center;gap:.4rem;
  padding:.4rem .6rem;
  border-radius:8px;background:#e6edf6;color:#0b1423;
}
.quran-controls select{
  padding:.35rem .55rem;border-radius:8px;border:1px solid #cbd5e1;
  background:#fff;color:#0b1423;
}
.quran-controls .btn{font-size:.85rem;padding:.35rem .6rem;border-radius:.5rem}
.quran-stage{
  background:#0b1423;border-radius:10px;
  padding:.4rem;
}
#imageWrapper{
  width:100%;
  height:calc(100vh - 165px);
  overflow:auto;
  display:flex;align-items:center;justify-content:center;
  background:#fff;
  border-radius:8px;
  scroll-behavior:smooth;
  touch-action:pan-y;
}
#quranPage{
  display:block;
  max-width:100%;
  max-height:100%;
  height:auto;
  margin:auto;
  border-radius:6px;
  user-select:none;
  -webkit-user-drag:none;
  box-shadow:0 2px 10px rgba(0,0,0,.15);
}
#imageWrapper:fullscreen img{
  width:auto!important;height:100vh!important;object-fit:contain;
}

/* ===== Ø§Ù„ØµÙˆØª ===== */
.sleep-row input{
  width:4.5rem;padding:.3rem;border-radius:.5rem;border:1px solid #cbd5e1;background:#fff;color:#0b1423;
}

/* ===== Ù…ÙˆØ¨Ø§ÙŠÙ„ ===== */
@media (max-width:640px){
  .quran-controls{gap:.3rem;padding:.3rem .5rem}
  #imageWrapper{height:calc(100dvh - 140px)}
  #whatsappFab{inset-inline-end:.75rem;inset-block-end:.75rem}
}
</style>
</head>

<body class="theme-day min-h-screen">
<header id="appHeader" class="sticky top-0 z-10 border-b border-[#2b3851] flex items-center justify-between gap-3 backdrop-blur-md">
  <div class="flex items-center gap-2">
    <button id="themeToggle"><span id="themeIcon">ğŸŒ</span></button>
    <h1 class="font-bold text-base sm:text-lg">ğŸ“– Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ… â€“ <span class="font-normal">ØµØ¯Ù‚Ø© Ø¬Ø§Ø±ÙŠØ©</span></h1>
  </div>
  <div class="clock-box">
    <div id="hijriLine">â€”</div>
    <div id="gregLine">â€”</div>
  </div>
</header>

<a id="whatsappFab" href="https://wa.me/905533331339" target="_blank"><img src="https://i.imgur.com/XC8wuji.png" alt="WhatsApp"></a>

<nav class="top-tabs p-4 flex gap-2">
  <button id="tabAudio" class="btn tab-inactive">Ø§Ù„ØµÙˆØª ğŸ”Š</button>
  <button id="tabImages" class="btn tab-active">Ø§Ù„Ù…ØµØ­Ù Ø§Ù„Ù…ØµÙˆÙ‘Ø± ğŸ–¼ï¸</button>
</nav>

<main class="space-y-6">

<section id="imagesSection" class="space-y-3">
  <div class="card p-3">
    <h2 class="font-semibold mb-2">ğŸ“– Ø§Ù„Ù…ØµØ­Ù Ø§Ù„Ù…ØµÙˆÙ‘Ø±</h2>

    <!-- Ø´Ø±ÙŠØ· Ø£Ø¯ÙˆØ§Øª ØµØºÙŠØ± -->
    <div class="quran-controls">
      <label class="opacity-80 text-sm">Ø§Ù„Ø³ÙˆØ±Ø©:</label>
      <select id="surahImageSelect" class="text-black"></select>
      <button id="prevPage" class="btn btn-nav">â¬…ï¸ Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
      <div class="flex items-center gap-1">
        <input id="pageNum" type="number" min="1" max="604" value="1" class="w-20 p-1 rounded border text-black bg-white">
        <span>/ 604</span>
      </div>
      <button id="nextPage" class="btn btn-nav">Ø§Ù„ØªØ§Ù„ÙŠ â¡ï¸</button>
      <button id="fullscreenBtn" class="btn btn-tv">ğŸ“º</button>
    </div>

    <!-- Ø§Ù„Ù…Ø³Ø±Ø­ -->
    <div class="quran-stage">
      <div id="imageWrapper">
        <img id="quranPage"
             src="https://easyquran.com/wp-content/uploads/2022/09/1-scaled.jpg"
             alt="ØµÙØ­Ø© Ø§Ù„Ù…ØµØ­Ù" loading="lazy">
      </div>
    </div>
  </div>
</section>

<section id="audioSection" class="hidden space-y-4">
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    <div class="card p-4">
      <h2 class="mb-2 font-semibold">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø³ÙˆØ±Ø©</h2>
      <select id="surahSelect" class="w-full p-2 rounded border text-black"></select>
    </div>
    <div class="card p-4">
      <h2 class="mb-2 font-semibold">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù‚Ø§Ø±Ø¦</h2>
      <select id="reciterSelect" class="w-full p-2 rounded border text-black"></select>
    </div>
  </div>

  <div class="card p-4">
    <h2 class="font-semibold mb-2">ÙˆØ¶Ø¹ Ø§Ù„ØªØ´ØºÙŠÙ„</h2>
    <div class="flex flex-wrap items-center gap-4 text-sm">
      <label><input type="radio" name="mode" value="single" checked> Ù‚Ø§Ø±Ø¦ ÙˆØ§Ø­Ø¯</label>
      <label><input type="radio" name="mode" value="multi"> Ø¹Ø¯Ø© Ù‚Ø±Ø§Ø¡</label>
      <label><input type="checkbox" id="loopToggle"> ØªÙƒØ±Ø§Ø± Ø§Ù„Ø³ÙˆØ±Ø©</label>
    </div>
    <div class="mt-3 flex flex-wrap gap-2 items-center text-sm sleep-row">
      <label>â±ï¸ Ù…Ø¤Ù‚Ù‘Øª Ø§Ù„Ù†ÙˆÙ…</label>
      <input id="sleepMinutes" type="number" min="0" step="1" placeholder="Ø¯Ù‚Ø§Ø¦Ù‚">
      <button id="sleepSet" class="px-3 py-1 bg-slate-600 text-white rounded">ØªÙØ¹ÙŠÙ„</button>
      <button id="sleepCancel" class="px-3 py-1 bg-red-500 text-white rounded">Ø¥Ù„ØºØ§Ø¡</button>
      <span id="sleepStatus" class="text-sm"></span>
    </div>
  </div>

  <div class="flex gap-3">
    <button id="addBtn" class="flex-1 btn btn-gold">â• Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù…Ø´ØºÙ„</button>
    <button id="favBtn" class="flex-1 btn btn-ghost">â­ Ù…ÙØ¶Ù„Ø©</button>
  </div>

  <div class="card p-4">
    <h2 class="font-semibold mb-2 flex items-center justify-between">
      <span>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ´ØºÙŠÙ„</span>
      <button id="clearBtn" class="btn btn-danger text-sm">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>
    </h2>
    <ul id="playlist" class="space-y-2"></ul>
  </div>

  <div class="card p-4">
    <h2 class="font-semibold mb-2">Ø§Ù„Ù…Ø´ØºÙ‘Ù„</h2>
    <div id="playerBox"></div>
    <div id="progressBar" class="mt-2 bg-gray-200 rounded-full h-2">
      <div id="progressFill" class="h-2 bg-emerald-500 rounded-full w-0"></div>
    </div>
    <div class="flex items-center justify-center gap-2 mt-2">
      <button id="back10" class="btn btn-contrast">âª 10Ø«</button>
      <button id="playPause" class="btn btn-contrast">â¯ï¸ ØªØ´ØºÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù</button>
      <button id="fwd10" class="btn btn-contrast">â© 10Ø«</button>
    </div>
    <div class="text-center mt-1 text-sm">
      <span id="timeNow">00:00</span> / <span id="timeTotal">00:00</span>
    </div>
  </div>

  <div class="card p-4">
    <h2 class="font-semibold mb-2 flex items-center justify-between">
      <span>â­ Ø§Ù„Ù…ÙØ¶Ù„Ø©</span>
      <button id="clearFavBtn" class="btn btn-danger text-sm">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>
    </h2>
    <ul id="favorites" class="space-y-2"></ul>
  </div>
</section>

<!-- Ø¯ÙØ¹Ø© JS Ø¨Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© -->
<script>
/* ========== Ø£Ø¯ÙˆØ§Øª Ù…Ø®ØªØµØ±Ø© ========== */
const $ = (id) => document.getElementById(id);
const pad3 = (n) => String(n).padStart(3,"0");

/* ========== Ø«ÙŠÙ…Ø§Øª ========== */
const THEMES=["day","night","special"]; let currentThemeIndex=0;
function applyTheme(t){
  document.body.classList.remove("theme-day","theme-night","theme-special");
  document.body.classList.add("theme-"+t);
  $("themeIcon").textContent = t==="day"?"ğŸŒ":t==="night"?"ğŸŒ™":"ğŸ’š";
  localStorage.setItem("theme_choice",t);
}
function initTheme(){
  const saved=localStorage.getItem("theme_choice");
  if(saved && THEMES.includes(saved)){ applyTheme(saved); currentThemeIndex=THEMES.indexOf(saved); }
  else{ applyTheme("day"); currentThemeIndex=0; }
}
$("themeToggle").onclick=()=>{ currentThemeIndex=(currentThemeIndex+1)%THEMES.length; applyTheme(THEMES[currentThemeIndex]); };

/* ========== Ø§Ù„ØªØ§Ø±ÙŠØ®/Ø§Ù„ÙˆÙ‚Øª (24h) ========== */
async function updateClock(){
  const d=new Date();
  const gDate=`${String(d.getDate()).padStart(2,"0")}-${String(d.getMonth()+1).padStart(2,"0")}-${d.getFullYear()}`;
  const time=`${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;
  try{
    const r=await fetch(`https://api.aladhan.com/v1/gToH?date=${gDate}`);
    const j=await r.json();
    $("hijriLine").textContent = `${j.data.hijri.day} ${j.data.hijri.month.ar} ${j.data.hijri.year} Ù‡Ù€`;
    $("gregLine").textContent = `${gDate} | ${time}`;
  }catch{
    $("hijriLine").textContent="â€”";
    $("gregLine").textContent=`${gDate} | ${time}`;
  }
}
setInterval(updateClock, 60000);

/* ========== ØªØ¨ÙˆÙŠØ¨Ø§Øª ========== */
function setTab(tab){
  if(tab==="audio"){
    $("tabAudio").classList.add("tab-active"); $("tabAudio").classList.remove("tab-inactive");
    $("tabImages").classList.add("tab-inactive"); $("tabImages").classList.remove("tab-active");
    $("audioSection").classList.remove("hidden"); $("imagesSection").classList.add("hidden");
  }else{
    $("tabImages").classList.add("tab-active"); $("tabImages").classList.remove("tab-inactive");
    $("tabAudio").classList.add("tab-inactive"); $("tabAudio").classList.remove("tab-active");
    $("imagesSection").classList.remove("hidden"); $("audioSection").classList.add("hidden");
  }
}
$("tabAudio").onclick=()=>setTab("audio");
$("tabImages").onclick=()=>setTab("images");

/* ========== Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: Ø§Ù„Ø³ÙˆØ± ÙˆØ§Ù„Ù‚Ø±Ø§Ø¡ ========== */
const RECITERS=[
  {slug:"maher", name:"Ø§Ù„Ø´ÙŠØ® Ù…Ø§Ù‡Ø± Ø§Ù„Ù…Ø¹ÙŠÙ‚Ù„ÙŠ", base:"https://server12.mp3quran.net/maher"},
  {slug:"ajm",   name:"Ø§Ù„Ø´ÙŠØ® Ø£Ø­Ù…Ø¯ Ø¨Ù† Ø¹Ù„ÙŠ Ø§Ù„Ø¹Ø¬Ù…ÙŠ", base:"https://server10.mp3quran.net/ajm"},
  {slug:"afs",   name:"Ø§Ù„Ø´ÙŠØ® Ù…Ø´Ø§Ø±ÙŠ Ø¨Ù† Ø±Ø§Ø´Ø¯ Ø§Ù„Ø¹ÙØ§Ø³ÙŠ", base:"https://server8.mp3quran.net/afs"},
  {slug:"sds",   name:"Ø§Ù„Ø´ÙŠØ® Ø¹Ø¨Ø¯Ø§Ù„Ø±Ø­Ù…Ù† Ø§Ù„Ø³Ø¯ÙŠØ³", base:"https://server11.mp3quran.net/sds"},
  {slug:"shur",  name:"Ø§Ù„Ø´ÙŠØ® Ø³Ø¹ÙˆØ¯ Ø§Ù„Ø´Ø±ÙŠÙ…", base:"https://server7.mp3quran.net/shur"},
  {slug:"sgmd",  name:"Ø§Ù„Ø´ÙŠØ® Ø³Ø¹Ø¯ Ø§Ù„ØºØ§Ù…Ø¯ÙŠ", base:"https://server7.mp3quran.net/s_gmd"},
  {slug:"minsh", name:"Ø§Ù„Ø´ÙŠØ® Ù…Ø­Ù…Ø¯ ØµØ¯ÙŠÙ‚ Ø§Ù„Ù…Ù†Ø´Ø§ÙˆÙŠ", base:"https://server10.mp3quran.net/minsh"},
  {slug:"husr",  name:"Ø§Ù„Ø´ÙŠØ® Ù…Ø­Ù…ÙˆØ¯ Ø®Ù„ÙŠÙ„ Ø§Ù„Ø­ØµØ±ÙŠ", base:"https://server13.mp3quran.net/husr"},
  {slug:"basit_mj", name:"Ø§Ù„Ø´ÙŠØ® Ø¹Ø¨Ø¯Ø§Ù„Ø¨Ø§Ø³Ø· Ø¹Ø¨Ø¯Ø§Ù„ØµÙ…Ø¯ (Ø§Ù„Ù…Ø¬ÙˆÙ‘Ø¯)", base:"https://server7.mp3quran.net/basit/Almusshaf-Al-Mojawwad"},
  {slug:"shatri", name:"Ø§Ù„Ø´ÙŠØ® Ø£Ø¨Ùˆ Ø¨ÙƒØ± Ø§Ù„Ø´Ø§Ø·Ø±ÙŠ", base:"https://server11.mp3quran.net/shatri"},
];
let chapters=[];
async function fetchChapters(){
  try{
    const res=await fetch("https://api.quran.com/api/v4/chapters");
    const data=await res.json();
    chapters=data.chapters||[];
  }catch{
    chapters=[...Array(114)].map((_,i)=>({id:i+1,name_arabic:`Ø³ÙˆØ±Ø© ${i+1}`}));
  }
  $("surahSelect").innerHTML = chapters.map(c=>`<option value="${c.id}">${c.id}. ${c.name_arabic}</option>`).join("");
  $("reciterSelect").innerHTML = RECITERS.map(r=>`<option value="${r.slug}">${r.name}</option>`).join("");
  $("surahImageSelect").innerHTML = `<option value="0">ğŸ“– ÙƒØ§Ù…Ù„ Ø§Ù„Ù‚Ø±Ø¢Ù†</option>` + chapters.map(c=>`<option value="${c.id}">${c.id}. ${c.name_arabic}</option>`).join("");
}

/* ========== Ø§Ù„ØµÙˆØªÙŠØ§Øª ========== */
const state={
  playlist:[],
  favorites:[],
  idx:0,
  mode:"single",
  loop:false,
  resume:{},
  sleepTimeout:null,
  sleepTicker:null,
  sleepEndTs:null
};
function formatTime(s){ if(!s||!isFinite(s)) return "00:00"; const m=Math.floor(s/60),sec=Math.floor(s%60); return `${String(m).padStart(2,"0")}:${String(sec).padStart(2,"0")}`; }

function persist(){
  localStorage.setItem("playlist", JSON.stringify(state.playlist));
  localStorage.setItem("favorites", JSON.stringify(state.favorites));
  localStorage.setItem("resume", JSON.stringify(state.resume));
}

function attachAudioEvents(a, src){
  a.loop = state.loop;
  a.onloadedmetadata = ()=>{
    $("timeTotal").textContent = formatTime(a.duration);
    if(state.resume[src]) a.currentTime = state.resume[src];
  };
  a.ontimeupdate = ()=>{
    if(!isFinite(a.duration)) return;
    $("progressFill").style.width = (a.currentTime/a.duration*100)+"%";
    $("timeNow").textContent = formatTime(a.currentTime);
    state.resume[src] = a.currentTime; localStorage.setItem("resume", JSON.stringify(state.resume));
  };
  a.onended = ()=>{
    if(state.loop){ a.currentTime=0; a.play(); }
    else if(state.idx+1 < state.playlist.length){ state.idx++; render(true); }
  };
}

function render(auto=false){
  const cur = state.playlist[state.idx];
  if(cur){
    $("playerBox").innerHTML =
      `<div class="mb-2 font-medium">${cur.title} â€” <span class="text-emerald-400">${cur.reciter}</span></div>`+
      `<audio id="player" src="${cur.src}" controls ${auto?'autoplay':''}></audio>`;
    const a=$("player"); if(a) attachAudioEvents(a, cur.src);
  } else {
    $("playerBox").innerHTML = `<div class="text-slate-400">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ´ØºÙŠÙ„</div>`;
  }
  $("playlist").innerHTML = state.playlist.map((t,i)=>`
    <li class="flex justify-between items-center bg-white/60 rounded px-3 py-2">
      <span>${t.title} - ${t.reciter}</span>
      <span class="flex gap-2">
        <button onclick="playAt(${i})" title="ØªØ´ØºÙŠÙ„">â–¶ï¸</button>
        <button onclick="favFromIdx(${i})" title="Ø£Ø¶Ù Ù„Ù„Ù…ÙØ¶Ù„Ø©">â­</button>
        <button onclick="delAt(${i})" class="text-red-500" title="Ø­Ø°Ù">ğŸ—‘ï¸</button>
      </span>
    </li>`).join("");
  renderFav();
  persist();
}

function addToPlaylist(auto=false){
  const recSlug = $("reciterSelect").value;
  const rec = RECITERS.find(r=>r.slug===recSlug);
  const surId = parseInt($("surahSelect").value);
  if(!rec || !surId) return alert("Ø§Ø®ØªØ± Ø§Ù„Ø³ÙˆØ±Ø© ÙˆØ§Ù„Ù‚Ø§Ø±Ø¦ Ø£ÙˆÙ„Ø§Ù‹");
  if(state.mode==="single" && state.playlist.length>0 && state.playlist[0].reciter!==rec.name){
    return alert("ÙˆØ¶Ø¹ Ù‚Ø§Ø±Ø¦ ÙˆØ§Ø­Ø¯: Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø®Ù„Ø· Ø§Ù„Ù‚Ø±Ø§Ø¡.");
  }
  const sur=chapters.find(c=>c.id===surId) || {name_arabic:`Ø³ÙˆØ±Ø© ${surId}`};
  const item={title:sur.name_arabic, reciter:rec.name, src:`${rec.base}/${pad3(surId)}.mp3`};
  state.playlist.push(item);
  state.idx = state.playlist.length-1;
  render(auto); // âœ… ØªØ­Ø¯ÙŠØ« ÙÙˆØ±ÙŠ
}
function playAt(i){ state.idx=i; render(true); }
function delAt(i){ state.playlist.splice(i,1); if(state.idx>=state.playlist.length) state.idx=Math.max(0,state.playlist.length-1); render(false); }
function favFromIdx(i){ const it=state.playlist[i]; if(!it) return; if(!state.favorites.some(f=>f.src===it.src && f.reciter===it.reciter)){ state.favorites.push(it); persist(); renderFav(); } }
function renderFav(){
  $("favorites").innerHTML = state.favorites.map((f,i)=>`
    <li class="flex justify-between items-center px-3 py-2 bg-white/60 rounded">
      <span>${f.title} - ${f.reciter}</span>
      <span class="flex gap-2">
        <button onclick="playFav(${i})" title="ØªØ´ØºÙŠÙ„">â–¶ï¸</button>
        <button onclick="delFav(${i})" class="text-red-500" title="Ø­Ø°Ù">ğŸ—‘ï¸</button>
      </span>
    </li>`).join("");
}
function playFav(i){
  const it = state.favorites[i]; if(!it) return;
  if(state.mode==="single" && state.playlist.length>0 && state.playlist[0].reciter!==it.reciter){
    return alert("ÙˆØ¶Ø¹ Ù‚Ø§Ø±Ø¦ ÙˆØ§Ø­Ø¯: Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø®Ù„Ø· Ø§Ù„Ù‚Ø±Ø§Ø¡.");
  }
  state.playlist.push(it); state.idx=state.playlist.length-1; render(true);
}
function delFav(i){ state.favorites.splice(i,1); persist(); renderFav(); }

/* Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ù…Ø´ØºÙ‘Ù„ */
$("addBtn").onclick = ()=>addToPlaylist(true);
$("favBtn").onclick = ()=>{ const cur=state.playlist[state.idx]; if(cur && !state.favorites.some(f=>f.src===cur.src && f.reciter===cur.reciter)){ state.favorites.push(cur); persist(); renderFav(); } };
$("clearBtn").onclick = ()=>{ if(confirm("Ù…Ø³Ø­ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ØŸ")){ state.playlist=[]; state.idx=0; render(false); } };
$("clearFavBtn").onclick = ()=>{ if(confirm("Ù…Ø³Ø­ Ø§Ù„Ù…ÙØ¶Ù„Ø©ØŸ")){ state.favorites=[]; persist(); renderFav(); } };
$("playPause").onclick = ()=>{ const a=$("player"); if(a) a.paused?a.play():a.pause(); };
$("back10").onclick  = ()=>{ const a=$("player"); if(a) a.currentTime=Math.max(0,a.currentTime-10); };
$("fwd10").onclick   = ()=>{ const a=$("player"); if(a) a.currentTime=Math.min(a.duration||a.currentTime+10,a.currentTime+10); };
$("loopToggle").onchange = (e)=>{ state.loop=e.target.checked; const a=$("player"); if(a) a.loop=state.loop; };

/* ========== Ù…Ø¤Ù‚Ù‘Øª Ø§Ù„Ù†ÙˆÙ… (Ø¹Ø¯Ù‘ ØªÙ†Ø§Ø²Ù„ÙŠ ÙŠØ¸Ù‡Ø± Ø¨Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ) ========== */
$("sleepSet").onclick = ()=>{
  const min = parseInt($("sleepMinutes").value)||0;
  const totalMs = min*60000;
  if(totalMs<=0) return alert("Ø£Ø¯Ø®Ù„ Ù…Ø¯Ø© ØµØ­ÙŠØ­Ø© Ø¨Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚");

  // Ø£Ù„ØºÙ Ø§Ù„Ù‚Ø¯ÙŠÙ…
  if(state.sleepTimeout) clearTimeout(state.sleepTimeout);
  if(state.sleepTicker)  clearInterval(state.sleepTicker);

  const a = $("player");
  const end = Date.now() + totalMs;
  state.sleepEndTs = end;

  // Ø¹Ø¯Ù‘ ØªÙ†Ø§Ø²Ù„ÙŠ ÙƒÙ„ Ø«Ø§Ù†ÙŠØ©
  state.sleepTicker = setInterval(()=>{
    const remain = Math.max(0, end - Date.now());
    const secs = Math.ceil(remain/1000);
    const mm = Math.floor(secs/60), ss = secs%60;
    $("sleepStatus").textContent = `Ø³ÙŠØªÙ… Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù Ø¨Ø¹Ø¯ ${String(mm).padStart(2,"0")}:${String(ss).padStart(2,"0")}`;
    if(remain<=0){ clearInterval(state.sleepTicker); state.sleepTicker=null; }
  },1000);

  // Ø¥ÙŠÙ‚Ø§Ù Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‡Ø§ÙŠØ©
  state.sleepTimeout = setTimeout(()=>{
    if(a) a.pause();
    $("sleepStatus").textContent = "â¹ï¸ ØªÙ… Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹";
  }, totalMs);
};

$("sleepCancel").onclick = ()=>{
  if(state.sleepTimeout) clearTimeout(state.sleepTimeout);
  if(state.sleepTicker)  clearInterval(state.sleepTicker);
  state.sleepTimeout=null; state.sleepTicker=null; state.sleepEndTs=null;
  $("sleepStatus").textContent = "ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡";
};

/* ========== Ø§Ù„Ù…ØµØ­Ù Ø§Ù„Ù…ØµÙˆÙ‘Ø± ========== */
const TOTAL_PAGES=604;
const BASE="https://easyquran.com/wp-content/uploads/2022/09/";
const SURAH_PAGES={1:1,2:2,3:50,4:77,5:106,6:128,7:151,8:177,9:187,10:208,11:221,12:235,13:249,14:255,15:262,16:267,17:282,18:293,19:305,20:312,21:322,22:332,23:342,24:350,25:359,26:367,27:377,28:385,29:396,30:404,31:411,32:415,33:418,34:428,35:434,36:440,37:446,38:453,39:458,40:467,41:477,42:483,43:489,44:496,45:499,46:502,47:507,48:511,49:515,50:518,51:520,52:523,53:526,54:528,55:531,56:534,57:537,58:542,59:545,60:549,61:551,62:553,63:554,64:556,65:558,66:560,67:562,68:564,69:566,70:568,71:570,72:572,73:574,74:575,75:577,76:578,77:580,78:582,79:583,80:585,81:586,82:587,83:589,84:590,85:591,86:592,87:593,88:594,89:595,90:596,91:597,92:598,93:599,94:599,95:600,96:600,97:601,98:601,99:602,100:602,101:603,102:603,103:603,104:604,105:604,106:604,107:604,108:604,109:604,110:604,111:604,112:604,113:604,114:604};

const imgEl = $("quranPage");
const pageInput = $("pageNum");
const wrapper = $("imageWrapper");

function buildUrl(p){ return `${BASE}${p}-scaled.jpg`; }
function clampPage(p){ return Math.max(1, Math.min(TOTAL_PAGES, p|0)); }
function loadPage(n){
  const p = clampPage(parseInt(n)||1);
  pageInput.value = p;
  imgEl.src = buildUrl(p);
}

/* Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙ†Ù‚Ù„ */
$("nextPage").onclick = ()=> loadPage(+pageInput.value + 1);
$("prevPage").onclick = ()=> loadPage(+pageInput.value - 1);
pageInput.onchange = ()=> loadPage(pageInput.value);

/* Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø§Ù„ÙÙˆØ±ÙŠ Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø³ÙˆØ±Ø© */
$("surahImageSelect").onchange = (e)=>{
  const id = parseInt(e.target.value);
  if(id===0) loadPage(1);
  else if(SURAH_PAGES[id]) loadPage(SURAH_PAGES[id]);
};

/* Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„ÙŠØ¯ÙˆÙŠ (ØªØµØ­ÙŠØ­ Ø§Ù„Ø§ØªØ¬Ø§Ù‡): ÙŠÙ…ÙŠÙ† = Ø§Ù„ØªØ§Ù„ÙŠ / ÙŠØ³Ø§Ø± = Ø§Ù„Ø³Ø§Ø¨Ù‚ */
let touchStartX=0;
imgEl.addEventListener("touchstart",(e)=>{ touchStartX = e.changedTouches[0].screenX; }, {passive:true});
imgEl.addEventListener("touchend",(e)=>{
  const dx = e.changedTouches[0].screenX - touchStartX;
  if(Math.abs(dx) > 100){
    if(dx > 0) loadPage(+pageInput.value + 1);  // ğŸ‘‰ ÙŠÙ…ÙŠÙ† = Ø§Ù„ØªØ§Ù„ÙŠ
    else       loadPage(+pageInput.value - 1);  // ğŸ‘ˆ ÙŠØ³Ø§Ø± = Ø§Ù„Ø³Ø§Ø¨Ù‚
  }
},{passive:true});

/* Ø³Ø­Ø¨ Ø¨Ø§Ù„Ù…Ø§ÙˆØ³ (pan) Ø¯Ø§Ø®Ù„ Ø§Ù„Ø­Ø§ÙˆÙŠØ© */
let isPanning=false, startX=0, startScrollLeft=0;
wrapper.addEventListener("pointerdown",(e)=>{ isPanning=true; startX=e.clientX; startScrollLeft=wrapper.scrollLeft; wrapper.setPointerCapture(e.pointerId); });
wrapper.addEventListener("pointermove",(e)=>{ if(!isPanning) return; wrapper.scrollLeft = startScrollLeft - (e.clientX - startX); });
wrapper.addEventListener("pointerup",()=>{ isPanning=false; });
wrapper.addEventListener("pointercancel",()=>{ isPanning=false; });

/* Ø¹Ø¬Ù„Ø© Ø§Ù„Ù…Ø§ÙˆØ³: Ù„Ù„Ø£Ø³ÙÙ„ = Ø§Ù„ØªØ§Ù„ÙŠ / Ù„Ù„Ø£Ø¹Ù„Ù‰ = Ø§Ù„Ø³Ø§Ø¨Ù‚ */
wrapper.addEventListener("wheel",(e)=>{
  if(e.deltaY>0) loadPage(+pageInput.value + 1);
  else if(e.deltaY<0) loadPage(+pageInput.value - 1);
});

/* Ø§Ù„Ø£Ø³Ù‡Ù… ØªØ¹Ù…Ù„ ÙÙŠ ÙˆØ¶Ø¹ Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø© ÙÙ‚Ø· */
document.addEventListener("keydown",(e)=>{
  if(document.fullscreenElement){
    if(e.key==="ArrowRight") loadPage(+pageInput.value + 1);
    if(e.key==="ArrowLeft")  loadPage(+pageInput.value - 1);
  }
});

/* Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø© */
$("fullscreenBtn").onclick = ()=>{
  if(wrapper.requestFullscreen) wrapper.requestFullscreen();
  else if(wrapper.webkitRequestFullscreen) wrapper.webkitRequestFullscreen();
};

/* ========== Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„ ========== */
window.addEventListener("DOMContentLoaded", ()=>{
  initTheme();
  updateClock();
  fetchChapters();

  // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø­Ø§Ù„Ø§Øª
  try{
    state.playlist = JSON.parse(localStorage.getItem("playlist")||"[]");
    state.favorites= JSON.parse(localStorage.getItem("favorites")||"[]");
    state.resume   = JSON.parse(localStorage.getItem("resume")||"{}");
  }catch{}
  render(false);
  loadPage(1);

  // Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§ Ø§ÙØªØ­ Ø§Ù„Ù…ØµØ­Ù (Ø­Ø³Ø¨ Ø·Ù„Ø¨Ùƒ)
  setTab("images");
});
</script>
