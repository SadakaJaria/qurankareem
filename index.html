<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>📖 القرآن الكريم – صدقة جارية</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
:root{--gold:#d4af37;}
body{font-family:"Noto Naskh Arabic UI","Segoe UI",system-ui,sans-serif;transition:background .4s,color .4s}
.card{border-radius:.75rem;box-shadow:0 4px 12px rgba(0,0,0,.12)}
#progressBar{width:100%;height:6px;background:#e5e7eb;border-radius:999px;cursor:pointer}
#progressFill{height:100%;width:0;background:#10b981;border-radius:999px}
.btn{padding:.4rem .8rem;border-radius:.65rem;font-weight:600}
.btn-small{padding:.3rem .6rem;font-size:.75rem;border-radius:.5rem}
.btn-gold{background:var(--gold);color:#1f2937}.btn-gold:hover{filter:brightness(1.05)}
.btn-danger{background:#ef4444;color:#fff}.btn-danger:hover{background:#dc2626}
.btn-ghost{background:transparent;border:1px solid rgba(0,0,0,.15)}
.clock-box{text-align:center;line-height:1.4}
.clock-box .time{font-size:1.25rem;font-weight:600}

/* Themes */
.theme-day{background:#f8fafc;color:#0f172a}
.theme-day .card{background:#fff;color:#0f172a}
.theme-night{background:#111827;color:#f1f5f9}
.theme-night .card{background:#1f2937;color:#f1f5f9}
.theme-special{background:#0b3a2b;color:#fff}
.theme-special .card{background:#0f4a33;color:#fefce8;border:1px solid rgba(212,175,55,.25)}
.tab-active{background:#1f2937;color:#f1f5f9}
.tab-inactive{background:#eee;color:#1f2937}

/* 📖 المصحف المصور */
#imagesSection{background:#fff !important;color:#000 !important;border-radius:12px;padding:10px}
#imageWrapper{touch-action:none;overflow:hidden}
#quranPage{
  background:#fff;padding:10px;border-radius:8px;box-shadow:0 2px 12px rgba(0,0,0,.2);
  max-width:100%;height:auto;transform-origin:center center;transition:transform .2s ease
}

/* ✅ تحسين ملء الشاشة (دِسك/موبايل) */
#imageWrapper:fullscreen img{
  width:auto !important;height:100vh !important;max-width:100%;
  object-fit:contain !important;display:block;margin:auto
}
@media (max-width:768px){
  #imageWrapper:fullscreen img{width:100% !important;height:auto !important}
}
</style>
</head>

<body class="theme-day min-h-screen">
<header id="appHeader" class="sticky top-0 z-10 p-4 border-b border-slate-200 flex items-center justify-between gap-3 backdrop-blur-md">
  <div class="flex items-center gap-3">
    <button id="themeToggle" class="btn btn-gold text-sm">تبديل الوضع</button>
    <h1 class="text-lg font-bold">📖 القرآن الكريم – <span class="font-normal">صدقة جارية</span></h1>
  </div>
  <div class="flex flex-col items-end gap-1">
    <div id="clockBox" class="clock-box text-sm"></div>
    <a href="https://wa.me/905533331339" target="_blank" class="btn-small btn-gold">التواصل عبر الواتس اب</a>
  </div>
</header>

<!-- Tabs -->
<nav class="max-w-4xl mx-auto p-4 flex gap-2">
  <button id="tabAudio" class="btn tab-active">🔊 الصوت</button>
  <button id="tabImages" class="btn tab-inactive">🖼️ المصحف المصوَّر</button>
</nav>

<main class="max-w-4xl mx-auto p-4 space-y-6">

<!-- AUDIO SECTION -->
<section id="audioSection" class="space-y-4">
  <section class="grid grid-cols-1 md:grid-cols-2 gap-4">
    <div class="card p-4">
      <h2 class="mb-2 font-semibold">اختيار السورة</h2>
      <select id="surahSelect" class="w-full p-2 rounded border text-black"></select>
    </div>
    <div class="card p-4">
      <h2 class="mb-2 font-semibold">اختيار القارئ</h2>
      <select id="reciterSelect" class="w-full p-2 rounded border text-black"></select>
    </div>
  </section>

  <section class="card p-4">
    <h2 class="font-semibold mb-2">وضع التشغيل</h2>
    <label class="mr-4"><input type="radio" name="mode" value="single" checked> قارئ واحد</label>
    <label><input type="radio" name="mode" value="multi"> عدة قراء</label>
    <label class="ml-4"><input type="checkbox" id="loopToggle"> تكرار السورة</label>
    <div class="mt-2 flex flex-wrap gap-2 items-center text-sm">
      <label for="sleepMinutes">⏱️ مؤقّت النوم</label>
      <input id="sleepMinutes" type="number" min="1" step="1" placeholder="دقائق" class="w-20 p-1 border rounded text-black">
      <button id="sleepSet" class="px-3 py-1 bg-slate-600 text-white rounded">تفعيل</button>
      <button id="sleepCancel" class="px-3 py-1 bg-red-500 text-white rounded">إلغاء</button>
      <span id="sleepStatus" class="text-sm"></span>
    </div>
  </section>

  <section class="flex gap-3">
    <button id="addBtn" class="flex-1 btn btn-gold">➕ إضافة للمشغل</button>
    <button id="favBtn" class="flex-1 btn btn-ghost">⭐ مفضلة</button>
  </section>

  <section class="card p-4">
    <h2 class="font-semibold mb-2 flex items-center justify-between">
      <span>قائمة التشغيل</span>
      <button id="clearBtn" class="btn btn-danger text-sm">🗑️ مسح الكل</button>
    </h2>
    <ul id="playlist" class="space-y-2"></ul>
  </section>

  <section class="card p-4">
    <h2 class="font-semibold mb-2">المشغّل</h2>
    <div id="playerBox"></div>
    <div id="progressBar" class="mt-2"><div id="progressFill"></div></div>
    <div class="flex items-center justify-center gap-2 mt-2">
      <button id="back10" class="btn">⏪ 10ث</button>
      <button id="playPause" class="btn">⏯️ تشغيل/إيقاف</button>
      <button id="fwd10" class="btn">⏩ 10ث</button>
    </div>
    <div class="text-center mt-1 text-sm">
      <span id="timeNow">00:00</span> / <span id="timeTotal">00:00</span>
    </div>
  </section>

  <section class="card p-4">
    <h2 class="font-semibold mb-2 flex items-center justify-between">
      <span>⭐ المفضلة</span>
      <button id="clearFavBtn" class="btn btn-danger text-sm">🗑️ مسح الكل</button>
    </h2>
    <ul id="favorites" class="space-y-2"></ul>
  </section>
</section>

<!-- IMAGES SECTION -->
<section id="imagesSection" class="space-y-4 hidden">
  <div class="card p-4">
    <h2 class="font-semibold mb-2">📖 المصحف بالصور</h2>

    <div class="mb-3">
      <label class="block mb-1 font-medium">اختيار السورة</label>
      <select id="surahImageSelect" class="w-full p-2 rounded border text-black"></select>
    </div>

    <div class="flex gap-3 mb-2 items-center">
      <button id="prevPage" class="btn">➡ السابق</button>
      <input id="pageNum" type="number" min="1" max="604" value="1" class="w-20 p-1 border rounded text-black">
      <span>/ 604</span>
      <button id="nextPage" class="btn">التالي ⬅</button>
    </div>

    <div class="flex justify-center" id="imageWrapper">
      <img id="quranPage"
           src="https://easyquran.com/wp-content/uploads/2022/09/1-scaled.jpg"
           alt="صفحة المصحف"
           class="rounded shadow-lg"
           loading="lazy">
    </div>

    <div class="flex justify-center mt-3">
      <button id="fullscreenBtn" class="btn btn-gold">📺 ملء الشاشة</button>
    </div>
  </div>
</section>

<!-- الدفعة 2: سكربت الجافاسكربت الكامل سيأتي هنا -->
</main>
</body>
</html>
<script>
document.addEventListener("DOMContentLoaded",()=>{

// === بيانات القراء ===
const RECITERS=[
  {slug:"maher",name:"الشيخ ماهر المعيقلي",base:"https://server12.mp3quran.net/maher"},
  {slug:"ajm",name:"الشيخ أحمد العجمي",base:"https://server10.mp3quran.net/ajm"},
  {slug:"basit_mj",name:"الشيخ عبدالباسط (المجوّد)",base:"https://server7.mp3quran.net/basit/Almusshaf-Al-Mojawwad"},
  {slug:"afs",name:"الشيخ مشاري العفاسي",base:"https://server8.mp3quran.net/afs"},
  {slug:"sgmd",name:"الشيخ سعد الغامدي",base:"https://server7.mp3quran.net/s_gmd"},
  {slug:"husr",name:"الشيخ محمود الحصري",base:"https://server13.mp3quran.net/husr"},
  {slug:"shur",name:"الشيخ سعود الشريم",base:"https://server7.mp3quran.net/shur"},
  {slug:"shatri",name:"الشيخ أبو بكر الشاطري",base:"https://server11.mp3quran.net/shatri"},
  {slug:"minsh",name:"الشيخ محمد المنشاوي",base:"https://server10.mp3quran.net/minsh"},
  {slug:"sds",name:"الشيخ عبدالرحمن السديس",base:"https://server11.mp3quran.net/sds"}
];
const pad3=n=>String(n).padStart(3,"0");
let chapters=[];
const state={playlist:[],favorites:[],idx:0,mode:"single",loop:false,resume:{},sleepTimeout:null};

// === جلب السور من API ===
async function fetchChapters(){
  try{
    const res=await fetch("https://api.quran.com/api/v4/chapters");
    const data=await res.json();
    chapters=data.chapters||[];
  }catch{
    chapters=[...Array(114)].map((_,i)=>({id:i+1,name_arabic:`سورة ${i+1}`}));
  }
  document.getElementById("surahSelect").innerHTML=
    chapters.map(c=>`<option value="${c.id}">${c.id}. ${c.name_arabic}</option>`).join("");
  document.getElementById("reciterSelect").innerHTML=
    RECITERS.map(r=>`<option value="${r.slug}">${r.name}</option>`).join("");
  document.getElementById("surahImageSelect").innerHTML=
    `<option value="0">📖 كامل القرآن (604 صفحة)</option>`+
    chapters.map(c=>`<option value="${c.id}">${c.id}. ${c.name_arabic}</option>`).join("");
}

// === إعداد الساعة ===
async function updateClock(){
  const d=new Date();
  const g=`${String(d.getDate()).padStart(2,"0")}-${String(d.getMonth()+1).padStart(2,"0")}-${d.getFullYear()}`;
  const t=`${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;
  try{
    const r=await fetch(`https://api.aladhan.com/v1/gToH?date=${g}`);
    const j=await r.json();
    const hijri=j.data.hijri.date+" هـ";
    document.getElementById("clockBox").innerHTML=`<div>${hijri}</div><div>${g}</div><div class='time'>${t}</div>`;
  }catch{
    document.getElementById("clockBox").innerHTML=`<div>${g}</div><div class='time'>${t}</div>`;
  }
}
updateClock();setInterval(updateClock,60000);

// === الثيم ===
const THEMES=["day","night","special"];
let themeIndex=0;
function applyTheme(t){document.body.className=`theme-${t} min-h-screen`;localStorage.setItem("theme_choice",t);}
function initTheme(){const s=localStorage.getItem("theme_choice");if(s)applyTheme(s);else applyTheme("day");}
document.getElementById("themeToggle").onclick=()=>{themeIndex=(themeIndex+1)%THEMES.length;applyTheme(THEMES[themeIndex]);};

// === الصوت ===
function add(auto=false){
  const recSlug=document.getElementById("reciterSelect").value;
  const rec=RECITERS.find(r=>r.slug===recSlug);
  const surId=parseInt(document.getElementById("surahSelect").value);
  if(!rec||!surId)return alert("اختر السورة والقارئ أولاً");
  const sur=chapters.find(c=>c.id===surId)||{name_arabic:`سورة ${surId}`};
  const item={title:sur.name_arabic,reciter:rec.name,src:`${rec.base}/${pad3(surId)}.mp3`};
  if(state.mode==="single"&&state.playlist.length>0&&state.playlist[0].reciter!==rec.name)
    return alert("في وضع قارئ واحد فقط");
  state.playlist.push(item);state.idx=state.playlist.length-1;persist();render(auto);
}
function render(auto){
  const cur=state.playlist[state.idx];
  const box=document.getElementById("playerBox");
  if(cur){
    box.innerHTML=`<div class='mb-2 font-medium'>${cur.title} – <span class='text-emerald-400'>${cur.reciter}</span></div><audio id='player' src='${cur.src}' controls ${auto?'autoplay':''}></audio>`;
    const a=document.getElementById("player");
    a.onloadedmetadata=()=>document.getElementById("timeTotal").textContent=formatTime(a.duration);
    a.ontimeupdate=()=>updateProgress();
    a.onended=()=>{if(state.loop)a.play();else if(state.idx+1<state.playlist.length){state.idx++;render(true);}};
  }else box.innerHTML="<div class='text-slate-500'>لا يوجد تشغيل</div>";
  document.getElementById("playlist").innerHTML=state.playlist.map((t,i)=>`<li class='flex justify-between items-center'><span>${t.title} - ${t.reciter}</span><button onclick='playAt(${i})'>▶️</button></li>`).join("");
}
function playAt(i){state.idx=i;render(true);}
function formatTime(s){if(!s)return"00:00";const m=Math.floor(s/60),sec=Math.floor(s%60);return`${String(m).padStart(2,"0")}:${String(sec).padStart(2,"0")}`;}
function updateProgress(){const a=document.getElementById("player");if(a&&a.duration)document.getElementById("progressFill").style.width=(a.currentTime/a.duration*100)+"%";}
function skip(sec){const a=document.getElementById("player");if(a)a.currentTime+=sec;}
document.getElementById("back10").onclick=()=>skip(-10);
document.getElementById("fwd10").onclick=()=>skip(10);
document.getElementById("playPause").onclick=()=>{const a=document.getElementById("player");if(a)a.paused?a.play():a.pause();};

// === مفضلة + مؤقت + حذف ===
function persist(){localStorage.setItem("playlist",JSON.stringify(state.playlist));}
document.getElementById("addBtn").onclick=()=>add(true);
document.getElementById("clearBtn").onclick=()=>{if(confirm("مسح الكل؟")){state.playlist=[];state.idx=0;persist();render();}};

// === تبويبات (صوت / مصحف) ===
const tabAudio=document.getElementById("tabAudio");
const tabImages=document.getElementById("tabImages");
const audioSection=document.getElementById("audioSection");
const imagesSection=document.getElementById("imagesSection");
function setTab(tab){
  if(tab==="audio"){tabAudio.classList.add("tab-active");tabImages.classList.remove("tab-active");audioSection.classList.remove("hidden");imagesSection.classList.add("hidden");}
  else{tabImages.classList.add("tab-active");tabAudio.classList.remove("tab-active");imagesSection.classList.remove("hidden");audioSection.classList.add("hidden");}
}
tabAudio.onclick=()=>setTab("audio");
tabImages.onclick=()=>setTab("images");

// === المصحف المصور (EasyQuran) ===
const TOTAL_PAGES=604,EASYQURAN_BASE="https://easyquran.com/wp-content/uploads/2022/09/";
const imgEl=document.getElementById("quranPage"),pageInput=document.getElementById("pageNum");
function buildUrl(p){return`${EASYQURAN_BASE}${p}-scaled.jpg`;}
function loadPage(n){let p=Math.max(1,Math.min(TOTAL_PAGES,+n||1));pageInput.value=p;imgEl.src=buildUrl(p);}
document.getElementById("nextPage").onclick=()=>loadPage(+pageInput.value+1);
document.getElementById("prevPage").onclick=()=>loadPage(+pageInput.value-1);
pageInput.onchange=()=>loadPage(pageInput.value);
const SURAH_PAGES={1:1,2:2,3:50,4:77,5:106,6:128,7:151,8:177,9:187,10:208,11:221,12:235,13:249,14:255,15:262,16:267,17:282,18:293,19:305,20:312,21:322,22:332,23:342,24:350,25:359,26:367,27:377,28:385,29:396,30:404,31:411,32:415,33:418,34:428,35:434,36:440,37:446,38:453,39:458,40:467,41:477,42:483,43:489,44:496,45:499,46:502,47:507,48:511,49:515,50:518,51:520,52:523,53:526,54:528,55:531,56:534,57:537,58:542,59:545,60:549,61:551,62:553,63:554,64:556,65:558,66:560,67:562,68:564,69:566,70:568,71:570,72:572,73:574,74:575,75:577,76:578,77:580,78:582,79:583,80:585,81:586,82:587,83:589,84:590,85:591,86:592,87:593,88:594,89:595,90:596,91:597,92:598,93:599,94:599,95:600,96:600,97:601,98:601,99:602,100:602,101:603,102:603,103:603,104:604,105:604,106:604,107:604,108:604,109:604,110:604,111:604,112:604,113:604,114:604};
document.getElementById("surahImageSelect").onchange=e=>{
  const id=+e.target.value;
  if(id===0)loadPage(1);
  else if(SURAH_PAGES[id])loadPage(SURAH_PAGES[id]);
};
// ملء الشاشة
document.getElementById("fullscreenBtn").onclick=()=>{
  const wrap=document.getElementById("imageWrapper");
  if(wrap.requestFullscreen)wrap.requestFullscreen();
};
document.addEventListener("fullscreenchange",()=>{
  if(document.fullscreenElement){
    imgEl.style.width="auto";
    imgEl.style.height="100vh";
    imgEl.style.objectFit="contain";
  }else{
    imgEl.style.width="";
    imgEl.style.height="";
    imgEl.style.objectFit="";
  }
});

// === سحب وتكبير باللمس ===
let startX=0,scale=1,startDist=0;
imgEl.addEventListener("touchstart",e=>{
  if(e.touches.length===1)startX=e.touches[0].screenX;
  else if(e.touches.length===2){
    e.preventDefault();
    const dx=e.touches[0].clientX-e.touches[1].clientX;
    const dy=e.touches[0].clientY-e.touches[1].clientY;
    startDist=Math.sqrt(dx*dx+dy*dy);
  }
},{passive:false});
imgEl.addEventListener("touchmove",e=>{
  if(e.touches.length===2){
    e.preventDefault();
    const dx=e.touches[0].clientX-e.touches[1].clientX;
    const dy=e.touches[0].clientY-e.touches[1].clientY;
    const newDist=Math.sqrt(dx*dx+dy*dy);
    const factor=newDist/startDist;
    const newScale=Math.min(3,Math.max(1,scale*factor));
    imgEl.style.transform=`scale(${newScale})`;
  }
},{passive:false});
imgEl.addEventListener("touchend",e=>{
  if(e.touches.length<2){
    const m=imgEl.style.transform.match(/scale\(([\d.]+)\)/);
    scale=m?parseFloat(m[1]):1;
  }else if(e.changedTouches.length===1){
    const dx=e.changedTouches[0].screenX-startX;
    if(Math.abs(dx)>50)(dx>0)?loadPage(+pageInput.value+1):loadPage(+pageInput.value-1);
  }
});

// === تشغيل مبدئي ===
initTheme();fetchChapters();loadPage(1);

});
</script>
