<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ğŸ“– Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ… â€“ ØµØ¯Ù‚Ø© Ø¬Ø§Ø±ÙŠØ©</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
:root{
  --gold:#d4af37;
  --ink:#0f172a;
  --soft:#f1f5f9;
}

/* Ø£Ø³Ø§Ø³ */
body{
  font-family:"Noto Naskh Arabic UI","Segoe UI",system-ui,sans-serif;
  transition:background .3s,color .3s;
}

/* Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª ÙˆØ§Ù„Ø£Ø²Ø±Ø§Ø± */
.card{border-radius:.75rem;box-shadow:0 4px 12px rgba(0,0,0,.1)}
.btn{padding:.4rem .8rem;border-radius:.6rem;font-weight:600;transition:.2s}
.btn-gold{background:var(--gold);color:#1f2937}
.btn-danger{background:#ef4444;color:#fff}
.btn-ghost{background:transparent;border:1px solid rgba(0,0,0,.15)}
.btn-contrast{background:#f1f5f9;color:#0f172a;border:1px solid #cbd5e1}

/* Ø§Ù„Ø«ÙŠÙ…Ø§Øª */
.theme-day{background:#f8fafc;color:#0f172a}
.theme-day .card{background:#ffffff;color:#0f172a}
.theme-night{background:#0f172a;color:#f1f5f9}
.theme-night .card{background:#111827;color:#f1f5f9}
.theme-special{background:#0b3a2b;color:#fefce8}
.theme-special .card{background:#0f4a33;color:#fefce8;border:1px solid rgba(212,175,55,.25)}

/* Ø§Ù„Ù‡ÙŠØ¯Ø± */
header#appHeader{
  padding:1rem;background:transparent;backdrop-filter:blur(6px);
  border-bottom:1px solid rgba(0,0,0,.1);
}
#themeToggle, #whatsappTop{
  width:2.3rem;height:2.3rem;border-radius:.65rem;
  display:flex;align-items:center;justify-content:center;
}
#themeToggle{background:var(--gold);color:#1f2937}
#whatsappTop{background:#25D366}
#whatsappTop img{width:20px;height:20px}

/* Ø§Ù„Ø³Ø§Ø¹Ø© */
.clock-box{text-align:end;line-height:1.25}
.clock-box div{font-size:.9rem}

/* Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª */
nav.top-tabs{max-width:80rem;margin:auto}
.top-tabs .btn{border-radius:1.1rem;padding:.55rem 1.1rem;font-weight:600}
.tab-active{background:var(--gold);color:#000}
.tab-inactive{background:#e5e7eb;color:#000;opacity:.85}
.theme-night .tab-active{background:var(--gold);color:#1f2937}
.theme-night .tab-inactive{background:#374151;color:#f9fafb;opacity:.9}

/* Ø§Ù„Ù…ØµØ­Ù */
.quran-controls{
  display:flex;flex-wrap:wrap;align-items:center;gap:.4rem;
  padding:.35rem .55rem;background:#eef2f7;border-radius:8px;
  border:1px solid #cbd5e1;
}
.quran-controls select{
  padding:.34rem .5rem;border-radius:8px;border:1px solid #cbd5e1;
  background:#fff;color:#0b1423
}
.quran-controls .btn-tv{background:var(--gold);color:#1f2937;padding:.34rem .6rem;border-radius:.5rem}
.quran-stage{background:#e8edf5;border-radius:10px;padding:.4rem}
#imageWrapper{
  width:100%;height:calc(100vh - 165px);overflow:auto;
  display:flex;align-items:center;justify-content:center;
  background:#fff;border-radius:8px;scroll-behavior:smooth;
}
#quranPage{
  display:block;max-width:100%;max-height:100%;height:auto;margin:auto;
  border-radius:6px;user-select:none;-webkit-user-drag:none;
  box-shadow:0 2px 10px rgba(0,0,0,.12);
}
#imageWrapper:fullscreen img{width:auto!important;height:100vh!important;object-fit:contain}

/* Ø§Ù„ØµÙˆØª */
#progressBar{width:100%;height:6px;background:#e5e7eb;border-radius:999px;cursor:pointer}
#progressFill{height:100%;width:0;background:#10b981;border-radius:999px}

/* Ù…Ø¤Ù‚Øª Ø§Ù„Ù†ÙˆÙ… */
.sleep-row input{
  width:4.8rem;padding:.32rem;border-radius:.5rem;border:1px solid #cbd5e1;background:#fff;color:#0b1423
}

/* Ù…ÙˆØ¨Ø§ÙŠÙ„ */
@media (max-width:640px){
  #imageWrapper{height:calc(100dvh - 140px)}
}
</style>
</head>

<body class="theme-day min-h-screen">
<header id="appHeader" class="sticky top-0 z-10 flex items-center justify-between gap-3">
  <div class="flex items-center gap-2">
    <!-- Ø²Ø± Ø§Ù„Ø«ÙŠÙ… -->
    <button id="themeToggle" title="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹"><span id="themeIcon">ğŸŒ</span></button>

    <!-- ÙˆØ§ØªØ³Ø§Ø¨ -->
    <a id="whatsappTop" href="https://wa.me/905533331339" target="_blank" title="ÙˆØ§ØªØ³Ø§Ø¨">
      <img src="https://i.imgur.com/XC8wuji.png" alt="WhatsApp">
    </a>

    <!-- Ø§Ù„Ø¹Ù†ÙˆØ§Ù† -->
    <h1 class="font-bold text-base sm:text-lg">ğŸ“– Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ… â€“ <span class="font-normal">ØµØ¯Ù‚Ø© Ø¬Ø§Ø±ÙŠØ©</span></h1>
  </div>
  <div class="clock-box">
    <div id="hijriLine">â€”</div>
    <div id="gregLine">â€”</div>
  </div>
</header>

<!-- Tabs -->
<nav class="top-tabs p-4 flex gap-2">
  <button id="tabAudio" class="btn tab-inactive">Ø§Ù„ØµÙˆØª ğŸ”Š</button>
  <button id="tabImages" class="btn tab-active">Ø§Ù„Ù…ØµØ­Ù Ø§Ù„Ù…ØµÙˆÙ‘Ø± ğŸ–¼ï¸</button>
</nav>

<main class="space-y-6">
  <!-- Ø§Ù„Ù…ØµØ­Ù Ø§Ù„Ù…ØµÙˆÙ‘Ø± -->
  <section id="imagesSection" class="space-y-3">
    <div class="card p-3">
      <h2 class="font-semibold mb-2">ğŸ“– Ø§Ù„Ù…ØµØ­Ù Ø§Ù„Ù…ØµÙˆÙ‘Ø±</h2>
      <div class="quran-controls">
        <label class="opacity-80 text-sm">Ø§Ù„Ø³ÙˆØ±Ø©:</label>
        <select id="surahImageSelect" class="text-black"></select>
        <div class="flex items-center gap-2 ms-auto">
          <div class="flex items-center gap-1">
            <input id="pageNum" type="number" min="1" max="604" value="1" class="w-20 p-1 rounded border text-black bg-white">
            <span class="text-slate-800">/ 604</span>
          </div>
          <button id="fullscreenBtn" class="btn btn-tv" title="Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø©">ğŸ“º</button>
        </div>
      </div>
      <div class="quran-stage">
        <div id="imageWrapper">
          <img id="quranPage"
               src="https://easyquran.com/wp-content/uploads/2022/09/1-scaled.jpg"
               alt="ØµÙØ­Ø© Ø§Ù„Ù…ØµØ­Ù" loading="lazy">
        </div>
      </div>
    </div>
  </section>

  <!-- Ø§Ù„ØµÙˆØª -->
  <section id="audioSection" class="hidden space-y-4">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div class="card p-4">
        <h2 class="mb-2 font-semibold">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø³ÙˆØ±Ø©</h2>
        <select id="surahSelect" class="w-full p-2 rounded border text-black"></select>
      </div>
      <div class="card p-4">
        <h2 class="mb-2 font-semibold">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù‚Ø§Ø±Ø¦</h2>
        <select id="reciterSelect" class="w-full p-2 rounded border text-black"></select>
      </div>
    </div>

    <div class="card p-4">
      <h2 class="font-semibold mb-2">ÙˆØ¶Ø¹ Ø§Ù„ØªØ´ØºÙŠÙ„</h2>
      <div class="flex flex-wrap items-center gap-4 text-sm">
        <label><input type="radio" name="mode" value="single" checked> Ù‚Ø§Ø±Ø¦ ÙˆØ§Ø­Ø¯</label>
        <label><input type="radio" name="mode" value="multi"> Ø¹Ø¯Ø© Ù‚Ø±Ø§Ø¡</label>
        <label><input type="checkbox" id="loopToggle"> ØªÙƒØ±Ø§Ø± Ø§Ù„Ø³ÙˆØ±Ø©</label>
      </div>

      <div class="mt-3 flex flex-wrap gap-2 items-center text-sm sleep-row">
        <label>â±ï¸ Ù…Ø¤Ù‚Ù‘Øª Ø§Ù„Ù†ÙˆÙ…</label>
        <input id="sleepMinutes" type="number" min="0" step="1" placeholder="Ø¯Ù‚Ø§Ø¦Ù‚">
        <button id="sleepSet" class="px-3 py-1 bg-slate-600 text-white rounded">ØªÙØ¹ÙŠÙ„</button>
        <button id="sleepCancel" class="px-3 py-1 bg-red-500 text-white rounded">Ø¥Ù„ØºØ§Ø¡</button>
        <span id="sleepStatus" class="text-sm"></span>
      </div>
    </div>

    <div class="flex gap-3">
      <button id="addBtn" class="flex-1 btn btn-gold">â• Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù…Ø´ØºÙ„</button>
      <button id="favBtn" class="flex-1 btn btn-ghost">â­ Ù…ÙØ¶Ù„Ø©</button>
    </div>

    <div class="card p-4">
      <h2 class="font-semibold mb-2 flex items-center justify-between">
        <span>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ´ØºÙŠÙ„</span>
        <button id="clearBtn" class="btn btn-danger text-sm">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>
      </h2>
      <ul id="playlist" class="space-y-2"></ul>
    </div>

    <div class="card p-4">
      <h2 class="font-semibold mb-2">Ø§Ù„Ù…Ø´ØºÙ‘Ù„</h2>
      <div id="playerBox"></div>
      <div id="progressBar" class="mt-2"><div id="progressFill"></div></div>
      <div class="flex items-center justify-center gap-2 mt-2">
        <button id="back10" class="btn btn-contrast">âª 10Ø«</button>
        <button id="playPause" class="btn btn-contrast">â¯ï¸ ØªØ´ØºÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù</button>
        <button id="fwd10" class="btn btn-contrast">â© 10Ø«</button>
      </div>
      <div class="text-center mt-1 text-sm">
        <span id="timeNow">00:00</span> / <span id="timeTotal">00:00</span>
      </div>
    </div>

    <div class="card p-4">
      <h2 class="font-semibold mb-2 flex items-center justify-between">
        <span>â­ Ø§Ù„Ù…ÙØ¶Ù„Ø©</span>
        <button id="clearFavBtn" class="btn btn-danger text-sm">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>
      </h2>
      <ul id="favorites" class="space-y-2"></ul>
    </div>
  </section>

<!-- ğŸ”½ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ØªØ§Ù„ÙŠ (Ø§Ù„Ø¯ÙØ¹Ø© 2) ØªÙ„ØµÙ‚Ù‡ Ù‚Ø¨Ù„ </body> ğŸ”½ -->

</main>
<script>
// === Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù‚Ø±Ø§Ø¡ ===
const RECITERS = [
  { slug: "maher", name: "Ø§Ù„Ø´ÙŠØ® Ù…Ø§Ù‡Ø± Ø§Ù„Ù…Ø¹ÙŠÙ‚Ù„ÙŠ", base: "https://server12.mp3quran.net/maher" },
  { slug: "ajm", name: "Ø§Ù„Ø´ÙŠØ® Ø£Ø­Ù…Ø¯ Ø¨Ù† Ø¹Ù„ÙŠ Ø§Ù„Ø¹Ø¬Ù…ÙŠ", base: "https://server10.mp3quran.net/ajm" },
  { slug: "basit_mj", name: "Ø§Ù„Ø´ÙŠØ® Ø¹Ø¨Ø¯Ø§Ù„Ø¨Ø§Ø³Ø· Ø¹Ø¨Ø¯Ø§Ù„ØµÙ…Ø¯ (Ø§Ù„Ù…Ø¬ÙˆÙ‘Ø¯)", base: "https://server7.mp3quran.net/basit/Almusshaf-Al-Mojawwad" },
  { slug: "afs", name: "Ø§Ù„Ø´ÙŠØ® Ù…Ø´Ø§Ø±ÙŠ Ø¨Ù† Ø±Ø§Ø´Ø¯ Ø§Ù„Ø¹ÙØ§Ø³ÙŠ", base: "https://server8.mp3quran.net/afs" },
  { slug: "sgmd", name: "Ø§Ù„Ø´ÙŠØ® Ø³Ø¹Ø¯ Ø§Ù„ØºØ§Ù…Ø¯ÙŠ", base: "https://server7.mp3quran.net/s_gmd" },
  { slug: "husr", name: "Ø§Ù„Ø´ÙŠØ® Ù…Ø­Ù…ÙˆØ¯ Ø®Ù„ÙŠÙ„ Ø§Ù„Ø­ØµØ±ÙŠ", base: "https://server13.mp3quran.net/husr" },
  { slug: "shur", name: "Ø§Ù„Ø´ÙŠØ® Ø³Ø¹ÙˆØ¯ Ø§Ù„Ø´Ø±ÙŠÙ…", base: "https://server7.mp3quran.net/shur" },
  { slug: "shatri", name: "Ø§Ù„Ø´ÙŠØ® Ø£Ø¨Ùˆ Ø¨ÙƒØ± Ø§Ù„Ø´Ø§Ø·Ø±ÙŠ", base: "https://server11.mp3quran.net/shatri" },
  { slug: "minsh", name: "Ø§Ù„Ø´ÙŠØ® Ù…Ø­Ù…Ø¯ ØµØ¯ÙŠÙ‚ Ø§Ù„Ù…Ù†Ø´Ø§ÙˆÙŠ", base: "https://server10.mp3quran.net/minsh" },
  { slug: "sds", name: "Ø§Ù„Ø´ÙŠØ® Ø¹Ø¨Ø¯Ø§Ù„Ø±Ø­Ù…Ù† Ø§Ù„Ø³Ø¯ÙŠØ³", base: "https://server11.mp3quran.net/sds" }
];
const pad3 = n => String(n).padStart(3, "0");
let chapters = [];
const state = { playlist: [], favorites: [], idx: 0, mode: "single", loop: false, resume: {}, sleepTimeout: null };

// === ØªØ­Ù…ÙŠÙ„ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø³ÙˆØ± ===
async function fetchChapters() {
  try {
    const r = await fetch("https://api.quran.com/api/v4/chapters");
    const j = await r.json();
    chapters = j.chapters || [];
  } catch {
    chapters = [...Array(114)].map((_, i) => ({ id: i + 1, name_arabic: `Ø³ÙˆØ±Ø© ${i + 1}` }));
  }
  document.getElementById("surahSelect").innerHTML =
    chapters.map(c => `<option value="${c.id}">${c.id}. ${c.name_arabic}</option>`).join("");
  document.getElementById("reciterSelect").innerHTML =
    RECITERS.map(r => `<option value="${r.slug}">${r.name}</option>`).join("");
  document.getElementById("surahImageSelect").innerHTML =
    `<option value="0">ğŸ“– ÙƒØ§Ù…Ù„ Ø§Ù„Ù‚Ø±Ø¢Ù† (604 ØµÙØ­Ø©)</option>` +
    chapters.map(c => `<option value="${c.id}">${c.id}. ${c.name_arabic}</option>`).join("");
}

// === ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆÙ‚Øª ÙˆØ§Ù„ØªØ§Ø±ÙŠØ® ===
async function updateClock() {
  const d = new Date();
  const gDate = `${d.getDate().toString().padStart(2,"0")}-${(d.getMonth()+1).toString().padStart(2,"0")}-${d.getFullYear()}`;
  const t = `${d.getHours().toString().padStart(2,"0")}:${d.getMinutes().toString().padStart(2,"0")}`;
  try {
    const r = await fetch(`https://api.aladhan.com/v1/gToH?date=${gDate}`);
    const j = await r.json();
    const hijri = j.data.hijri;
    document.getElementById("hijriLine").innerText = `${hijri.day} ${hijri.month.ar} ${hijri.year} Ù‡Ù€`;
  } catch {
    document.getElementById("hijriLine").innerText = "(Ø§Ù„Ù‡Ø¬Ø±ÙŠ ØºÙŠØ± Ù…ØªØ§Ø­)";
  }
  document.getElementById("gregLine").innerText = `${gDate} | ${t}`;
}
setInterval(updateClock, 60000);
updateClock();

// === ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø«ÙŠÙ… ===
const THEMES = ["day", "night", "special"];
let currentThemeIndex = 0;
function applyTheme(t) {
  document.body.classList.remove("theme-day", "theme-night", "theme-special");
  document.body.classList.add("theme-" + t);
  localStorage.setItem("theme_choice", t);
  document.getElementById("themeIcon").textContent =
    t === "night" ? "ğŸŒ™" : t === "special" ? "ğŸ’š" : "ğŸŒ";
}
function initTheme() {
  const saved = localStorage.getItem("theme_choice");
  if (saved) { applyTheme(saved); currentThemeIndex = THEMES.indexOf(saved); }
  else applyTheme("day");
}
document.getElementById("themeToggle").onclick = () => {
  currentThemeIndex = (currentThemeIndex + 1) % THEMES.length;
  applyTheme(THEMES[currentThemeIndex]);
};

// === ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„ØµÙˆØª / Ø§Ù„ØµÙˆØ± ===
const tabAudio = document.getElementById("tabAudio");
const tabImages = document.getElementById("tabImages");
const audioSection = document.getElementById("audioSection");
const imagesSection = document.getElementById("imagesSection");
function setTab(tab) {
  if (tab === "audio") {
    tabAudio.classList.add("tab-active");
    tabAudio.classList.remove("tab-inactive");
    tabImages.classList.add("tab-inactive");
    tabImages.classList.remove("tab-active");
    audioSection.classList.remove("hidden");
    imagesSection.classList.add("hidden");
  } else {
    tabImages.classList.add("tab-active");
    tabImages.classList.remove("tab-inactive");
    tabAudio.classList.add("tab-inactive");
    tabAudio.classList.remove("tab-active");
    imagesSection.classList.remove("hidden");
    audioSection.classList.add("hidden");
  }
}
tabAudio.onclick = () => setTab("audio");
tabImages.onclick = () => setTab("images");

// === Ù…ØµØ­Ù Ù…ØµÙˆÙ‘Ø± ===
const TOTAL_PAGES = 604;
const imgEl = document.getElementById("quranPage");
const pageInput = document.getElementById("pageNum");
const wrapper = document.getElementById("imageWrapper");

function loadPage(n) {
  const p = Math.max(1, Math.min(TOTAL_PAGES, parseInt(n) || 1));
  pageInput.value = p;
  imgEl.style.opacity = 0; // Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ø·ÙŠÙ
  const newSrc = `https://easyquran.com/wp-content/uploads/2022/09/${p}-scaled.jpg`;
  if (imgEl.src !== newSrc) imgEl.src = newSrc;
}
imgEl.onload = () => { imgEl.style.opacity = 1; };
pageInput.onchange = () => loadPage(pageInput.value);

document.getElementById("fullscreenBtn").onclick = () => {
  const el = document.getElementById("imageWrapper");
  if (el.requestFullscreen) el.requestFullscreen();
};

// âœ… (1) Ø³Ø­Ø¨ Ø§Ù„Ø¬ÙˆØ§Ù„: ÙŠÙ…ÙŠÙ† â†’ ØªØ§Ù„ÙŠØ© / ÙŠØ³Ø§Ø± â†’ Ø³Ø§Ø¨Ù‚Ø©
let touchStartX = 0;
imgEl.addEventListener("touchstart", e => touchStartX = e.changedTouches[0].screenX, { passive: true });
imgEl.addEventListener("touchend", e => {
  const dx = e.changedTouches[0].screenX - touchStartX;
  if (Math.abs(dx) > 50) {
    if (dx > 0) loadPage(parseInt(pageInput.value) + 1); // ÙŠÙ…ÙŠÙ† â†’ ØªØ§Ù„ÙŠØ©
    else loadPage(parseInt(pageInput.value) - 1);        // ÙŠØ³Ø§Ø± â†’ Ø³Ø§Ø¨Ù‚Ø©
  }
});

// âœ… (2) Ø¹Ø¬Ù„Ø© Ø§Ù„Ù…Ø§ÙˆØ³: ØªØ­Øª â†’ ØªØ§Ù„ÙŠØ© / ÙÙˆÙ‚ â†’ Ø³Ø§Ø¨Ù‚Ø© (Ø¨Ø­Ø³Ø§Ø³ÙŠØ© Ø®ÙÙŠÙØ©)
let lastWheelTs = 0;
wrapper.addEventListener("wheel", e => {
  e.preventDefault(); // Ù…Ù†Ø¹ Ø³ÙƒØ±ÙˆÙ„ Ø¯Ø§Ø®Ù„ÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠ
  const now = Date.now();
  const thresholdMs = 350; // Ø­Ø³Ø§Ø³ÙŠØ© Ø®ÙÙŠÙØ©
  if (now - lastWheelTs < thresholdMs) return;
  // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ù„Ù…Ø³Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© Ø¬Ø¯Ù‹Ø§
  if (Math.abs(e.deltaY) < 8) return;
  lastWheelTs = now;
  if (e.deltaY > 0) loadPage(parseInt(pageInput.value) + 1); // Ù†Ø²ÙˆÙ„ â†’ ØªØ§Ù„ÙŠØ©
  else loadPage(parseInt(pageInput.value) - 1);              // ØµØ¹ÙˆØ¯ â†’ Ø³Ø§Ø¨Ù‚Ø©
}, { passive: false });

// âœ… (3) Ø£Ø³Ù‡Ù… Ø§Ù„ÙƒÙŠØ¨ÙˆØ±Ø¯ â† â†’
document.addEventListener("keydown", e => {
  const cur = parseInt(pageInput.value);
  if (e.key === "ArrowRight") loadPage(cur + 1); // ÙŠÙ…ÙŠÙ† â†’ ØªØ§Ù„ÙŠØ©
  if (e.key === "ArrowLeft")  loadPage(cur - 1); // ÙŠØ³Ø§Ø± â†’ Ø³Ø§Ø¨Ù‚Ø©
});

// âœ… (4) Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ø£ÙˆÙ„ ØµÙØ­Ø© Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø³ÙˆØ±Ø©
const SURAH_FIRST_PAGE = [
  1,2,50,77,106,128,151,177,187,208,221,235,249,255,262,267,282,293,305,312,
  322,332,342,350,359,367,377,385,396,404,411,415,418,428,434,440,446,453,458,
  467,477,483,489,496,499,502,507,511,515,518,520,523,526,528,531,534,537,542,
  545,549,551,553,554,556,558,560,562,564,566,568,570,572,574,575,577,578,580,
  582,583,585,586,587,587,589,590,591,592,593,594,595,595,596,596,597,597,598,
  598,599,599,600,600,601,601,601,602,602,603,603,603,604,604
];
document.getElementById("surahImageSelect").addEventListener("change", e => {
  const surahId = parseInt(e.target.value);
  if (surahId > 0 && SURAH_FIRST_PAGE[surahId - 1]) {
    loadPage(SURAH_FIRST_PAGE[surahId - 1]);
  }
});

// === Ø§Ù„ØµÙˆØª ===
function persist() {
  localStorage.setItem("playlist", JSON.stringify(state.playlist));
  localStorage.setItem("favorites", JSON.stringify(state.favorites));
  localStorage.setItem("resume", JSON.stringify(state.resume));
}

function add(auto=false) {
  const recSlug = document.getElementById("reciterSelect").value;
  const rec = RECITERS.find(r => r.slug === recSlug);
  const surId = parseInt(document.getElementById("surahSelect").value);
  if (!rec || !surId) {
    alert("Ø§Ø®ØªØ± Ø§Ù„Ø³ÙˆØ±Ø© ÙˆØ§Ù„Ù‚Ø§Ø±Ø¦ Ø£ÙˆÙ„Ø§Ù‹");
    return;
  }
  const sur = chapters.find(c => c.id === surId);
  const newItem = { title: sur.name_arabic, reciter: rec.name, src: `${rec.base}/${pad3(surId)}.mp3` };

  // Ù…Ù†Ø·Ù‚ Ù‚Ø§Ø±Ø¦ ÙˆØ§Ø­Ø¯ / Ø¹Ø¯Ø© Ù‚Ø±Ø§Ø¡
  if (state.mode === "single" && state.playlist.length > 0) {
    const currentReciter = state.playlist[0].reciter;
    if (currentReciter !== rec.name) {
      alert("âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø®Ù„Ø· Ø§Ù„Ù‚Ø±Ø§Ø¡ ÙÙŠ ÙˆØ¶Ø¹ Ù‚Ø§Ø±Ø¦ ÙˆØ§Ø­Ø¯.");
      return;
    }
  }

  state.playlist.push(newItem);
  state.idx = state.playlist.length - 1;
  persist();
  render(auto);
}

function render(auto) {
  const cur = state.playlist[state.idx];
  const box = document.getElementById("playerBox");
  if (cur) {
    box.innerHTML = `<div class="mb-2 font-medium">${cur.title} â€” <span class="text-emerald-400">${cur.reciter}</span></div>
    <audio id="player" src="${cur.src}" controls ${auto ? "autoplay" : ""}></audio>`;
    const a = document.getElementById("player");
    a.loop = state.loop;
    a.ontimeupdate = () => {
      updateProgress();
      state.resume[cur.src] = a.currentTime;
      localStorage.setItem("resume", JSON.stringify(state.resume));
    };
    a.onloadedmetadata = () => document.getElementById("timeTotal").textContent = formatTime(a.duration);
    a.onended = () => {
      if (state.loop) a.play();
      else if (state.idx + 1 < state.playlist.length) {
        state.idx++;
        render(true);
      }
    };
    a.onerror = () => alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³ÙˆØ±Ø©. Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ù‹Ø§.");
  } else box.innerHTML = "<div class='text-slate-500'>Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ´ØºÙŠÙ„</div>";

  document.getElementById("playlist").innerHTML = state.playlist
    .map((t,i)=>`<li class="flex justify-between items-center bg-white/70 px-3 py-2 rounded">
      <span>${t.title} - ${t.reciter}</span>
      <span class="flex items-center gap-2">
        <button onclick="addSpecificToFavorites(${i})" class="text-amber-500" title="Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙØ¶Ù„Ø©">â­</button>
        <button onclick="playAt(${i})" title="ØªØ´ØºÙŠÙ„">â–¶ï¸</button>
        <button onclick="removeAt(${i})" class="text-red-500" title="Ø­Ø°Ù">ğŸ—‘ï¸</button>
      </span></li>`).join("");
}

function playAt(i){state.idx=i;render(true);}
function removeAt(i){state.playlist.splice(i,1);if(state.idx>=state.playlist.length)state.idx=state.playlist.length-1;persist();render(false);}
function updateProgress(){
  const a=document.getElementById("player");
  if(!a||!isFinite(a.duration))return;
  document.getElementById("progressFill").style.width=(a.currentTime/a.duration*100)+"%";
  document.getElementById("timeNow").textContent=formatTime(a.currentTime);
}
function formatTime(s){if(!s||!isFinite(s))return"00:00";const m=Math.floor(s/60),sec=Math.floor(s%60);return`${String(m).padStart(2,"0")}:${String(sec).padStart(2,"0")}`;}
function skip(sec){const a=document.getElementById("player");if(a)a.currentTime+=sec;}
function togglePlay(){const a=document.getElementById("player");if(a)(a.paused?a.play():a.pause());}

// === Ù…ÙØ¶Ù„Ø© ===
function addSpecificToFavorites(i){
  const it=state.playlist[i];if(!it)return;
  if(!state.favorites.some(f=>f.title===it.title&&f.reciter===it.reciter)){
    state.favorites.push(it);
    persist();
    renderFavorites();
  }
}
function renderFavorites(){
  document.getElementById("favorites").innerHTML=state.favorites.map((f,i)=>`
    <li class="flex justify-between items-center bg-white/70 px-3 py-2 rounded">
      <span>${f.title} - ${f.reciter}</span>
      <span class="flex items-center gap-2">
        <button onclick="playFavorite(${i})" class="text-emerald-600" title="ØªØ´ØºÙŠÙ„">â–¶ï¸</button>
        <button onclick="removeFav(${i})" class="text-red-500" title="Ø­Ø°Ù">ğŸ—‘ï¸</button>
      </span>
    </li>`).join("");
  persist();
}
function playFavorite(i){
  const fav=state.favorites[i];if(!fav)return;
  state.playlist=[fav];
  state.idx=0;
  persist();
  render(true);
}
function removeFav(i){state.favorites.splice(i,1);persist();renderFavorites();}
document.getElementById("clearBtn").onclick=()=>{if(confirm("Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„ØŸ")){state.playlist=[];state.idx=0;persist();render(false);}};
document.getElementById("clearFavBtn").onclick=()=>{if(confirm("Ù…Ø³Ø­ Ø§Ù„Ù…ÙØ¶Ù„Ø©ØŸ")){state.favorites=[];persist();renderFavorites();}};

// Ø²Ø± â­ Ø§Ù„Ø¹Ø§Ù… Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ù„Ù…ÙØ¶Ù„Ø©
document.getElementById("favBtn").onclick=()=>{
  const recSlug=document.getElementById("reciterSelect").value;
  const rec=RECITERS.find(r=>r.slug===recSlug);
  const surId=parseInt(document.getElementById("surahSelect").value);
  if(!rec||!surId){alert("Ø§Ø®ØªØ± Ø§Ù„Ø³ÙˆØ±Ø© ÙˆØ§Ù„Ù‚Ø§Ø±Ø¦ Ø£ÙˆÙ„Ø§Ù‹");return;}
  const sur=chapters.find(c=>c.id===surId);
  const newItem={title:sur.name_arabic,reciter:rec.name,src:`${rec.base}/${pad3(surId)}.mp3`};
  if(!state.favorites.some(f=>f.src===newItem.src)){
    state.favorites.push(newItem);
    persist();
    renderFavorites();
  }
};

// === Ù…Ø¤Ù‚Øª Ø§Ù„Ù†ÙˆÙ… ===
function setSleepTimer(){
  const min=parseInt(document.getElementById("sleepMinutes").value);
  if(isNaN(min)||min<=0)return alert("Ø£Ø¯Ø®Ù„ Ø¯Ù‚Ø§Ø¦Ù‚ ØµØ­ÙŠØ­Ø©");
  if(state.sleepTimeout)clearTimeout(state.sleepTimeout);
  const end=Date.now()+min*60000;
  state.sleepTimeout=setInterval(()=>{
    const remain=Math.max(0,end-Date.now());
    const m=Math.floor(remain/60000),s=Math.floor((remain%60000)/1000);
    document.getElementById("sleepStatus").textContent=`â±ï¸ Ù…ØªØ¨Ù‚Ù ${m}:${String(s).padStart(2,"0")}`;
    if(remain<=0){
      clearInterval(state.sleepTimeout);
      const a=document.getElementById("player");
      if(a)a.pause();
      document.getElementById("sleepStatus").textContent="â¹ï¸ ØªÙ… Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§";
    }
  },1000);
}
function cancelSleepTimer(){
  if(state.sleepTimeout)clearInterval(state.sleepTimeout);
  document.getElementById("sleepStatus").textContent="ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù…Ø¤Ù‚Ù‘Øª";
}

// === Ø§Ù„Ø£Ø­Ø¯Ø§Ø« ===
window.onload=()=>{
  initTheme();
  fetchChapters();
  updateClock();
  state.playlist=JSON.parse(localStorage.getItem("playlist")||"[]");
  state.favorites=JSON.parse(localStorage.getItem("favorites")||"[]");
  state.resume=JSON.parse(localStorage.getItem("resume")||"{}");
  render(false);
  renderFavorites();
  document.getElementById("addBtn").onclick=()=>add(true);
  document.getElementById("playPause").onclick=togglePlay;
  document.getElementById("fwd10").onclick=()=>skip(10);
  document.getElementById("back10").onclick=()=>skip(-10);
  document.getElementById("sleepSet").onclick=setSleepTimer;
  document.getElementById("sleepCancel").onclick=cancelSleepTimer;
  document.querySelectorAll("input[name='mode']").forEach(r=>r.onchange=()=>state.mode=r.value);
};
</script>
</body>
</html>
