<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"/>
<meta name="theme-color" content="#d4af37"/>
<meta name="mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<meta name="apple-mobile-web-app-title" content="القرآن الكريم"/>
<title>القرآن الكريم – صدقة جارية</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Noto+Naskh+Arabic:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{--gold:#d4af37;--gold-dark:#b8941f;--emerald:#059669;--emerald-dark:#047857;--emerald-light:#10b981;--ink:#0f172a;--warm:#f5f1e8;--deep:#0f172a;--slate:#1e293b}
body{font-family:"Noto Naskh Arabic","Amiri",serif;overflow-x:hidden;transition:background .3s,color .3s;padding-bottom:6rem;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
input,textarea,select{-webkit-user-select:text;-moz-user-select:text;-ms-user-select:text;user-select:text}
.theme-day{background:linear-gradient(135deg,var(--warm),#fff);color:var(--ink)}
.theme-night{background:linear-gradient(135deg,var(--slate),var(--deep));color:#e5e7eb}
.theme-special{background:linear-gradient(135deg,#1e3a2e,#2d5a3d);color:#fefce8}
.card{background:rgba(255,255,255,.9);border-radius:1rem;box-shadow:0 8px 24px rgba(0,0,0,.08);transition:transform .2s,box-shadow .2s;-webkit-transform:translateZ(0);transform:translateZ(0);will-change:transform}
.theme-night .card{background:rgba(30,41,59,.9)}
.theme-special .card{background:rgba(45,90,61,.9)}
.card:hover{transform:translateY(-2px);box-shadow:0 12px 32px rgba(0,0,0,.12)}
.btn{padding:.6rem .9rem;border-radius:.8rem;font-weight:700;display:inline-flex;gap:.5rem;align-items:center;justify-content:center;min-height:40px;cursor:pointer;transition:all .2s;-webkit-tap-highlight-color:rgba(212,175,55,0.2);-webkit-transform:translateZ(0);transform:translateZ(0);will-change:transform}
.btn:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,.15)}
.btn:active{transform:translateY(0)}
.btn-emerald{background:linear-gradient(135deg,var(--emerald),var(--emerald-dark));color:#fff}
.btn-gold{background:linear-gradient(135deg,var(--gold),var(--gold-dark));color:#111827}
.btn-danger{background:linear-gradient(135deg,#ef4444,#dc2626);color:#fff}
select,input[type="number"],input[type="text"],textarea{background:#fff;color:#000;border:2px solid rgba(212,175,55,.5);border-radius:.7rem;padding:.45rem .6rem;min-height:38px;font-weight:600;transition:border-color .2s}
select:focus,input:focus,textarea:focus{outline:none;border-color:var(--gold);box-shadow:0 0 0 3px rgba(212,175,55,.25)}
header#appHeader{padding:1rem;background:rgba(255,255,255,.95);backdrop-filter:blur(16px);border-bottom:1px solid rgba(212,175,55,.25);position:sticky;top:0;z-index:40}
.theme-night header#appHeader{background:rgba(15,23,42,.95)}
.theme-special header#appHeader{background:rgba(30,58,46,.95)}
#themeToggle,#whatsappTop{width:3rem;height:3rem;border-radius:1rem;display:flex;align-items:center;justify-content:center;transition:transform .2s}
#themeToggle:hover,#whatsappTop:hover{transform:scale(1.05)}
#themeToggle{background:linear-gradient(135deg,var(--gold),var(--gold-dark));color:#111827}
#whatsappTop{background:linear-gradient(135deg,#25D366,#1da851);color:#fff}
.bottom-nav{position:fixed;bottom:0;left:0;right:0;background:rgba(255,255,255,.98);backdrop-filter:blur(16px);border-top:1px solid rgba(212,175,55,.25);padding:.5rem;z-index:50;transition:transform .25s ease}
.theme-night .bottom-nav{background:rgba(15,23,42,.98)}
.theme-special .bottom-nav{background:rgba(30,58,46,.98)}
.nav-container{display:flex;justify-content:space-around;align-items:center;max-width:800px;margin:0 auto;overflow-x:auto;gap:0.15rem;padding:0 .25rem}
.nav-item{display:flex;flex-direction:column;align-items:center;gap:.2rem;padding:.35rem .4rem;border-radius:.75rem;min-width:50px;cursor:pointer;transition:all .2s;-webkit-transform:translateZ(0);transform:translateZ(0);will-change:transform;flex-shrink:0}
.nav-item:hover{background:rgba(212,175,55,.1)}
.nav-item.active{background:linear-gradient(135deg,var(--gold),var(--gold-dark));color:#111827}
.nav-icon{font-size:1.3rem;transition:transform .2s}
.nav-item:hover .nav-icon{transform:scale(1.1)}
.nav-text{font-size:.68rem;font-weight:800}
.section{display:none;min-height:calc(100vh - 140px);padding:1rem;opacity:0;transform:translateY(8px);transition:opacity .2s,transform .2s}
.section.active{display:block;opacity:1;transform:translateY(0)}
.quran-topbar{display:flex;flex-wrap:wrap;gap:.5rem;align-items:center;margin-bottom:.6rem}
#imageWrapper{width:100%;height:calc(100vh - 160px);display:flex;align-items:center;justify-content:center;background:#000;border-radius:0;position:relative;overflow:hidden}
#quranPage{max-width:100%;max-height:100%;height:auto;border-radius:0;user-select:none;-webkit-user-drag:none;box-shadow:0 4px 12px rgba(0,0,0,.1);transition:opacity .3s}
#quranPage.loading{opacity:0.3}
.audio-player{background:linear-gradient(135deg,rgba(255,255,255,.1),rgba(255,255,255,.05));border:1px solid rgba(212,175,55,.25);border-radius:1rem;padding:1rem;overflow:visible}
.audio-player audio{width:100%;outline:none;max-width:100%}
.float-btn{position:absolute;bottom:20px;right:20px;width:52px;height:52px;border-radius:9999px;display:flex;align-items:center;justify-content:center;font-size:1.3rem;background:linear-gradient(135deg,var(--emerald),var(--emerald-dark));color:#fff;box-shadow:0 8px 24px rgba(4,120,87,.35);z-index:100;transition:all .3s;cursor:pointer}
.float-btn:hover{transform:scale(1.12) rotate(8deg);box-shadow:0 10px 28px rgba(4,120,87,.45)}
.float-btn:active{transform:scale(0.95)}
.float-btn.hide{opacity:0;pointer-events:none;transform:scale(0.7)}
.fade-in-text{animation:fadeInText .4s ease}
@keyframes fadeInText{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:translateY(0)}}
.read-mark{outline:3px solid rgba(16,185,129,.9);box-shadow:0 0 0 8px rgba(16,185,129,.2);animation:readPulse 1s ease}
@keyframes readPulse{0%{transform:scale(1);opacity:.85}50%{transform:scale(1.02);opacity:1}100%{transform:scale(1);opacity:1}}
.read-check{position:absolute;top:.75rem;right:.75rem;background:rgba(16,185,129,.95);color:#fff;border-radius:9999px;font-size:.85rem;padding:.25rem .5rem;display:none;z-index:5;box-shadow:0 2px 8px rgba(0,0,0,.2)}
.loading-spinner{display:inline-block;width:20px;height:20px;border:3px solid rgba(255,255,255,.3);border-radius:50%;border-top-color:#fff;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.theme-day select,.theme-special select,select,.theme-day input[type="number"],.theme-special input[type="number"],#pageNum{color:#000!important;background:#fff!important}
select option{color:#000!important;background:#fff!important}
.modal-mask{position:fixed;inset:0;background:rgba(0,0,0,.65);display:flex;align-items:center;justify-content:center;z-index:70;animation:fadeIn .3s ease}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.modal{width:90%;max-width:420px;max-height:70vh;overflow:hidden;background:#fff;border-radius:1rem;box-shadow:0 20px 40px rgba(0,0,0,.4);animation:slideUp .3s ease}
@keyframes slideUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
.theme-night .modal{background:#0b1220;color:#e5e7eb}
.theme-special .modal{background:#1e3a2e;color:#fefce8}
.modal-header{padding:.75rem 1rem;border-bottom:1px solid rgba(212,175,55,.25);font-weight:800;text-align:center;font-size:1.1rem}
.modal-body{max-height:60vh;overflow:auto;padding:.5rem}
.modal-close{width:100%;padding:.7rem 1rem;background:#ef4444;color:#fff;font-weight:800;border:none;border-radius:0 0 1rem 1rem;cursor:pointer;transition:background .2s}
.modal-close:hover{background:#dc2626}
#exitFullscreenBtn{position:fixed;top:.75rem;left:.75rem;background:rgba(0,0,0,.7);color:#fff;width:40px;height:40px;border-radius:.7rem;display:none;align-items:center;justify-content:center;font-size:20px;z-index:9999;border:1px solid rgba(255,255,255,.3);cursor:pointer;transition:all .2s}
#exitFullscreenBtn:hover{background:rgba(0,0,0,.85);transform:scale(1.05)}
#favPageBtn{min-width:40px;min-height:40px;border-radius:.7rem;background:linear-gradient(135deg,var(--gold),var(--gold-dark));color:#111827;font-weight:900;border:none;font-size:1.2rem;cursor:pointer;transition:all .2s}
#favPageBtn:hover{transform:scale(1.08) rotate(15deg)}
#favPageBtn.favorited{animation:starPop .5s ease}
@keyframes starPop{0%,100%{transform:scale(1) rotate(0)}50%{transform:scale(1.2) rotate(180deg)}}
.toast{position:fixed;top:5rem;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.9);color:#fff;padding:.7rem 1.2rem;border-radius:.8rem;font-size:.95rem;z-index:9999;box-shadow:0 4px 12px rgba(0,0,0,.3);animation:toastSlide .3s ease;backdrop-filter:blur(8px)}
@keyframes toastSlide{from{opacity:0;transform:translate(-50%,-10px)}to{opacity:1;transform:translate(-50%,0)}}
.playlist-item{transition:all .2s}
.playlist-item:hover{background:rgba(212,175,55,.15)!important}
.stat-card{background:linear-gradient(135deg,rgba(212,175,55,.1),rgba(212,175,55,.05));border:2px solid rgba(212,175,55,.3);border-radius:1rem;padding:1rem;text-align:center;transition:all .2s}
.stat-card:hover{transform:translateY(-3px);box-shadow:0 8px 20px rgba(212,175,55,.2)}
.stat-number{font-size:2rem;font-weight:800;color:var(--gold);display:block;margin-bottom:.3rem}
.stat-label{font-size:.85rem;opacity:.8}
*{-webkit-overflow-scrolling:touch}
.hadith-card{background:rgba(255,255,255,.95);padding:1.2rem;border-radius:1rem;margin-bottom:1rem;border-right:4px solid var(--gold);box-shadow:0 4px 12px rgba(0,0,0,.08);transition:all .2s}
.theme-night .hadith-card{background:rgba(30,41,59,.95);border-right-color:var(--gold)}
.theme-special .hadith-card{background:rgba(45,90,61,.95)}
.hadith-card:hover{transform:translateX(-3px);box-shadow:0 8px 20px rgba(0,0,0,.12)}
.hadith-text{font-size:1.1rem;line-height:2;margin-bottom:.8rem;text-align:justify}
.hadith-meta{font-size:.9rem;opacity:.75;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:.5rem}
#hadithSearchInput{width:100%;padding:.6rem;border-radius:.8rem;border:2px solid rgba(212,175,55,.5);font-size:1rem}
.prayer-time-card{background:linear-gradient(135deg,rgba(255,255,255,.15),rgba(255,255,255,.05));border:2px solid rgba(212,175,55,.3);border-radius:1rem;padding:1rem 1.5rem;display:flex;justify-content:space-between;align-items:center;transition:all .3s;margin-bottom:.8rem}
.prayer-time-card:hover{transform:translateX(-3px);border-color:var(--gold)}
.prayer-time-card.current{background:linear-gradient(135deg,var(--emerald),var(--emerald-dark));color:#fff;border-color:var(--emerald-light);box-shadow:0 8px 20px rgba(5,150,105,.4);animation:pulse 2s infinite}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.02)}}
.prayer-time-card.next{border-color:var(--gold);border-width:3px;background:linear-gradient(135deg,rgba(212,175,55,.2),rgba(212,175,55,.1))}
.prayer-name{font-size:1.3rem;font-weight:800}
.prayer-time{font-size:1.5rem;font-weight:900;font-family:monospace}
.countdown-box{background:rgba(0,0,0,.1);border-radius:.7rem;padding:.8rem 1.2rem;text-align:center;margin:1rem 0}
.countdown-time{font-size:2rem;font-weight:900;font-family:monospace;color:var(--emerald)}
.countdown-label{font-size:.85rem;opacity:.75;margin-top:.3rem}

/* Fullscreen styles for iPhone */
.fullscreen-mode {
  position: fixed !important;
  top: 0 !important;
  left: 0 !important;
  right: 0 !important;
  bottom: 0 !important;
  width: 100vw !important;
  height: 100vh !important;
  max-width: 100vw !important;
  max-height: 100vh !important;
  z-index: 99999 !important;
  background: #000 !important;
  margin: 0 !important;
  padding: 0 !important;
}

.fullscreen-mode #quranPage {
  width: 100vw !important;
  height: 100vh !important;
  max-width: 100vw !important;
  max-height: 100vh !important;
  object-fit: contain !important;
}

body.fullscreen-active {
  overflow: hidden !important;
}

body.fullscreen-active #appHeader,
body.fullscreen-active .bottom-nav {
  display: none !important;
}

@media(max-width:640px){
  #imageWrapper{height:calc(100vh - 160px)}
  .nav-text{font-size:.62rem}
  .nav-icon{font-size:1.2rem}
  .nav-item{padding:.3rem .35rem;min-width:48px;gap:.15rem}
  .quran-topbar{gap:.4rem}
  header#appHeader h1{font-size:0.85rem}
  .btn{padding:.5rem .7rem;font-size:0.85rem;min-height:38px}
  .quran-topbar .btn{padding:.4rem .6rem;font-size:0.75rem}
  select,input[type="number"]{font-size:16px!important;padding:.35rem .5rem}
  .stat-card{padding:.7rem}
  .stat-number{font-size:1.5rem}
  .stat-label{font-size:0.75rem}
  .card h3{font-size:1rem}
  #playlist li,#favorites li{padding:.6rem .8rem;font-size:0.9rem}
  #themeToggle,#whatsappTop{width:2.5rem;height:2.5rem}
  .modal{width:95%;max-height:80vh}
  .modal-body{max-height:65vh}
  input,select,textarea{font-size:16px!important}
  .float-btn{width:48px;height:48px;bottom:15px;right:15px}
  .audio-player{padding:1.2rem}
  .audio-player audio{height:58px!important;min-height:58px!important;border-radius:0.6rem}
  .audio-player audio::-webkit-media-controls-enclosure{border-radius:0.6rem}
  .audio-player audio::-webkit-media-controls-panel{background:rgba(212,175,55,0.18);border-radius:0.6rem;padding:6px 0}
  .audio-player audio::-webkit-media-controls-play-button,.audio-player audio::-webkit-media-controls-pause-button{width:42px;height:42px;transform:scale(1.35);margin:0 8px}
  .audio-player audio::-webkit-media-controls-timeline{height:8px;border-radius:4px;margin:0 8px}
  .audio-player audio::-webkit-media-controls-current-time-display,.audio-player audio::-webkit-media-controls-time-remaining-display{font-size:15px;font-weight:700;min-width:52px}
  .audio-player audio::-webkit-media-controls-mute-button,.audio-player audio::-webkit-media-controls-volume-slider{display:none}
  .hadith-text{font-size:1rem;line-height:1.8}
  .hadith-card{padding:1rem}
  .prayer-time-card{padding:.8rem 1rem}
  .prayer-name{font-size:1.1rem}
  .prayer-time{font-size:1.3rem}
  .countdown-time{font-size:1.5rem}
}
@media(max-width:380px){
  header#appHeader h1{font-size:0.75rem}
  .nav-text{font-size:0.58rem}
  .nav-icon{font-size:1.1rem}
  .nav-item{padding:.25rem .3rem;min-width:45px}
  #pageNum{width:50px}
  .quran-topbar{gap:.3rem}
}
@media(max-height:500px) and (orientation:landscape){
  header#appHeader{padding:.5rem 1rem}
  #imageWrapper{height:calc(100vh - 100px)}
  .bottom-nav{padding:.3rem}
  .nav-item{padding:.3rem .4rem}
}

.hisn-card{
  background:rgba(255,255,255,.95);
  padding:1.2rem;
  border-radius:1rem;
  margin-bottom:1rem;
  border-right:4px solid var(--gold);
  box-shadow:0 4px 12px rgba(0,0,0,.08);
  transition:all .2s;
  position:relative;
}
.theme-night .hisn-card{background:rgba(30,41,59,.95)}
.theme-special .hisn-card{background:rgba(45,90,61,.95)}
.hisn-card:hover{transform:translateX(-3px);box-shadow:0 8px 20px rgba(0,0,0,.12)}

.hisn-title{
  font-size:1.15rem;
  font-weight:800;
  margin-bottom:.8rem;
  color:var(--gold);
  display:flex;
  justify-content:space-between;
  align-items:center;
  flex-wrap:wrap;
  gap:.5rem;
}

.hisn-text{
  font-size:1.05rem;
  line-height:1.9;
  margin-bottom:.6rem;
  text-align:justify;
}

.hisn-footnote{
  font-size:.85rem;
  opacity:.65;
  margin-top:.8rem;
  padding-top:.8rem;
  border-top:1px solid rgba(212,175,55,.2);
}

.hisn-actions{
  display:flex;
  gap:.5rem;
  align-items:center;
  margin-top:1rem;
  flex-wrap:wrap;
}

.counter-box{
  display:flex;
  align-items:center;
  gap:.4rem;
  background:rgba(212,175,55,.1);
  padding:.4rem .7rem;
  border-radius:.6rem;
}

.counter-btn{
  width:32px;
  height:32px;
  display:flex;
  align-items:center;
  justify-content:center;
  background:linear-gradient(135deg,var(--emerald),var(--emerald-dark));
  color:#fff;
  border:none;
  border-radius:.5rem;
  cursor:pointer;
  font-size:1.1rem;
  font-weight:800;
  transition:all .2s;
}
.counter-btn:hover{transform:scale(1.1)}
.counter-btn:active{transform:scale(0.95)}
.counter-btn.reset-counter{background:linear-gradient(135deg,#ef4444,#dc2626)}

.counter-display{
  font-size:1.1rem;
  font-weight:800;
  min-width:40px;
  text-align:center;
  font-family:monospace;
}

.hisn-fav-btn{
  padding:.4rem .8rem;
  background:linear-gradient(135deg,var(--gold),var(--gold-dark));
  color:#111827;
  border:none;
  border-radius:.6rem;
  cursor:pointer;
  font-size:.9rem;
  font-weight:700;
  transition:all .2s;
  white-space:nowrap;
}
.hisn-fav-btn:hover{transform:translateY(-2px)}
.hisn-fav-btn.favorited{
  background:linear-gradient(135deg,var(--emerald),var(--emerald-dark));
  color:#fff;
}

#hisnCategorySelect{
  font-size:1rem;
  cursor:pointer;
  max-width:100%;
  overflow:hidden;
  text-overflow:ellipsis;
}
#hisnCategorySelect option{
  padding:0.5rem;
  white-space:normal;
  word-wrap:break-word;
}
@media(max-width:640px){
  #hisnCategorySelect{
    font-size:0.9rem;
  }
  #hisnCategorySelect option{
    font-size:0.9rem;
  }
}

.no-results{
  text-align:center;
  padding:3rem 1rem;
  font-size:1.1rem;
  opacity:.6;
}

@media(max-width:640px){
  .hisn-card{padding:1rem}
  .hisn-title{font-size:1.05rem}
  .hisn-text{font-size:1rem;line-height:1.8}
  .hisn-footnote{font-size:.8rem}
  .counter-btn{width:28px;height:28px;font-size:1rem}
  .counter-display{font-size:1rem;min-width:35px}
  .tab-btn{padding:.4rem .8rem;font-size:.85rem}
}

</style>
</head>
<body class="theme-day min-h-screen">

<header id="appHeader" class="sticky top-0 z-40 flex items-center justify-between gap-3">
  <div class="flex items-center gap-3">
    <button id="themeToggle" aria-label="تغيير الثيم"><span id="themeIcon">🌞</span></button>
    <a id="whatsappTop" href="https://wa.me/905533331339" target="_blank" aria-label="واتساب" title="تواصل معنا">
      <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.885 3.488"/></svg>
    </a>
    <h1 class="font-bold text-base sm:text-lg">📖 القرآن الكريم – صدقة جارية</h1>
  </div>
  <div class="text-xs sm:text-sm text-right leading-tight">
    <div id="hijriLine" class="opacity-90 font-semibold">—</div>
    <div id="gregLine" class="opacity-75">—</div>
  </div>
</header>

<main>
  <section id="audioSection" class="section active">
    <div class="space-y-4">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="card p-4">
          <h3 class="font-semibold mb-3 text-lg">🕌 اختيار السورة</h3>
          <input id="surahSearch" type="text" placeholder="🔍 ابحث عن سورة..." class="w-full mb-2">
          <select id="surahSelect" class="w-full"></select>
        </div>
        <div class="card p-4">
          <h3 class="font-semibold mb-3 text-lg">🎙️ اختيار القارئ</h3>
          <input id="reciterSearch" type="text" placeholder="🔍 ابحث عن قارئ..." class="w-full mb-2">
          <select id="reciterSelect" class="w-full"></select>
        </div>
      </div>
      <div class="card p-4">
        <h3 class="font-semibold mb-3 text-lg">⚙️ إعدادات التشغيل</h3>
        <div class="space-y-3">
          <div class="flex flex-wrap gap-4">
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="radio" name="mode" value="single" checked>
              <span>قارئ واحد</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="radio" name="mode" value="multi">
              <span>عدة قراء</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="checkbox" id="loopToggle">
              <span>تكرار السورة</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="checkbox" id="autoPlayToggle" checked>
              <span>تشغيل تلقائي</span>
            </label>
          </div>
          <div class="flex flex-wrap gap-2 items-center">
            <select id="juzAudioSelect" class="btn btn-emerald text-sm" style="min-width:150px;">
              <option value="">📗 اختر جزء كامل</option>
              <option value="1">الجزء 1</option>
              <option value="2">الجزء 2</option>
              <option value="3">الجزء 3</option>
              <option value="4">الجزء 4</option>
              <option value="5">الجزء 5</option>
              <option value="6">الجزء 6</option>
              <option value="7">الجزء 7</option>
              <option value="8">الجزء 8</option>
              <option value="9">الجزء 9</option>
              <option value="10">الجزء 10</option>
              <option value="11">الجزء 11</option>
              <option value="12">الجزء 12</option>
              <option value="13">الجزء 13</option>
              <option value="14">الجزء 14</option>
              <option value="15">الجزء 15</option>
              <option value="16">الجزء 16</option>
              <option value="17">الجزء 17</option>
              <option value="18">الجزء 18</option>
              <option value="19">الجزء 19</option>
              <option value="20">الجزء 20</option>
              <option value="21">الجزء 21</option>
              <option value="22">الجزء 22</option>
              <option value="23">الجزء 23</option>
              <option value="24">الجزء 24</option>
              <option value="25">الجزء 25</option>
              <option value="26">الجزء 26</option>
              <option value="27">الجزء 27</option>
              <option value="28">الجزء 28</option>
              <option value="29">الجزء 29</option>
              <option value="30">الجزء 30</option>
            </select>
          </div>
          <div class="flex flex-wrap gap-2 items-center pt-2 border-t border-opacity-20">
            <span class="text-sm font-medium">⏱️ مؤقّت النوم (دقائق):</span>
            <input id="sleepSeconds" type="number" min="0" step="1" placeholder="دقائق" class="w-24 text-center">
            <button id="sleepSet" class="btn btn-emerald text-sm">تفعيل</button>
            <button id="sleepCancel" class="btn btn-danger text-sm">إلغاء</button>
            <span id="sleepStatus" class="text-sm font-bold text-emerald-600"></span>
          </div>
        </div>
      </div>
      <div class="flex gap-3"><button id="addBtn" class="flex-1 btn btn-gold">➕ إضافة للمشغّل</button></div>
      <div class="card p-4">
        <div class="flex items-center justify-between mb-3"><h3 class="font-semibold text-lg">🎵 المشغّل</h3></div>
        <div class="audio-player">
          <div id="playerBox" class="text-center mb-3">
            <div class='text-gray-500'>اختر سورة للبدء</div>
          </div>
          <div class="flex items-center justify-center gap-3 mt-3">
            <button id="rewind10" class="btn btn-emerald px-4 py-2 text-sm">⟲ 10</button>
            <div class="text-center text-sm opacity-75">
              <span id="timeNow">00:00</span> / <span id="timeTotal">00:00</span>
            </div>
            <button id="forward10" class="btn btn-emerald px-4 py-2 text-sm">10 ⟳</button>
          </div>
          <div id="sleepStatusPlayer" class="text-xs mt-2 text-emerald-500 font-bold text-center"></div>
        </div>
      </div>
      <div class="card p-4">
        <div class="flex items-center justify-between mb-3">
          <h3 class="font-semibold text-lg">📋 قائمة التشغيل</h3>
          <button id="clearBtn" class="btn btn-danger text-sm">🗑️ مسح الكل</button>
        </div>
        <ul id="playlist" class="space-y-2"></ul>
      </div>
    </div>
  </section>

  <section id="quranSection" class="section">
    <div class="quran-topbar">
      <button id="openSurahModal" class="flex-1 btn btn-gold flex items-center justify-between px-3 py-2 rounded-lg">
        <span id="currentSurahLabel">📖 سورة الفاتحة</span>
        <span class="opacity-80">▾</span>
      </button>
      <select id="juzSelect" class="btn btn-emerald px-3 py-2 rounded-lg text-sm font-bold" style="min-width:120px;">
        <option value="">📗 اختر الجزء</option>
        <option value="1">الجزء 1</option>
        <option value="2">الجزء 2</option>
        <option value="3">الجزء 3</option>
        <option value="4">الجزء 4</option>
        <option value="5">الجزء 5</option>
        <option value="6">الجزء 6</option>
        <option value="7">الجزء 7</option>
        <option value="8">الجزء 8</option>
        <option value="9">الجزء 9</option>
        <option value="10">الجزء 10</option>
        <option value="11">الجزء 11</option>
        <option value="12">الجزء 12</option>
        <option value="13">الجزء 13</option>
        <option value="14">الجزء 14</option>
        <option value="15">الجزء 15</option>
        <option value="16">الجزء 16</option>
        <option value="17">الجزء 17</option>
        <option value="18">الجزء 18</option>
        <option value="19">الجزء 19</option>
        <option value="20">الجزء 20</option>
        <option value="21">الجزء 21</option>
        <option value="22">الجزء 22</option>
        <option value="23">الجزء 23</option>
        <option value="24">الجزء 24</option>
        <option value="25">الجزء 25</option>
        <option value="26">الجزء 26</option>
        <option value="27">الجزء 27</option>
        <option value="28">الجزء 28</option>
        <option value="29">الجزء 29</option>
        <option value="30">الجزء 30</option>
      </select>
      <button id="khitmahBtn" class="btn btn-emerald px-3 py-2 whitespace-nowrap rounded-lg text-sm">📗 <span id="khitmahLabel">تفعيل الختمة</span></button>
      <button id="resetKhitmahBtn" class="btn btn-danger px-3 py-2 whitespace-nowrap rounded-lg text-sm">♻️ إعادة الختمة</button>
      <div class="flex items-center gap-2 w-full">
        <div class="flex items-center gap-2">
          <span class="text-sm opacity-80">📄</span>
          <input id="pageNum" type="number" min="1" max="604" value="1" class="w-14 text-center border rounded-md py-1 px-1 text-sm"/>
          <span class="text-sm opacity-75">/ 604</span>
          <button id="favPageBtn" title="إضافة للمفضلة">⭐</button>
          <button id="jumpLastBtn" class="btn btn-gold px-2 py-1 text-sm rounded-lg" title="آخر صفحة">📍</button>
        </div>
        <button id="fullscreenBtn" class="btn btn-gold px-3 py-2 whitespace-nowrap rounded-lg text-sm">ملء الشاشة</button>
      </div>
    </div>
    <div class="relative">
      <div id="imageWrapper">
        <div id="pageReadBadge" class="read-check">✅ مقروءة</div>
        <img id="quranPage" src="https://raw.githubusercontent.com/SadakaJaria/qurankareem/main/images/1.png" alt="صفحة قرآن" loading="lazy">
        <div id="loadingOverlay" class="absolute inset-0 bg-black bg-opacity-40 hidden items-center justify-center"><div class="loading-spinner"></div></div>
        <button id="readingFloatBtn" class="float-btn hide" title="تأكيد قراءة الصفحة">✔</button>
      </div>
      <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 bg-black bg-opacity-70 text-white px-3 py-1 rounded-full text-sm">صفحة <span id="currentPageIndicator">1</span></div>
    </div>
    <div class="mt-4 grid grid-cols-3 gap-3">
      <div class="stat-card"><span class="stat-number" id="statRead">0</span><span class="stat-label">مقروءة</span></div>
      <div class="stat-card"><span class="stat-number" id="statPercent">0%</span><span class="stat-label">نسبة الإنجاز</span></div>
      <div class="stat-card"><span class="stat-number" id="statRemaining">604</span><span class="stat-label">متبقي</span></div>
    </div>
    <div id="surahModal" class="modal-mask hidden">
      <div class="modal">
        <div class="modal-header">اختر السورة</div>
        <div class="modal-body"><ul id="surahList" class="space-y-2"></ul></div>
        <button id="closeSurahModal" class="modal-close">إغلاق</button>
      </div>
    </div>
  </section>

  <section id="prayerSection" class="section">
    <div class="card p-4 mb-4">
      <h2 class="font-bold text-2xl mb-4 text-center">🕌 مواقيت الصلاة</h2>
      
      <div class="mb-4">
        <div class="flex flex-wrap gap-2 items-center justify-center mb-3">
          <button id="detectLocationBtn" class="btn btn-emerald">📍 تحديد الموقع تلقائياً</button>
          <button id="manualCityBtn" class="btn btn-gold">🏙️ اختيار المدينة يدوياً</button>
        </div>
        <div id="currentLocation" class="text-center text-lg font-bold mb-2"></div>
      </div>

      <div id="prayerTimesContainer" class="space-y-3">
        <div class="text-center py-8 opacity-70">
          <p class="text-lg">📍 اضغط على "تحديد الموقع" لعرض مواقيت الصلاة</p>
        </div>
      </div>

      <div id="countdownContainer" class="hidden">
        <div class="countdown-box">
          <div class="countdown-label">الوقت المتبقي للصلاة القادمة</div>
          <div class="countdown-time" id="prayerCountdown">--:--:--</div>
        </div>
      </div>

      <div class="mt-4">
        <label class="flex items-center gap-2 cursor-pointer justify-center">
          <input type="checkbox" id="notificationToggle">
          <span class="font-bold">🔔 تفعيل إشعارات الأذان</span>
        </label>
        <div id="notificationStatus" class="text-center text-sm mt-2 opacity-75"></div>
      </div>
    </div>

    <div id="cityModal" class="modal-mask hidden">
      <div class="modal">
        <div class="modal-header">اختر المدينة</div>
        <div class="modal-body">
          <input id="citySearchInput" type="text" placeholder="🔍 ابحث عن مدينة..." class="w-full mb-3">
          <ul id="cityList" class="space-y-2"></ul>
        </div>
        <button id="closeCityModal" class="modal-close">إغلاق</button>
      </div>
    </div>
  </section>

  <section id="hisnSection" class="section">
    <div class="card p-4 mb-4">
      <h2 class="font-bold text-2xl mb-4 text-center">🤲 حصن المسلم</h2>
      
      <div class="mb-4 space-y-3">
        <input type="text" id="hisnSearchInput" placeholder="🔍 ابحث في الأذكار..." 
               class="w-full p-3 border-2 border-gold-300 rounded-lg text-base font-semibold focus:outline-none focus:border-gold-500 focus:ring-2 focus:ring-gold-200">
        
        <div class="flex gap-2 items-center w-full">
          <label class="font-bold text-sm whitespace-nowrap flex-shrink-0">📑 الفئة:</label>
          <select id="hisnCategorySelect" class="flex-1 min-w-0 p-2 border-2 border-gold-300 rounded-lg font-semibold bg-white" style="max-width: 100%;">
            <option value="">جميع الفئات (134)</option>
          </select>
        </div>
      </div>
    </div>

    <div id="hisnContent" class="space-y-4"></div>
  </section>

  <section id="hadithSection" class="section">
    <div class="card p-4 mb-4">
      <h2 class="font-bold text-xl mb-4">📚 الأحاديث النبوية الشريفة</h2>
      <div class="space-y-3">
        <select id="hadithBookSelect" class="w-full">
          <option value="">-- اختر الكتاب --</option>
          <option value="bukhari">صحيح البخاري</option>
          <option value="muslim">صحيح مسلم</option>
          <option value="abudawud">سنن أبي داود</option>
          <option value="tirmidhi">جامع الترمذي</option>
          <option value="nasai">سنن النسائي</option>
          <option value="ibnmajah">سنن ابن ماجه</option>
          <option value="malik">موطأ مالك</option>
          <option value="nawawi">الأربعون النووية</option>
        </select>
        
        <div class="flex gap-2">
          <input id="hadithSearchInput" type="text" placeholder="🔍 ابحث في الأحاديث..." class="flex-1">
          <button id="hadithSearchBtn" class="btn btn-emerald px-4">بحث</button>
        </div>
        
        <div class="flex gap-2 items-center flex-wrap">
          <span class="text-sm font-medium">رقم الحديث:</span>
          <input id="hadithNumberInput" type="number" min="1" placeholder="مثال: 1" class="w-28 text-center">
          <button id="loadHadithBtn" class="btn btn-gold px-4">عرض</button>
          <button id="randomHadithBtn" class="btn btn-emerald px-2 text-sm">📜 عشوائي</button>
        </div>
      </div>
    </div>
    
    <div id="hadithLoadingMsg" class="text-center py-4 hidden">
      <div class="loading-spinner mx-auto mb-2"></div>
      <p class="text-sm opacity-75">جاري التحميل...</p>
    </div>
    
    <div id="hadithContainer" class="space-y-4"></div>
    
    <div id="hadithEmptyMsg" class="card p-6 text-center opacity-75">
      <p class="text-lg">اختر كتاباً وابدأ بتصفح الأحاديث الشريفة 📖</p>
    </div>
  </section>

  <section id="favoritesSection" class="section">
    <div class="card p-4">
      <div class="flex items-center justify-between mb-3">
        <h3 class="font-semibold text-lg">⭐ المفضلة (استماع)</h3>
        <button id="clearFavBtn" class="btn btn-danger text-sm">🗑️ مسح الكل</button>
      </div>
      <ul id="favorites" class="space-y-2 mb-6"></ul>
      <div class="border-t pt-4 mt-4">
        <h4 class="font-semibold mb-3 text-base">⭐ صفحات مفضلة</h4>
        <ul id="favoritesPages" class="space-y-2"></ul>
      </div>
      <div class="border-t pt-4 mt-4">
        <div class="flex items-center justify-between mb-3">
          <h4 class="font-semibold text-base">⭐ أحاديث مفضلة</h4>
          <button id="clearFavHadithBtn" class="btn btn-danger text-sm px-2 py-1">🗑️ مسح</button>
        </div>
        <ul id="favoritesHadith" class="space-y-2"></ul>
      </div>
    </div>
  </section>
</main>

<nav class="bottom-nav" id="bottomNav">
  <div class="nav-container">
    <div class="nav-item active" id="navAudio" data-section="audioSection"><div class="nav-icon">📊</div><div class="nav-text">الاستماع</div></div>
    <div class="nav-item" id="navQuran" data-section="quranSection"><div class="nav-icon">📖</div><div class="nav-text">المصحف</div></div>
    <div class="nav-item" id="navPrayer" data-section="prayerSection"><div class="nav-icon">🕌</div><div class="nav-text">المواقيت</div></div>
    <div class="nav-item" id="navHisn" data-section="hisnSection"><div class="nav-icon">🤲</div><div class="nav-text">حصن المسلم</div></div>
    <div class="nav-item" id="navHadith" data-section="hadithSection"><div class="nav-icon">📚</div><div class="nav-text">الأحاديث</div></div>
    <div class="nav-item" id="navFavorites" data-section="favoritesSection"><div class="nav-icon">⭐</div><div class="nav-text">المفضلة</div></div>
  </div>
</nav>

<script>
const NIGHT_START=19,NIGHT_END=6;
const TOTAL_PAGES=604;
const HADITH_API_BASE="https://cdn.jsdelivr.net/gh/fawazahmed0/hadith-api@1/editions";

const CITIES=[
  {name:"إسطنبول، تركيا",lat:41.0082,lng:28.9784,country:"TR"},
  {name:"أنقرة، تركيا",lat:39.9334,lng:32.8597,country:"TR"},
  {name:"إزمير، تركيا",lat:38.4237,lng:27.1428,country:"TR"},
  {name:"بورصة، تركيا",lat:40.1828,lng:29.0667,country:"TR"},
  {name:"أنطاليا، تركيا",lat:36.8969,lng:30.7133,country:"TR"},
  {name:"القاهرة، مصر",lat:30.0444,lng:31.2357,country:"EG"},
  {name:"الإسكندرية، مصر",lat:31.2001,lng:29.9187,country:"EG"},
  {name:"الجيزة، مصر",lat:30.0131,lng:31.2089,country:"EG"},
  {name:"الرياض، السعودية",lat:24.7136,lng:46.6753,country:"SA"},
  {name:"جدة، السعودية",lat:21.5433,lng:39.1728,country:"SA"},
  {name:"مكة المكرمة، السعودية",lat:21.3891,lng:39.8579,country:"SA"},
  {name:"المدينة المنورة، السعودية",lat:24.5247,lng:39.5692,country:"SA"},
  {name:"الدمام، السعودية",lat:26.4207,lng:50.0888,country:"SA"},
  {name:"الطائف، السعودية",lat:21.2703,lng:40.4150,country:"SA"},
  {name:"تبوك، السعودية",lat:28.3838,lng:36.5550,country:"SA"},
  {name:"دبي، الإمارات",lat:25.2048,lng:55.2708,country:"AE"},
  {name:"أبوظبي، الإمارات",lat:24.4539,lng:54.3773,country:"AE"},
  {name:"الشارقة، الإمارات",lat:25.3463,lng:55.4209,country:"AE"},
  {name:"العين، الإمارات",lat:24.2075,lng:55.7447,country:"AE"},
  {name:"بيروت، لبنان",lat:33.8886,lng:35.4955,country:"LB"},
  {name:"طرابلس، لبنان",lat:34.4333,lng:35.8333,country:"LB"},
  {name:"صيدا، لبنان",lat:33.5630,lng:35.3688,country:"LB"},
  {name:"عمان، الأردن",lat:31.9454,lng:35.9284,country:"JO"},
  {name:"إربد، الأردن",lat:32.5556,lng:35.8500,country:"JO"},
  {name:"الزرقاء، الأردن",lat:32.0728,lng:36.0881,country:"JO"},
  {name:"دمشق، سوريا",lat:33.5138,lng:36.2765,country:"SY"},
  {name:"حلب، سوريا",lat:36.2021,lng:37.1343,country:"SY"},
  {name:"حمص، سوريا",lat:34.7333,lng:36.7167,country:"SY"},
  {name:"بغداد، العراق",lat:33.3152,lng:44.3661,country:"IQ"},
  {name:"الموصل، العراق",lat:36.3350,lng:43.1189,country:"IQ"},
  {name:"البصرة، العراق",lat:30.5085,lng:47.7835,country:"IQ"},
  {name:"أربيل، العراق",lat:36.1911,lng:44.0091,country:"IQ"},
  {name:"الكويت، الكويت",lat:29.3759,lng:47.9774,country:"KW"},
  {name:"المنامة، البحرين",lat:26.0667,lng:50.5577,country:"BH"},
  {name:"الدوحة، قطر",lat:25.2854,lng:51.5310,country:"QA"},
  {name:"مسقط، عمان",lat:23.5880,lng:58.3829,country:"OM"},
  {name:"صلالة، عمان",lat:17.0150,lng:54.0924,country:"OM"},
  {name:"صنعاء، اليمن",lat:15.3694,lng:44.1910,country:"YE"},
  {name:"عدن، اليمن",lat:12.8654,lng:45.0367,country:"YE"},
  {name:"تعز، اليمن",lat:13.5796,lng:44.0172,country:"YE"},
  {name:"الدار البيضاء، المغرب",lat:33.5731,lng:-7.5898,country:"MA"},
  {name:"الرباط، المغرب",lat:34.0209,lng:-6.8416,country:"MA"},
  {name:"فاس، المغرب",lat:34.0181,lng:-5.0078,country:"MA"},
  {name:"مراكش، المغرب",lat:31.6295,lng:-7.9811,country:"MA"},
  {name:"طنجة، المغرب",lat:35.7595,lng:-5.8340,country:"MA"},
  {name:"الجزائر، الجزائر",lat:36.7538,lng:3.0588,country:"DZ"},
  {name:"وهران، الجزائر",lat:35.6969,lng:-0.6331,country:"DZ"},
  {name:"قسنطينة، الجزائر",lat:36.3650,lng:6.6147,country:"DZ"},
  {name:"تونس، تونس",lat:36.8065,lng:10.1815,country:"TN"},
  {name:"صفاقس، تونس",lat:34.7406,lng:10.7603,country:"TN"},
  {name:"طرابلس، ليبيا",lat:32.8872,lng:13.1913,country:"LY"},
  {name:"بنغازي، ليبيا",lat:32.1191,lng:20.0869,country:"LY"},
  {name:"الخرطوم، السودان",lat:15.5007,lng:32.5599,country:"SD"},
  {name:"أم درمان، السودان",lat:15.6452,lng:32.4777,country:"SD"},
  {name:"رام الله، فلسطين",lat:31.9038,lng:35.2034,country:"PS"},
  {name:"غزة، فلسطين",lat:31.3547,lng:34.3088,country:"PS"},
  {name:"الخليل، فلسطين",lat:31.5326,lng:35.0998,country:"PS"},
  {name:"نابلس، فلسطين",lat:32.2211,lng:35.2544,country:"PS"},
  {name:"لندن، بريطانيا",lat:51.5074,lng:-0.1278,country:"GB"},
  {name:"مانشستر، بريطانيا",lat:53.4808,lng:-2.2426,country:"GB"},
  {name:"برمنغهام، بريطانيا",lat:52.4862,lng:-1.8904,country:"GB"},
  {name:"باريس، فرنسا",lat:48.8566,lng:2.3522,country:"FR"},
  {name:"مارسيليا، فرنسا",lat:43.2965,lng:5.3698,country:"FR"},
  {name:"ليون، فرنسا",lat:45.7640,lng:4.8357,country:"FR"},
  {name:"برلين، ألمانيا",lat:52.5200,lng:13.4050,country:"DE"},
  {name:"ميونخ، ألمانيا",lat:48.1351,lng:11.5820,country:"DE"},
  {name:"فرانكفورت، ألمانيا",lat:50.1109,lng:8.6821,country:"DE"},
  {name:"روما، إيطاليا",lat:41.9028,lng:12.4964,country:"IT"},
  {name:"ميلانو، إيطاليا",lat:45.4642,lng:9.1900,country:"IT"},
  {name:"مدريد، إسبانيا",lat:40.4168,lng:-3.7038,country:"ES"},
  {name:"برشلونة، إسبانيا",lat:41.3851,lng:2.1734,country:"ES"},
  {name:"نيويورك، أمريكا",lat:40.7128,lng:-74.0060,country:"US"},
  {name:"لوس أنجلوس، أمريكا",lat:34.0522,lng:-118.2437,country:"US"},
  {name:"شيكاغو، أمريكا",lat:41.8781,lng:-87.6298,country:"US"},
  {name:"هيوستن، أمريكا",lat:29.7604,lng:-95.3698,country:"US"},
  {name:"ديترويت، أمريكا",lat:42.3314,lng:-83.0458,country:"US"},
  {name:"تورنتو، كندا",lat:43.6532,lng:-79.3832,country:"CA"},
  {name:"مونتريال، كندا",lat:45.5017,lng:-73.5673,country:"CA"},
  {name:"سيدني، أستراليا",lat:-33.8688,lng:151.2093,country:"AU"},
  {name:"ملبورن، أستراليا",lat:-37.8136,lng:144.9631,country:"AU"}
];

const RECITERS=[
  {slug:"maher",name:"الشيخ ماهر المعيقلي",base:"https://server12.mp3quran.net/maher"},
  {slug:"ajm",name:"الشيخ أحمد بن علي العجمي",base:"https://server10.mp3quran.net/ajm"},
  {slug:"basit_mj",name:"الشيخ عبدالباسط عبدالصمد (المجوّد)",base:"https://server7.mp3quran.net/basit/Almusshaf-Al-Mojawwad"},
  {slug:"afs",name:"الشيخ مشاري بن راشد العفاسي",base:"https://server8.mp3quran.net/afs"},
  {slug:"sgmd",name:"الشيخ سعد الغامدي",base:"https://server7.mp3quran.net/s_gmd"},
  {slug:"husr",name:"الشيخ محمود خليل الحصري",base:"https://server13.mp3quran.net/husr"},
  {slug:"shur",name:"الشيخ سعود الشريم",base:"https://server7.mp3quran.net/shur"},
  {slug:"shatri",name:"الشيخ أبو بكر الشاطري",base:"https://server11.mp3quran.net/shatri"},
  {slug:"minsh",name:"الشيخ محمد صديق المنشاوي",base:"https://server10.mp3quran.net/minsh"},
  {slug:"sds",name:"الشيخ عبدالرحمن السديس",base:"https://server11.mp3quran.net/sds"}
];

const HADITH_BOOKS={
  bukhari:{name:"صحيح البخاري",edition:"ara-bukhari",total:7563},
  muslim:{name:"صحيح مسلم",edition:"ara-muslim",total:7563},
  abudawud:{name:"سنن أبي داود",edition:"ara-abudawud",total:5274},
  tirmidhi:{name:"جامع الترمذي",edition:"ara-tirmidhi",total:3956},
  nasai:{name:"سنن النسائي",edition:"ara-nasai",total:5758},
  ibnmajah:{name:"سنن ابن ماجه",edition:"ara-ibnmajah",total:4341},
  malik:{name:"موطأ مالك",edition:"ara-malik",total:1874},
  nawawi:{name:"الأربعون النووية",edition:"ara-nawawi",total:42}
};

const PRAYER_NAMES={
  Fajr:"الفجر",
  Sunrise:"الشروق",
  Dhuhr:"الظهر",
  Asr:"العصر",
  Maghrib:"المغرب",
  Isha:"العشاء"
};

const pad3=n=>String(n).padStart(3,"0");
let chapters=[];
let currentHadithData=null;
let prayerInterval=null;
let notificationCheckInterval=null;

const state={
  playlist:[],
  favorites:[],
  idx:0,
  mode:"single",
  loop:false,
  autoPlay:true,
  sleepTimeout:null,
  sleepInterval:null,
  sleepRemaining:0,
  currentSection:'audioSection',
  lastPage:parseInt(localStorage.getItem('last_quran_page')||'1'),
  lastAudio:JSON.parse(localStorage.getItem('last_audio_meta')||'null'),
  khitmahEnabled:JSON.parse(localStorage.getItem('khitmah_enabled')||'false'),
  khitmahReading:JSON.parse(localStorage.getItem('khitmah_reading_progress')||'{}'),
  favoritesPages:JSON.parse(localStorage.getItem('favorites_pages')||'[]'),
  favoritesHadith:JSON.parse(localStorage.getItem('favorites_hadith')||'[]'),
  currentHadithBook:'',
  searchResults:[],
  displayedCount:0,
  allSurahs:[],
  allReciters:RECITERS,
  prayerTimes:null,
  currentCity:JSON.parse(localStorage.getItem('selected_city')||'null'),
  notificationsEnabled:JSON.parse(localStorage.getItem('notifications_enabled')||'false'),
  notifiedPrayers:JSON.parse(localStorage.getItem('notified_prayers')||'{}')
};

function showToast(m,d=2500){
  const t=document.createElement('div');
  t.className='toast';
  t.textContent=m;
  document.body.appendChild(t);
  setTimeout(()=>{
    t.style.opacity='0';
    setTimeout(()=>t.remove(),300);
  },d);
}

const THEMES=["day","night","special"];
let ti=0;

function applyTheme(th){
  document.body.classList.remove("theme-day","theme-night","theme-special");
  document.body.classList.add("theme-"+th);
  localStorage.setItem('theme_choice',th);
  const icon=th==='day'?"🌞":th==='night'?"🌙":"✨";
  document.getElementById('themeIcon').textContent=icon;
}

function initTheme(){
  const saved=localStorage.getItem('theme_choice');
  if(saved){
    applyTheme(saved);
    ti=THEMES.indexOf(saved);
  }else{
    const h=new Date().getHours();
    const night=(h>=NIGHT_START||h<NIGHT_END);
    applyTheme(night?"night":"day");
    ti=night?1:0;
  }
}

async function updateClock(){
  const d=new Date();
  const g=`${String(d.getDate()).padStart(2,'0')}-${String(d.getMonth()+1).padStart(2,'0')}-${d.getFullYear()}`;
  const t=`${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
  document.getElementById('gregLine').innerText=`${g} | ${t}`;
  
  try{
    const r=await fetch(`https://api.aladhan.com/v1/gToH?date=${g}`);
    const j=await r.json();
    const h=j.data.hijri;
    document.getElementById('hijriLine').innerText=`${h.day} ${h.month.ar} ${h.year} هـ`;
  }catch{
    document.getElementById('hijriLine').innerText='(التاريخ الهجري غير متاح)';
  }
}

async function fetchChapters(){
  try{
    const r=await fetch("https://api.quran.com/api/v4/chapters");
    const j=await r.json();
    chapters=j.chapters||[];
    state.allSurahs=chapters;
  }catch(err){
    console.error('خطأ في جلب السور:',err);
    chapters=[...Array(114)].map((_,i)=>({
      id:i+1,
      name_arabic:`سورة ${i+1}`
    }));
    state.allSurahs=chapters;
  }
  
  populateSurahSelect();
  populateReciterSelect();
  
  const first=chapters[0];
  if(first){
    document.getElementById('currentSurahLabel').textContent=`📖 ${first.name_arabic}`;
  }
  
  populateSurahList();
}

function populateSurahSelect(filter=''){
  const surahOptions=state.allSurahs
    .filter(c=>c.name_arabic.includes(filter))
    .map(c=>`<option value="${c.id}">${c.id}. ${c.name_arabic}</option>`)
    .join("");
  document.getElementById('surahSelect').innerHTML=surahOptions;
}

function populateReciterSelect(filter=''){
  const reciterOptions=state.allReciters
    .filter(r=>r.name.includes(filter))
    .map(r=>`<option value="${r.slug}">${r.name}</option>`)
    .join("");
  document.getElementById('reciterSelect').innerHTML=reciterOptions;
}

const SURAH_START_PAGES={
  1:1,2:2,3:50,4:77,5:106,6:128,7:151,8:177,9:187,10:208,
  11:221,12:235,13:249,14:255,15:262,16:267,17:282,18:293,19:305,20:312,
  21:322,22:332,23:342,24:350,25:359,26:367,27:377,28:385,29:396,30:404,
  31:411,32:415,33:418,34:428,35:434,36:440,37:446,38:453,39:458,40:467,
  41:477,42:483,43:489,44:496,45:499,46:502,47:507,48:511,49:515,50:518,
  51:520,52:523,53:526,54:528,55:531,56:534,57:537,58:542,59:545,60:549,
  61:551,62:553,63:554,64:556,65:558,66:560,67:562,68:564,69:566,70:568,
  71:570,72:572,73:574,74:575,75:577,76:579,77:581,78:583,79:585,80:587,
  81:589,82:590,83:591,84:593,85:594,86:595,87:596,88:597,89:599,90:600,
  91:601,92:602,93:602,94:603,95:603,96:603,97:603,98:598,99:603,100:601,
  101:602,102:602,103:603,104:601,105:601,106:601,107:602,108:602,109:603,110:603,111:604,112:604,113:604,114:604
};

const JUZ_START_PAGES={
  1:1,2:22,3:42,4:62,5:82,6:102,7:121,8:142,9:162,10:182,
  11:201,12:222,13:242,14:262,15:282,16:302,17:322,18:342,19:362,20:382,
  21:402,22:422,23:442,24:462,25:482,26:502,27:522,28:542,29:562,30:582
};

function setActiveSection(id){
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  document.querySelector(`[data-section="${id}"]`).classList.add('active');
  
  state.currentSection=id;
  updateReadingButton();
}

const imgEl=()=>document.getElementById('quranPage');
const pageInput=()=>document.getElementById('pageNum');
const readBadge=()=>document.getElementById('pageReadBadge');
const loadingOverlay=()=>document.getElementById('loadingOverlay');

function applyPageReadVisual(){
  const p=parseInt(pageInput().value||'1');
  const isRead=!!(state.khitmahReading&&state.khitmahReading[p]);
  const img=imgEl();
  
  if(isRead){
    img.classList.add('read-mark');
    readBadge().style.display='inline-block';
  }else{
    img.classList.remove('read-mark');
    readBadge().style.display='none';
  }
}

function loadPage(n,byUser=true){
  const p=Math.max(1,Math.min(TOTAL_PAGES,parseInt(n)||1));
  pageInput().value=p;
  document.getElementById('currentPageIndicator').textContent=p;
  
  const el=imgEl();
  const src=`https://raw.githubusercontent.com/SadakaJaria/qurankareem/main/images/${p}.png`;
  
  if(el.src!==src){
    el.classList.add('loading');
    const overlay=loadingOverlay();
    overlay.classList.remove('hidden');
    overlay.classList.add('flex');
    
    el.src=src;
    el.onload=()=>{
      el.classList.remove('loading');
      overlay.classList.add('hidden');
      overlay.classList.remove('flex');
    };
    
    el.onerror=()=>{
      el.classList.remove('loading');
      overlay.classList.add('hidden');
      showToast('⚠️ خطأ في تحميل الصفحة');
    };
  }
  
  if(byUser){
    localStorage.setItem('last_quran_page',String(p));
    state.lastPage=p;
  }
  
  updateReadingButton();
  applyPageReadVisual();
}

function nextPage(){loadPage((parseInt(pageInput().value)||1)+1)}
function prevPage(){loadPage((parseInt(pageInput().value)||1)-1)}

function jumpToLastPage(){
  if(state.lastPage&&state.lastPage!==parseInt(pageInput().value)){
    loadPage(state.lastPage,true);
    showToast(`📍 تم القفز للصفحة ${state.lastPage}`);
  }else{
    showToast('أنت بالفعل في آخر صفحة قرأتها');
  }
}

function openModal(){document.getElementById('surahModal').classList.remove('hidden')}
function closeModal(){document.getElementById('surahModal').classList.add('hidden')}

function populateSurahList(){
  const ul=document.getElementById('surahList');
  if(!ul||!chapters.length)return;
  
  ul.innerHTML='';
  chapters.forEach(ch=>{
    const li=document.createElement('li');
    li.className="p-3 bg-gray-100 hover:bg-gray-200 rounded-lg cursor-pointer transition font-medium";
    li.style.color='#111827';
    li.innerHTML=`${ch.id}. ${ch.name_arabic}`;
    li.onclick=()=>{
      const target=SURAH_START_PAGES[ch.id]||1;
      document.getElementById('currentSurahLabel').textContent=`📖 ${ch.name_arabic}`;
      closeModal();
      loadPage(target,true);
      showToast(`تم فتح ${ch.name_arabic} (صفحة ${target})`);
    };
    ul.appendChild(li);
  });
}

function initSwipe(){
  const w=document.getElementById('imageWrapper');
  let sx=0,sy=0,t=false;
  
  w.addEventListener('touchstart',e=>{
    const c=e.changedTouches[0];
    sx=c.clientX;sy=c.clientY;t=true;
  },{passive:true});
  
  w.addEventListener('touchmove',()=>{},{passive:true});
  
  w.addEventListener('touchend',e=>{
    if(!t)return;t=false;
    const c=e.changedTouches[0];
    const dx=c.clientX-sx,dy=c.clientY-sy;
    
    if(Math.abs(dx)>Math.abs(dy)&&Math.abs(dx)>40){
      if(dx>0)nextPage();else prevPage();
    }
  });
  
  let lock=false;
  w.addEventListener('wheel',e=>{
    if(lock)return;lock=true;
    setTimeout(()=>lock=false,220);
    
    if(e.deltaY>0)nextPage();
    if(e.deltaY<0)prevPage();
  },{passive:true});
  
  document.addEventListener('keydown',e=>{
    if(state.currentSection!=='quranSection')return;
    if(e.key==='ArrowRight')nextPage();
    if(e.key==='ArrowLeft')prevPage();
  });
}

function persist(){
  localStorage.setItem('playlist',JSON.stringify(state.playlist));
  localStorage.setItem('favorites',JSON.stringify(state.favorites));
  localStorage.setItem('favorites_pages',JSON.stringify(state.favoritesPages));
  localStorage.setItem('favorites_hadith',JSON.stringify(state.favoritesHadith));
}

function fmt(s){
  s=Math.floor(s||0);
  const m=Math.floor(s/60);
  const ss=String(s%60).padStart(2,'0');
  return `${m}:${ss}`;
}

function addFavFromPlaylist(i){
  const item=state.playlist[i];
  if(!item)return;
  
  const exists=state.favorites.some(f=>f.src===item.src);
  if(!exists){
    state.favorites.unshift(item);
    persist();
    renderFavorites();
    showToast('⭐ تم الإضافة للمفضلة');
  }else{
    showToast('موجود مسبقاً في المفضلة');
  }
}

function addCurrentPageToFavorites(){
  const p=parseInt(document.getElementById('pageNum').value||'1');
  
  if(!p||p<1||p>604){
    showToast('رقم صفحة غير صالح');
    return;
  }
  
  if(state.favoritesPages.includes(p)){
    showToast('هذه الصفحة موجودة بالفعل في المفضلة');
    return;
  }
  
  state.favoritesPages.unshift(p);
  persist();
  renderFavoritesPages();
  
  const btn=document.getElementById('favPageBtn');
  btn.classList.add('favorited');
  setTimeout(()=>btn.classList.remove('favorited'),500);
  
  showToast(`⭐ تم إضافة الصفحة ${p} للمفضلة`);
}

function removeFavPageAt(i){
  const pg=state.favoritesPages[i];
  state.favoritesPages.splice(i,1);
  persist();
  renderFavoritesPages();
  if(pg)showToast(`تم حذف الصفحة ${pg} من المفضلة`);
}

function openFavPage(p){
  setActiveSection('quranSection');
  loadPage(p,true);
  showToast(`فتح صفحة ${p}`);
}

function renderFavoritesPages(){
  const ul=document.getElementById('favoritesPages');
  if(!ul)return;
  
  if(!state.favoritesPages.length){
    ul.innerHTML='<li class="text-sm opacity-70 p-3">لا توجد صفحات مفضلة بعد</li>';
    return;
  }
  
  ul.innerHTML='';
  state.favoritesPages.forEach((p,i)=>{
    const li=document.createElement('li');
    li.className='flex justify-between items-center bg-white bg-opacity-10 backdrop-blur px-4 py-3 rounded-lg playlist-item';
    
    const pageDiv=document.createElement('div');
    pageDiv.className='font-medium';
    pageDiv.textContent=`⭐ صفحة ${p}`;
    
    const btnContainer=document.createElement('div');
    btnContainer.className='flex items-center gap-2';
    
    const openBtn=document.createElement('button');
    openBtn.className='btn btn-gold text-sm px-3 py-1';
    openBtn.textContent='فتح';
    openBtn.onclick=()=>openFavPage(p);
    
    const deleteBtn=document.createElement('button');
    deleteBtn.className='btn btn-danger text-sm px-2 py-1';
    deleteBtn.textContent='🗑️';
    deleteBtn.onclick=()=>removeFavPageAt(i);
    
    btnContainer.appendChild(openBtn);
    btnContainer.appendChild(deleteBtn);
    li.appendChild(pageDiv);
    li.appendChild(btnContainer);
    ul.appendChild(li);
  });
}

function render(auto=false){
  const cur=state.playlist[state.idx];
  const box=document.getElementById('playerBox');
  
  if(cur){
    let titleDiv=document.getElementById('playerTitle');
    let reciterDiv=document.getElementById('playerReciter');
    let audioEl=document.getElementById('player');
    
    if(!titleDiv||!reciterDiv||!audioEl){
      box.innerHTML=`
        <div class="mb-3 text-center">
          <div id="playerTitle" class="font-bold text-lg mb-1"></div>
          <div id="playerReciter" class="text-emerald-400 text-sm"></div>
        </div>
        <audio id="player" controls class="w-full" preload="metadata"></audio>
      `;
      titleDiv=document.getElementById('playerTitle');
      reciterDiv=document.getElementById('playerReciter');
      audioEl=document.getElementById('player');
    }
    
    titleDiv.textContent=cur.title;
    reciterDiv.textContent=cur.reciter;
    
    const needsNewSrc=audioEl.src!==cur.src;
    if(needsNewSrc){
      audioEl.src=cur.src;
    }
    
    audioEl.loop=state.loop;
    
    if(!audioEl.hasEventListeners){
      audioEl.ontimeupdate=()=>{
        const now=audioEl.currentTime,total=audioEl.duration||0;
        const tn=document.getElementById('timeNow');
        const tt=document.getElementById('timeTotal');
        if(tn)tn.textContent=fmt(now);
        if(tt)tt.textContent=fmt(total);
      };
      
      audioEl.onended=()=>{
        if(state.autoPlay&&state.idx<state.playlist.length-1){
          state.idx++;
          render(true);
        }
      };
      
      audioEl.hasEventListeners=true;
    }
    
    if(auto&&needsNewSrc){
      const playPromise=audioEl.play();
      if(playPromise!==undefined){
        playPromise.then(()=>{
        }).catch(err=>{
          console.log('Autoplay prevented:',err);
          showToast('⏸️ اضغط زر التشغيل ▶️ للمتابعة',3000);
        });
      }
    }
  }else{
    box.innerHTML="<div class='text-gray-500 text-center py-2'>اختر سورة للبدء</div>";
  }
  
  const playlistEl=document.getElementById('playlist');
  playlistEl.innerHTML='';
  
  state.playlist.forEach((t,i)=>{
    const li=document.createElement('li');
    li.className=`flex justify-between items-center bg-white bg-opacity-10 backdrop-blur px-4 py-3 rounded-lg playlist-item ${i===state.idx?'ring-2 ring-gold':''}`;
    
    const contentDiv=document.createElement('div');
    contentDiv.className='flex-1';
    
    const titleDiv=document.createElement('div');
    titleDiv.className='font-medium';
    titleDiv.textContent=t.title;
    
    const reciterDiv=document.createElement('div');
    reciterDiv.className='text-sm opacity-75';
    reciterDiv.textContent=t.reciter;
    
    contentDiv.appendChild(titleDiv);
    contentDiv.appendChild(reciterDiv);
    
    const btnContainer=document.createElement('div');
    btnContainer.className='flex items-center gap-2';
    
    const favBtn=document.createElement('button');
    favBtn.className='p-2 hover:scale-110 transition';
    favBtn.textContent='⭐';
    favBtn.title='إضافة للمفضلة';
    favBtn.onclick=()=>addFavFromPlaylist(i);
    
    const playBtn=document.createElement('button');
    playBtn.className='p-2 hover:scale-110 transition';
    playBtn.textContent='▶️';
    playBtn.onclick=()=>playAt(i);
    
    const delBtn=document.createElement('button');
    delBtn.className='p-2 hover:scale-110 transition';
    delBtn.textContent='🗑️';
    delBtn.onclick=()=>removeAt(i);
    
    btnContainer.appendChild(favBtn);
    btnContainer.appendChild(playBtn);
    btnContainer.appendChild(delBtn);
    
    li.appendChild(contentDiv);
    li.appendChild(btnContainer);
    playlistEl.appendChild(li);
  });
}

function add(auto=false){
  const recSlug=document.getElementById('reciterSelect').value;
  const rec=RECITERS.find(r=>r.slug===recSlug);
  const surId=parseInt(document.getElementById('surahSelect').value);
  
  if(!rec||!surId){
    showToast('اختر السورة والقارئ أولاً');
    return;
  }
  
  const modeRadios=document.querySelectorAll('input[name="mode"]');
  modeRadios.forEach(r=>{
    if(r.checked)state.mode=r.value;
  });
  
  if(state.mode==='single'){
    if(state.playlist.length>0){
      const firstReciter=state.playlist[0].reciterSlug;
      if(firstReciter!==recSlug){
        showToast('⚠️ في وضع "قارئ واحد" لا يمكن إضافة قراء مختلفين. امسح القائمة أو اختر "عدة قراء"');
        return;
      }
    }
  }
  
  const sur=chapters.find(c=>c.id===surId)||{name_arabic:`سورة ${surId}`};
  const item={
    title:sur.name_arabic,
    reciter:rec.name,
    reciterSlug:rec.slug,
    surahId:surId,
    src:`${rec.base}/${pad3(surId)}.mp3`
  };
  
  state.playlist.push(item);
  state.idx=state.playlist.length-1;
  
  localStorage.setItem('last_audio_meta',JSON.stringify({
    surahId:surId,
    reciterSlug:rec.slug
  }));
  
  persist();
  render(auto);
  showToast(`✅ تم إضافة ${sur.name_arabic}`);
}

function addFullJuz(juzNum,reciter){
  const juzSurahs=getSurahsInJuz(juzNum);
  
  if(juzSurahs.length===0){
    showToast('⚠️ خطأ في تحميل سور الجزء');
    return;
  }
  
  juzSurahs.forEach(surahId=>{
    const sur=chapters.find(c=>c.id===surahId)||{name_arabic:`سورة ${surahId}`};
    const item={
      title:sur.name_arabic,
      reciter:reciter.name,
      reciterSlug:reciter.slug,
      surahId:surahId,
      src:`${reciter.base}/${pad3(surahId)}.mp3`
    };
    state.playlist.push(item);
  });
  
  if(state.playlist.length>0){
    state.idx=state.playlist.length-juzSurahs.length;
  }
  
  persist();
  render(false);
  showToast(`✅ تم إضافة ${juzSurahs.length} سورة من الجزء ${juzNum}`);
}

function getSurahsInJuz(juzNum){
  const juzPages=JUZ_START_PAGES[juzNum];
  const nextJuzPages=JUZ_START_PAGES[juzNum+1]||605;
  
  const surahs=[];
  Object.keys(SURAH_START_PAGES).forEach(surahId=>{
    const startPage=SURAH_START_PAGES[surahId];
    if(startPage>=juzPages&&startPage<nextJuzPages){
      surahs.push(parseInt(surahId));
    }
  });
  
  return surahs.sort((a,b)=>a-b);
}

function playAt(i){state.idx=i;render(true)}

function removeAt(i){
  const it=state.playlist[i];
  state.playlist.splice(i,1);
  
  if(state.idx>=state.playlist.length){
    state.idx=state.playlist.length-1;
  }
  
  persist();
  render(false);
  if(it)showToast(`تم حذف ${it.title}`);
}

function renderFavorites(){
  const ul=document.getElementById('favorites');
  if(!ul)return;
  
  if(!state.favorites.length){
    ul.innerHTML='<li class="text-sm opacity-70 p-3">لا توجد عناصر مفضلة بعد</li>';
    return;
  }
  
  ul.innerHTML='';
  state.favorites.forEach((f,i)=>{
    const li=document.createElement('li');
    li.className='flex justify-between items-center bg-white bg-opacity-10 backdrop-blur px-4 py-3 rounded-lg playlist-item';
    
    const contentDiv=document.createElement('div');
    contentDiv.className='flex-1';
    
    const titleDiv=document.createElement('div');
    titleDiv.className='font-medium';
    titleDiv.textContent=f.title;
    
    const reciterDiv=document.createElement('div');
    reciterDiv.className='text-sm opacity-75';
    reciterDiv.textContent=f.reciter;
    
    contentDiv.appendChild(titleDiv);
    contentDiv.appendChild(reciterDiv);
    
    const btnContainer=document.createElement('div');
    btnContainer.className='flex items-center gap-2';
    
    const playBtn=document.createElement('button');
    playBtn.className='p-2 hover:scale-110 transition';
    playBtn.textContent='▶️';
    playBtn.onclick=()=>playFavorite(i);
    
    const delBtn=document.createElement('button');
    delBtn.className='p-2 hover:scale-110 transition';
    delBtn.textContent='🗑️';
    delBtn.onclick=()=>removeFav(i);
    
    btnContainer.appendChild(playBtn);
    btnContainer.appendChild(delBtn);
    
    li.appendChild(contentDiv);
    li.appendChild(btnContainer);
    ul.appendChild(li);
  });
}

function playFavorite(i){
  const fav=state.favorites[i];
  if(!fav)return;
  state.playlist=[fav];
  state.idx=0;
  persist();
  render(true);
  setActiveSection('audioSection');
  showToast(`تشغيل ${fav.title}`);
}

function removeFav(i){
  const it=state.favorites[i];
  state.favorites.splice(i,1);
  persist();
  renderFavorites();
  if(it)showToast(`تم حذف ${it.title} من المفضلة`);
}

function toggleKhitmah(){
  state.khitmahEnabled=!state.khitmahEnabled;
  localStorage.setItem('khitmah_enabled',JSON.stringify(state.khitmahEnabled));
  document.getElementById('khitmahLabel').textContent=state.khitmahEnabled?'⛔ إيقاف الختمة':'تفعيل الختمة';
  updateReadingStats();
  updateReadingButton();
  showToast(state.khitmahEnabled?'تم تفعيل الختمة ✅':'تم إيقاف الختمة ⛔');
}

function resetKhitmah(){
  if(!confirm('هل تريد بالتأكيد إعادة الختمة والبدء من الصفر؟'))return;
  if(!confirm('تأكيد نهائي: سيتم حذف جميع الصفحات المقروءة نهائياً. هل أنت متأكد؟'))return;
  
  state.khitmahReading={};
  localStorage.setItem('khitmah_reading_progress',JSON.stringify(state.khitmahReading));
  applyPageReadVisual();
  updateReadingStats();
  showToast('♻️ تم بدء ختمة جديدة – تم تصفير التقدّم');
}

function updateReadingButton(){
  const f=document.getElementById('readingFloatBtn');
  if(!f)return;
  
  if(state.currentSection==='quranSection'&&state.khitmahEnabled){
    f.classList.remove('hide');
  }else{
    f.classList.add('hide');
  }
}

function markCurrentPageRead(){
  const p=parseInt(document.getElementById('pageNum').value||'1');
  
  if(!state.khitmahEnabled){
    showToast('⚠️ يجب تفعيل الختمة أولاً لتسجيل الصفحات');
    return;
  }
  
  if(!state.khitmahReading)state.khitmahReading={};
  
  if(state.khitmahReading[p]){
    showToast('هذه الصفحة مُسجّلة بالفعل');
    return;
  }
  
  state.khitmahReading[p]=true;
  localStorage.setItem('khitmah_reading_progress',JSON.stringify(state.khitmahReading));
  
  if(navigator.vibrate){
    try{navigator.vibrate(60)}catch{}
  }
  
  applyPageReadVisual();
  updateReadingStats();
  showToast(`✅ تم تسجيل الصفحة ${p}`);
}

function computeReading(){
  const read=state.khitmahReading?Object.keys(state.khitmahReading).length:0;
  const total=604;
  const pct=Math.round((read/total)*100);
  const remaining=total-read;
  return {read,total,pct,remaining};
}

function updateReadingStats(){
  const {read,pct,remaining}=computeReading();
  
  const statRead=document.getElementById('statRead');
  const statPercent=document.getElementById('statPercent');
  const statRemaining=document.getElementById('statRemaining');
  
  if(statRead){
    statRead.textContent=read;
    statRead.parentElement.classList.add('fade-in-text');
  }
  if(statPercent){
    statPercent.textContent=pct+'%';
    statPercent.parentElement.classList.add('fade-in-text');
  }
  if(statRemaining){
    statRemaining.textContent=remaining;
    statRemaining.parentElement.classList.add('fade-in-text');
  }
}

async function detectLocation(){
  return new Promise((resolve,reject)=>{
    if(!navigator.geolocation){
      reject(new Error('الموقع غير مدعوم'));
      return;
    }
    navigator.geolocation.getCurrentPosition(
      pos=>resolve({lat:pos.coords.latitude,lng:pos.coords.longitude}),
      err=>reject(err),
      {timeout:10000,enableHighAccuracy:true}
    );
  });
}

async function fetchPrayerTimes(lat,lng){
  try{
    const date=new Date();
    const d=`${String(date.getDate()).padStart(2,'0')}-${String(date.getMonth()+1).padStart(2,'0')}-${date.getFullYear()}`;
    const url=`https://api.aladhan.com/v1/timings/${d}?latitude=${lat}&longitude=${lng}&method=2`;
    const response=await fetch(url);
    const data=await response.json();
    
    if(data.code===200){
      state.prayerTimes=data.data.timings;
      displayPrayerTimes();
      startPrayerCountdown();
    }else{
      showToast('⚠️ خطأ في جلب المواقيت');
    }
  }catch(error){
    console.error('خطأ في جلب المواقيت:',error);
    showToast('⚠️ فشل الاتصال بالخادم');
  }
}

function displayPrayerTimes(){
  if(!state.prayerTimes)return;
  
  const container=document.getElementById('prayerTimesContainer');
  const prayers=['Fajr','Dhuhr','Asr','Maghrib','Isha'];
  const now=new Date();
  const currentTime=now.getHours()*60+now.getMinutes();
  
  let nextPrayer=null;
  let currentPrayer=null;
  
  prayers.forEach((prayer,index)=>{
    const time=state.prayerTimes[prayer];
    const [h,m]=time.split(':').map(Number);
    const prayerMinutes=h*60+m;
    
    if(!nextPrayer&&prayerMinutes>currentTime){
      nextPrayer=prayer;
    }
    if(prayerMinutes<=currentTime){
      currentPrayer=prayer;
    }
  });
  
  if(!nextPrayer)nextPrayer='Fajr';
  
  container.innerHTML=prayers.map(prayer=>{
    const time=state.prayerTimes[prayer];
    const isCurrent=prayer===currentPrayer&&prayer===prayers[prayers.length-1];
    const isNext=prayer===nextPrayer;
    
    return `
      <div class="prayer-time-card ${isCurrent?'current':isNext?'next':''}">
        <div class="prayer-name">${PRAYER_NAMES[prayer]||prayer}</div>
        <div class="prayer-time">${time}</div>
      </div>
    `;
  }).join('');
  
  if(state.prayerTimes.Sunrise){
    container.innerHTML+=`
      <div class="prayer-time-card" style="opacity:0.7">
        <div class="prayer-name">☀️ ${PRAYER_NAMES.Sunrise}</div>
        <div class="prayer-time">${state.prayerTimes.Sunrise}</div>
      </div>
    `;
  }
  
  document.getElementById('countdownContainer').classList.remove('hidden');
}

function startPrayerCountdown(){
  if(prayerInterval)clearInterval(prayerInterval);
  
  prayerInterval=setInterval(()=>{
    if(!state.prayerTimes)return;
    
    const now=new Date();
    const currentMinutes=now.getHours()*60+now.getMinutes();
    const prayers=['Fajr','Dhuhr','Asr','Maghrib','Isha'];
    
    let nextPrayer=null;
    let nextTime=null;
    
    for(const prayer of prayers){
      const time=state.prayerTimes[prayer];
      const[h,m]=time.split(':').map(Number);
      const prayerMinutes=h*60+m;
      
      if(prayerMinutes>currentMinutes){
        nextPrayer=prayer;
        nextTime=prayerMinutes;
        break;
      }
    }
    
    if(!nextPrayer){
      nextPrayer='Fajr';
      const time=state.prayerTimes.Fajr;
      const[h,m]=time.split(':').map(Number);
      nextTime=h*60+m+24*60;
    }
    
    const diff=nextTime-currentMinutes;
    const hours=Math.floor(diff/60);
    const minutes=diff%60;
    const seconds=60-now.getSeconds();
    
    const display=document.getElementById('prayerCountdown');
    if(display){
      display.textContent=`${String(hours).padStart(2,'0')}:${String(minutes).padStart(2,'0')}:${String(seconds).padStart(2,'0')}`;
    }
    
    if(state.notificationsEnabled){
      checkPrayerNotification(nextPrayer,diff);
    }
  },1000);
}

function checkPrayerNotification(prayer,minutesLeft){
  if(minutesLeft<=5&&minutesLeft>4){
    const today=new Date().toDateString();
    const key=`${today}-${prayer}`;
    
    if(!state.notifiedPrayers[key]){
      sendPrayerNotification(prayer);
      state.notifiedPrayers[key]=true;
      localStorage.setItem('notified_prayers',JSON.stringify(state.notifiedPrayers));
    }
  }
}

function sendPrayerNotification(prayer){
  if('Notification' in window&&Notification.permission==='granted'){
    const prayerName=PRAYER_NAMES[prayer]||prayer;
    new Notification('🕌 حان وقت الصلاة',{
      body:`حان الآن موعد صلاة ${prayerName}`,
      icon:'https://i.imgur.com/QIXePvo.png',
      badge:'https://i.imgur.com/QIXePvo.png',
      vibrate:[200,100,200]
    });
    
    if(navigator.vibrate){
      navigator.vibrate([200,100,200,100,200]);
    }
  }
}

async function handleDetectLocation(){
  try{
    showToast('📍 جاري تحديد الموقع...');
    const location=await detectLocation();
    
    const response=await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${location.lat}&longitude=${location.lng}&localityLanguage=ar`);
    const data=await response.json();
    
    const cityName=data.city||data.locality||'موقعك الحالي';
    const countryName=data.countryName||'';
    
    state.currentCity={
      name:`${cityName}${countryName?', '+countryName:''}`,
      lat:location.lat,
      lng:location.lng,
      country:data.countryCode||''
    };
    
    localStorage.setItem('selected_city',JSON.stringify(state.currentCity));
    
    document.getElementById('currentLocation').textContent=`📍 ${state.currentCity.name}`;
    
    await fetchPrayerTimes(location.lat,location.lng);
    showToast('✅ تم تحديد الموقع بنجاح');
  }catch(error){
    console.error('خطأ في تحديد الموقع:',error);
    showToast('❌ فشل تحديد الموقع. الرجاء اختيار المدينة يدوياً');
  }
}

function openCityModal(){
  document.getElementById('cityModal').classList.remove('hidden');
  populateCityList();
}

function closeCityModal(){
  document.getElementById('cityModal').classList.add('hidden');
}

function populateCityList(filter=''){
  const list=document.getElementById('cityList');
  const filtered=CITIES.filter(c=>c.name.includes(filter));
  
  list.innerHTML='';
  filtered.forEach(city=>{
    const li=document.createElement('li');
    li.className="p-3 bg-gray-100 hover:bg-gray-200 rounded-lg cursor-pointer transition font-medium";
    li.style.color='#111827';
    li.textContent=city.name;
    li.onclick=()=>selectCity(city.name,city.lat,city.lng,city.country);
    list.appendChild(li);
  });
}

async function selectCity(name,lat,lng,country){
  state.currentCity={name,lat,lng,country};
  localStorage.setItem('selected_city',JSON.stringify(state.currentCity));
  
  document.getElementById('currentLocation').textContent=`📍 ${name}`;
  closeCityModal();
  
  await fetchPrayerTimes(lat,lng);
  showToast(`✅ تم اختيار ${name}`);
}

function toggleNotifications(){
  const checkbox=document.getElementById('notificationToggle');
  
  if(checkbox.checked){
    if('Notification' in window){
      Notification.requestPermission().then(permission=>{
        if(permission==='granted'){
          state.notificationsEnabled=true;
          localStorage.setItem('notifications_enabled','true');
          document.getElementById('notificationStatus').textContent='✅ الإشعارات مفعّلة';
          showToast('🔔 تم تفعيل إشعارات الأذان');
        }else{
          checkbox.checked=false;
          showToast('⚠️ يجب السماح بالإشعارات أولاً');
        }
      });
    }else{
      checkbox.checked=false;
      showToast('⚠️ الإشعارات غير مدعومة في هذا المتصفح');
    }
  }else{
    state.notificationsEnabled=false;
    localStorage.setItem('notifications_enabled','false');
    document.getElementById('notificationStatus').textContent='';
    showToast('🔕 تم إيقاف إشعارات الأذان');
  }
}

async function loadHadithBook(bookKey){
  if(!bookKey){
    showToast('اختر كتاباً أولاً');
    return;
  }
  
  const book=HADITH_BOOKS[bookKey];
  if(!book)return;
  
  state.currentHadithBook=bookKey;
  state.searchResults=[];
  state.displayedCount=0;
  
  document.getElementById('hadithEmptyMsg').classList.add('hidden');
  document.getElementById('hadithLoadingMsg').classList.remove('hidden');
  document.getElementById('hadithContainer').innerHTML='';
  updateLoadMoreButton();
  
  try{
    const url=`${HADITH_API_BASE}/${book.edition}.json`;
    const response=await fetch(url);
    const data=await response.json();
    
    currentHadithData=data;
    document.getElementById('hadithLoadingMsg').classList.add('hidden');
    
    state.searchResults=data.hadiths.slice(0,10);
    state.displayedCount=10;
    displayHadiths(state.searchResults);
    
    showToast(`تم تحميل ${book.name} ✅`);
  }catch(error){
    console.error('خطأ في تحميل الأحاديث:',error);
    document.getElementById('hadithLoadingMsg').classList.add('hidden');
    document.getElementById('hadithEmptyMsg').classList.remove('hidden');
    showToast('⚠️ خطأ في تحميل الأحاديث');
  }
}

function displayHadiths(hadiths,append=false){
  const container=document.getElementById('hadithContainer');
  
  if(!hadiths||hadiths.length===0){
    container.innerHTML='<div class="card p-6 text-center opacity-75"><p>لم يتم العثور على أحاديث</p></div>';
    return;
  }
  
  if(!append){
    container.innerHTML='';
  }
  
  hadiths.forEach((h,index)=>{
    const card=document.createElement('div');
    card.className='hadith-card';
    
    const textDiv=document.createElement('div');
    textDiv.className='hadith-text';
    textDiv.textContent=h.text||h.hadith||h.arab||h.arabic||'نص الحديث غير متوفر';
    
    const metaDiv=document.createElement('div');
    metaDiv.className='hadith-meta';
    metaDiv.style.display='flex';
    metaDiv.style.justifyContent='space-between';
    metaDiv.style.alignItems='center';
    metaDiv.style.flexWrap='wrap';
    
    const infoDiv=document.createElement('div');
    infoDiv.className='flex items-center gap-2';
    
    const numSpan=document.createElement('span');
    numSpan.textContent=`📖 الحديث رقم ${h.hadithnumber||h.hadithNumber||h.id||'—'}`;
    infoDiv.appendChild(numSpan);
    
    if(h.grade){
      const gradeSpan=document.createElement('span');
      gradeSpan.className='text-xs bg-emerald-100 text-emerald-800 px-2 py-1 rounded';
      gradeSpan.textContent=h.grade;
      infoDiv.appendChild(gradeSpan);
    }
    
    const favBtn=document.createElement('button');
    favBtn.className='btn btn-gold px-4 py-2 text-lg';
    favBtn.textContent='⭐ إضافة للمفضلة';
    favBtn.title='إضافة للمفضلة';
    favBtn.onclick=()=>addHadithToFavorites(index);
    
    metaDiv.appendChild(infoDiv);
    metaDiv.appendChild(favBtn);
    
    card.appendChild(textDiv);
    card.appendChild(metaDiv);
    container.appendChild(card);
  });
}

function addHadithToFavorites(index){
  const hadith=state.searchResults[index];
  if(!hadith){
    showToast('⚠️ خطأ في إضافة الحديث');
    return;
  }
  
  const book=HADITH_BOOKS[state.currentHadithBook];
  if(!book){
    showToast('⚠️ يرجى اختيار كتاب أولاً');
    return;
  }
  
  const hadithNum=hadith.hadithnumber||hadith.hadithNumber||hadith.id||'—';
  const exists=state.favoritesHadith.some(h=>h.id===hadithNum&&h.bookKey===state.currentHadithBook);
  
  if(exists){
    showToast('هذا الحديث موجود بالفعل في المفضلة');
    return;
  }
  
  const favHadith={
    id:hadithNum,
    text:hadith.text||hadith.hadith||hadith.arab||hadith.arabic||'نص الحديث غير متوفر',
    bookKey:state.currentHadithBook,
    bookName:book.name,
    grade:hadith.grade||''
  };
  
  state.favoritesHadith.unshift(favHadith);
  persist();
  renderFavoritesHadith();
  showToast('⭐ تم إضافة الحديث للمفضلة');
}

function renderFavoritesHadith(){
  const ul=document.getElementById('favoritesHadith');
  if(!ul)return;
  
  if(!state.favoritesHadith.length){
    ul.innerHTML='<li class="text-sm opacity-70 p-3">لا توجد أحاديث مفضلة بعد</li>';
    return;
  }
  
  ul.innerHTML='';
  state.favoritesHadith.forEach((h,i)=>{
    const shortText=h.text.length>100?h.text.substring(0,100)+'...':h.text;
    
    const li=document.createElement('li');
    li.className='bg-white bg-opacity-10 backdrop-blur px-4 py-3 rounded-lg playlist-item';
    
    const contentDiv=document.createElement('div');
    contentDiv.className='mb-2';
    
    const titleDiv=document.createElement('div');
    titleDiv.className='text-sm font-bold text-emerald-400 mb-1';
    titleDiv.textContent=`${h.bookName} - الحديث رقم ${h.id}`;
    
    const textDiv=document.createElement('div');
    textDiv.className='text-sm leading-relaxed';
    textDiv.textContent=shortText;
    
    contentDiv.appendChild(titleDiv);
    contentDiv.appendChild(textDiv);
    
    const btnContainer=document.createElement('div');
    btnContainer.className='flex items-center gap-2 justify-end';
    
    const viewBtn=document.createElement('button');
    viewBtn.className='btn btn-gold text-sm px-3 py-1';
    viewBtn.textContent='عرض';
    viewBtn.onclick=()=>viewFavHadith(i);
    
    const delBtn=document.createElement('button');
    delBtn.className='btn btn-danger text-sm px-2 py-1';
    delBtn.textContent='🗑️';
    delBtn.onclick=()=>removeFavHadith(i);
    
    btnContainer.appendChild(viewBtn);
    btnContainer.appendChild(delBtn);
    
    li.appendChild(contentDiv);
    li.appendChild(btnContainer);
    ul.appendChild(li);
  });
}

function viewFavHadith(index){
  const hadith=state.favoritesHadith[index];
  if(!hadith)return;
  
  setActiveSection('hadithSection');
  
  const hadithObj={
    text:hadith.text,
    hadithnumber:hadith.id,
    grade:hadith.grade
  };
  
  state.searchResults=[hadithObj];
  state.displayedCount=1;
  displayHadiths([hadithObj]);
  updateLoadMoreButton();
  
  showToast(`عرض الحديث من ${hadith.bookName}`);
}

function removeFavHadith(index){
  const hadith=state.favoritesHadith[index];
  state.favoritesHadith.splice(index,1);
  persist();
  renderFavoritesHadith();
  if(hadith)showToast(`تم حذف الحديث من المفضلة`);
}

function clearAllFavHadith(){
  if(confirm('مسح كل الأحاديث المفضلة؟')){
    state.favoritesHadith=[];
    persist();
    renderFavoritesHadith();
    showToast('تم مسح الأحاديث المفضلة');
  }
}

function showMoreResults(){
  const LOAD_MORE=50;
  const start=state.displayedCount;
  const end=Math.min(start+LOAD_MORE,state.searchResults.length);
  
  displayHadiths(state.searchResults.slice(start,end),true);
  state.displayedCount=end;
  
  updateLoadMoreButton();
}

function updateLoadMoreButton(){
  let btn=document.getElementById('loadMoreBtn');
  
  if(btn)btn.remove();
  
  if(state.displayedCount<state.searchResults.length){
    const container=document.getElementById('hadithContainer');
    const remaining=state.searchResults.length-state.displayedCount;
    
    btn=document.createElement('div');
    btn.id='loadMoreBtn';
    btn.className='text-center mt-4';
    
    const loadBtn=document.createElement('button');
    loadBtn.className='btn btn-gold px-6 py-3';
    loadBtn.textContent=`📖 عرض المزيد (${remaining} متبقي)`;
    loadBtn.onclick=showMoreResults;
    
    btn.appendChild(loadBtn);
    container.insertAdjacentElement('afterend',btn);
  }
}

function loadSpecificHadith(){
  const num=parseInt(document.getElementById('hadithNumberInput').value);
  
  if(!state.currentHadithBook){
    showToast('اختر كتاباً أولاً');
    return;
  }
  
  if(!num||num<1){
    showToast('أدخل رقم حديث صحيح');
    return;
  }
  
  if(!currentHadithData){
    showToast('يرجى تحميل الكتاب أولاً');
    return;
  }
  
  const hadith=currentHadithData.hadiths.find(h=>h.hadithnumber==num||h.id==num);
  
  if(hadith){
    state.searchResults=[hadith];
    state.displayedCount=1;
    displayHadiths([hadith]);
    updateLoadMoreButton();
    showToast(`تم عرض الحديث رقم ${num}`);
  }else{
    showToast('⚠️ لم يتم العثور على الحديث');
  }
}

function loadRandomHadith(){
  if(!state.currentHadithBook){
    showToast('اختر كتاباً أولاً');
    return;
  }
  
  if(!currentHadithData||!currentHadithData.hadiths){
    showToast('يرجى تحميل الكتاب أولاً');
    return;
  }
  
  const hadiths=currentHadithData.hadiths;
  const randomIndex=Math.floor(Math.random()*hadiths.length);
  const randomHadith=hadiths[randomIndex];
  
  state.searchResults=[randomHadith];
  state.displayedCount=1;
  displayHadiths([randomHadith]);
  updateLoadMoreButton();
  showToast(`📜 حديث اليوم رقم ${randomHadith.hadithnumber||randomHadith.id}`);
}

function searchHadiths(){
  const query=document.getElementById('hadithSearchInput').value.trim();
  
  if(!state.currentHadithBook){
    showToast('اختر كتاباً أولاً');
    return;
  }
  
  if(!query){
    showToast('أدخل كلمة للبحث');
    return;
  }
  
  if(!currentHadithData||!currentHadithData.hadiths){
    showToast('يرجى تحميل الكتاب أولاً');
    return;
  }
  
  const results=currentHadithData.hadiths.filter(h=>{
    const text=(h.text||h.hadith||h.arab||'');
    const normalizedText=text.replace(/[\u064B-\u065F]/g,'');
    const normalizedQuery=query.replace(/[\u064B-\u065F]/g,'');
    return normalizedText.includes(normalizedQuery);
  });
  
  if(results.length>0){
    state.searchResults=results;
    state.displayedCount=Math.min(50,results.length);
    
    displayHadiths(results.slice(0,state.displayedCount),false);
    updateLoadMoreButton();
    
    showToast(`✅ تم العثور على ${results.length} حديث`);
  }else{
    state.searchResults=[];
    state.displayedCount=0;
    document.getElementById('hadithContainer').innerHTML='<div class="card p-6 text-center opacity-75"><p>لم يتم العثور على نتائج للبحث عن: <strong>'+query+'</strong></p></div>';
    updateLoadMoreButton();
    showToast('⚠️ لم يتم العثور على نتائج');
  }
}

function initMobileOptimizations(){
  let lastTouchEnd=0;
  document.addEventListener('touchend',function(e){
    const now=Date.now();
    if(now-lastTouchEnd<=300){
      e.preventDefault();
    }
    lastTouchEnd=now;
  },false);
  
  let scrollTimeout;
  window.addEventListener('scroll',function(){
    clearTimeout(scrollTimeout);
    document.body.classList.add('scrolling');
    scrollTimeout=setTimeout(function(){
      document.body.classList.remove('scrolling');
    },150);
  },{passive:true});
  
  if(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)){
    document.body.classList.add('is-mobile');
  }
  
  let startY;
  document.addEventListener('touchstart',function(e){
    startY=e.touches[0].pageY;
  },{passive:true});
  
  document.addEventListener('touchmove',function(e){
    const y=e.touches[0].pageY;
    if(window.pageYOffset===0&&y>startY){
      e.preventDefault();
    }
  },{passive:false});
  
  document.querySelectorAll('.btn, button').forEach(btn=>{
    btn.addEventListener('touchstart',function(){
      this.style.transform='scale(0.95)';
    },{passive:true});
    
    btn.addEventListener('touchend',function(){
      this.style.transform='';
    },{passive:true});
  });
}

function enableManualFullscreen(){
  const container=document.getElementById('imageWrapper');
  container.classList.add('fullscreen-mode');
  document.body.classList.add('fullscreen-active');
  const exitBtn=document.getElementById('exitFullscreenBtn');
  if(exitBtn)exitBtn.style.display='flex';
  
  if(screen.orientation && screen.orientation.lock){
    screen.orientation.lock('portrait').catch(()=>{});
  }
  
  document.body.style.overflow='hidden';
  document.documentElement.style.overflow='hidden';
  
  showToast('📱 ملء الشاشة مُفعّل - اضغط ↩️ للخروج');
}

function disableManualFullscreen(){
  const container=document.getElementById('imageWrapper');
  container.classList.remove('fullscreen-mode');
  document.body.classList.remove('fullscreen-active');
  const exitBtn=document.getElementById('exitFullscreenBtn');
  if(exitBtn)exitBtn.style.display='none';
  
  if(screen.orientation && screen.orientation.unlock){
    screen.orientation.unlock();
  }
  
  document.body.style.overflow='';
  document.documentElement.style.overflow='';
}

function initializeEvents(){
  document.getElementById('themeToggle').onclick=()=>{
    ti=(ti+1)%THEMES.length;
    applyTheme(THEMES[ti]);
    showToast(THEMES[ti]==='day'?'الوضع النهاري ☀️':THEMES[ti]==='night'?'الوضع الليلي 🌙':'الثيم الخاص ✨');
  };

  document.querySelectorAll('.nav-item').forEach(i=>
    i.addEventListener('click',()=>{
      setActiveSection(i.getAttribute('data-section'));
    })
  );

  document.getElementById('pageNum').onchange=e=>{
    loadPage(e.target.value);
    updateReadingButton();
  };

  document.getElementById('fullscreenBtn').onclick=()=>{
    const container=document.getElementById('imageWrapper');
    const d=document;
    
    const isFullscreen = d.fullscreenElement || d.webkitFullscreenElement || 
                         d.mozFullScreenElement || d.msFullscreenElement ||
                         container.classList.contains('fullscreen-mode');
    
    if(!isFullscreen){
      if(container.requestFullscreen){
        container.requestFullscreen().catch(()=>enableManualFullscreen());
      }else if(container.webkitRequestFullscreen){
        container.webkitRequestFullscreen();
      }else if(container.webkitEnterFullscreen){
        container.webkitEnterFullscreen();
      }else if(container.msRequestFullscreen){
        container.msRequestFullscreen();
      }else if(container.mozRequestFullScreen){
        container.mozRequestFullScreen();
      }else{
        enableManualFullscreen();
      }
    }else{
      if(container.classList.contains('fullscreen-mode')){
        disableManualFullscreen();
      }else{
        if(d.exitFullscreen){
          d.exitFullscreen();
        }else if(d.webkitExitFullscreen){
          d.webkitExitFullscreen();
        }else if(d.msExitFullscreen){
          d.msExitFullscreen();
        }else if(d.mozCancelFullScreen){
          d.mozCancelFullScreen();
        }
      }
    }
  };

  const exitBtn=document.createElement('button');
  exitBtn.id="exitFullscreenBtn";
  exitBtn.textContent="↩️";
  exitBtn.onclick=()=>{ 
    const container=document.getElementById('imageWrapper');
    if(container.classList.contains('fullscreen-mode')){
      disableManualFullscreen();
    }else{
      const d=document;
      if(d.exitFullscreen){
        d.exitFullscreen();
      }else if(d.webkitExitFullscreen){
        d.webkitExitFullscreen();
      }else if(d.msExitFullscreen){
        d.msExitFullscreen();
      }else if(d.mozCancelFullScreen){
        d.mozCancelFullScreen();
      }
    }
  };
  document.body.appendChild(exitBtn);

  const handleFullscreenChange=()=>{
    const container=document.getElementById('imageWrapper');
    const isFullscreen = document.fullscreenElement || 
                         document.webkitFullscreenElement || 
                         document.mozFullScreenElement || 
                         document.msFullscreenElement ||
                         container.classList.contains('fullscreen-mode');
    
    if(isFullscreen){
      exitBtn.style.display="flex";
    }else{
      exitBtn.style.display="none";
    }
  };
  
  document.addEventListener('fullscreenchange', handleFullscreenChange);
  document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
  document.addEventListener('mozfullscreenchange', handleFullscreenChange);
  document.addEventListener('MSFullscreenChange', handleFullscreenChange);

  document.getElementById('addBtn').onclick=()=>add(true);
  
  document.getElementById('surahSearch').oninput=e=>{
    populateSurahSelect(e.target.value);
  };
  
  document.getElementById('reciterSearch').oninput=e=>{
    populateReciterSelect(e.target.value);
  };
  
  document.getElementById('juzAudioSelect').onchange=e=>{
    const juzNum=parseInt(e.target.value);
    if(!juzNum){
      e.target.value='';
      return;
    }
    
    const modeRadios=document.querySelectorAll('input[name="mode"]');
    modeRadios.forEach(r=>{
      if(r.checked)state.mode=r.value;
    });
    
    if(state.mode!=='single'){
      showToast('⚠️ يجب اختيار وضع "قارئ واحد" لإضافة جزء كامل');
      e.target.value='';
      return;
    }
    
    const recSlug=document.getElementById('reciterSelect').value;
    const rec=RECITERS.find(r=>r.slug===recSlug);
    if(!rec){
      showToast('⚠️ اختر القارئ أولاً');
      e.target.value='';
      return;
    }
    
    addFullJuz(juzNum,rec);
    e.target.value='';
  };
  
  document.getElementById('loopToggle').addEventListener('change',e=>{
    state.loop=e.target.checked;
    const a=document.getElementById('player');
    if(a)a.loop=state.loop;
    showToast(state.loop?'تكرار مُفعل 🔁':'تكرار متوقف ⏸️');
  });
  
  document.getElementById('autoPlayToggle').addEventListener('change',e=>{
    state.autoPlay=e.target.checked;
    showToast(state.autoPlay?'التشغيل التلقائي مُفعل ▶️':'التشغيل التلقائي متوقف ⏸️');
  });

  document.getElementById('clearBtn').onclick=()=>{
    if(confirm('مسح القائمة؟')){
      state.playlist=[];
      state.idx=0;
      persist();
      render(false);
      showToast('تم مسح قائمة التشغيل');
    }
  };

  document.getElementById('clearFavBtn').onclick=()=>{
    if(confirm('مسح المفضلة (استماع)؟')){
      state.favorites=[];
      persist();
      renderFavorites();
      showToast('تم مسح المفضلة');
    }
  };
  
  document.getElementById('clearFavHadithBtn').onclick=clearAllFavHadith;

  document.getElementById('rewind10').onclick=()=>{
    const player=document.getElementById('player');
    if(player){
      player.currentTime=Math.max(0,player.currentTime-10);
    }
  };

  document.getElementById('forward10').onclick=()=>{
    const player=document.getElementById('player');
    if(player){
      player.currentTime=Math.min(
        isNaN(player.duration)?player.currentTime+10:player.duration, 
        player.currentTime+10
      );
    }
  };

  const sleepStatusTop=document.getElementById('sleepStatus');
  const sleepStatusPlayer=document.getElementById('sleepStatusPlayer');
  
  document.getElementById('sleepSet').onclick=()=>{
    const m=parseInt(document.getElementById('sleepSeconds').value||'0');
    if(m>0){
      clearTimeout(state.sleepTimeout);
      clearInterval(state.sleepInterval);
      state.sleepRemaining=m*60;
      
      const tick=()=>{
        const mins=Math.floor(state.sleepRemaining/60);
        const secs=String(state.sleepRemaining%60).padStart(2,'0');
        const txt=`⏳ مؤقّت النوم — ${String(mins).padStart(2,'0')}:${secs}`;
        sleepStatusTop.textContent=txt;
        sleepStatusPlayer.textContent=txt;
        state.sleepRemaining--;
        
        if(state.sleepRemaining<0){
          clearInterval(state.sleepInterval);
          const a=document.getElementById('player');
          if(a){
            a.pause();
            showToast('🔕 تم الإيقاف — انتهى مؤقّت النوم');
          }
          sleepStatusTop.textContent='';
          sleepStatusPlayer.textContent='';
        }
      };
      
      tick();
      state.sleepInterval=setInterval(tick,1000);
      showToast(`⏱️ تم تفعيل مؤقت النوم لـ ${m} دقيقة`);
    }else{
      showToast('حدد الوقت بالدقائق');
    }
  };

  document.getElementById('sleepCancel').onclick=()=>{
    clearTimeout(state.sleepTimeout);
    clearInterval(state.sleepInterval);
    state.sleepRemaining=0;
    sleepStatusTop.textContent='';
    sleepStatusPlayer.textContent='';
    showToast('تم إلغاء مؤقّت النوم');
  };

  document.getElementById('khitmahBtn').onclick=toggleKhitmah;
  document.getElementById('resetKhitmahBtn').onclick=resetKhitmah;

  const f=document.getElementById('readingFloatBtn');
  if(f)f.addEventListener('click',markCurrentPageRead);

  document.getElementById('favPageBtn').addEventListener('click',addCurrentPageToFavorites);
  document.getElementById('jumpLastBtn').onclick=jumpToLastPage;

  document.getElementById('openSurahModal').onclick=openModal;
  document.getElementById('closeSurahModal').onclick=closeModal;
  document.getElementById('surahModal').addEventListener('click',(e)=>{
    if(e.target.id==='surahModal')closeModal();
  });
  
  document.getElementById('juzSelect').onchange=e=>{
    const juzNum=parseInt(e.target.value);
    if(juzNum&&JUZ_START_PAGES[juzNum]){
      const targetPage=JUZ_START_PAGES[juzNum];
      loadPage(targetPage,true);
      showToast(`📗 تم فتح الجزء ${juzNum} (صفحة ${targetPage})`);
      e.target.value='';
    }
  };

  document.getElementById('hadithBookSelect').onchange=e=>{
    loadHadithBook(e.target.value);
  };
  
  document.getElementById('loadHadithBtn').onclick=loadSpecificHadith;
  document.getElementById('randomHadithBtn').onclick=loadRandomHadith;
  document.getElementById('hadithSearchBtn').onclick=searchHadiths;
  
  document.getElementById('hadithSearchInput').addEventListener('keypress',e=>{
    if(e.key==='Enter')searchHadiths();
  });

  document.getElementById('detectLocationBtn').onclick=handleDetectLocation;
  document.getElementById('manualCityBtn').onclick=openCityModal;
  document.getElementById('closeCityModal').onclick=closeCityModal;
  document.getElementById('citySearchInput').oninput=e=>populateCityList(e.target.value);
  document.getElementById('cityModal').addEventListener('click',e=>{
    if(e.target.id==='cityModal')closeCityModal();
  });
  document.getElementById('notificationToggle').onchange=toggleNotifications;
}

async function initialize(){
  initTheme();
  await fetchChapters();
  updateClock();
  setInterval(updateClock,60000);

  state.playlist=JSON.parse(localStorage.getItem('playlist')||'[]');
  state.favorites=JSON.parse(localStorage.getItem('favorites')||'[]');
  
  render(false);
  renderFavorites();
  renderFavoritesPages();
  renderFavoritesHadith();
  
  if(state.lastPage){
    loadPage(state.lastPage,false);
  }else{
    loadPage(1,false);
  }
  
  initSwipe();
  applyPageReadVisual();
  updateReadingStats();
  updateReadingButton();

  const last=state.lastAudio;
  if(last){
    const rec=RECITERS.find(r=>r.slug===last.reciterSlug);
    if(rec)document.getElementById('reciterSelect').value=rec.slug;
    document.getElementById('surahSelect').value=String(last.surahId||1);
  }

  document.getElementById('khitmahLabel').textContent=
    state.khitmahEnabled?'⛔ إيقاف الختمة':'تفعيل الختمة';

  if(state.currentCity){
    document.getElementById('currentLocation').textContent=`📍 ${state.currentCity.name}`;
    await fetchPrayerTimes(state.currentCity.lat,state.currentCity.lng);
  }

  if(state.notificationsEnabled){
    document.getElementById('notificationToggle').checked=true;
    document.getElementById('notificationStatus').textContent='✅ الإشعارات مفعّلة';
  }

  initializeEvents();
  initMobileOptimizations();
  
  setTimeout(()=>{
    const lastPage=parseInt(localStorage.getItem('last_quran_page')||'0');
    if(lastPage>0){
      setActiveSection('quranSection');
      loadPage(lastPage,false);
      
      setTimeout(()=>{
        showToast('💡 اضغط على "ملء الشاشة" للقراءة المريحة', 4000);
      },800);
    }
  },2500);
}

window.addEventListener('load',initialize);

let hisnData = {};
let hisnState = {
  favorites: JSON.parse(localStorage.getItem('hisnFavorites') || '[]'),
  counters: JSON.parse(localStorage.getItem('hisnCounters') || '{}'),
  currentCategory: null,
  searchTerm: ''
};

async function loadHisnData() {
  try {
    const response = await fetch('hisn_almuslim.json').catch(err => {
      console.warn('Trying alternative path...');
      return fetch('./hisn_almuslim.json');
    });
    if (!response || !response.ok) {
      throw new Error('Failed to load hisn_almuslim.json. Make sure the file is in the same directory as index.html');
    }
    hisnData = await response.json();
    renderHisnDropdown();
    const firstCategory = Object.keys(hisnData)[0];
    loadHisnCategory(firstCategory);
  } catch (error) {
    console.error('Error loading Hisn data:', error);
    const container = document.getElementById('hisnContent');
    if (container) {
      container.innerHTML = `
        <div class="no-results" style="text-align:right; padding:2rem;">
          <div style="font-size:2rem; margin-bottom:1rem;">❌</div>
          <h3 style="color:var(--gold); margin-bottom:1rem;">خطأ في تحميل البيانات</h3>
          <p style="margin-bottom:0.5rem;">⚠️ تأكد من:</p>
          <ul style="text-align:right; list-style:none; padding-right:1rem;">
            <li style="margin-bottom:0.5rem;">✓ وجود ملف <code>hisn_almuslim.json</code> في نفس المجلد</li>
            <li style="margin-bottom:0.5rem;">✓ رفع الملف على GitHub</li>
            <li style="margin-bottom:0.5rem;">✓ مسح الـ cache (Ctrl+Shift+R)</li>
          </ul>
          <p style="margin-top:1rem; opacity:0.7; font-size:0.9rem;">
            الخطأ: ${error.message}
          </p>
        </div>
      `;
    }
  }
}

function renderHisnDropdown() {
  const dropdown = document.getElementById('hisnCategorySelect');
  if (!dropdown) return;
  
  while (dropdown.options.length > 1) {
    dropdown.remove(1);
  }
  
  Object.keys(hisnData).forEach(category => {
    const option = document.createElement('option');
    option.value = category;
    option.textContent = category;
    dropdown.appendChild(option);
  });
  
  dropdown.onchange = (e) => {
    if (e.target.value) {
      loadHisnCategory(e.target.value);
    } else {
      hisnState.currentCategory = null;
      hisnState.searchTerm = '';
      renderHisnContent();
    }
  };
}

function loadHisnCategory(category) {
  hisnState.currentCategory = category;
  hisnState.searchTerm = '';
  const searchInput = document.getElementById('hisnSearchInput');
  if (searchInput) searchInput.value = '';
  
  const dropdown = document.getElementById('hisnCategorySelect');
  if (dropdown) dropdown.value = category;
  
  renderHisnContent();
}

function renderHisnContent() {
  const container = document.getElementById('hisnContent');
  if (!container) return;
  
  container.innerHTML = '';
  const searchTerm = hisnState.searchTerm.toLowerCase();
  let hasResults = false;
  
  Object.entries(hisnData).forEach(([title, data]) => {
    if (hisnState.currentCategory && title !== hisnState.currentCategory) return;
    
    if (searchTerm) {
      const titleMatch = title.toLowerCase().includes(searchTerm);
      const textMatch = data.text?.some(t => t.toLowerCase().includes(searchTerm));
      if (!titleMatch && !textMatch) return;
    }
    
    hasResults = true;
    const card = createHisnCard(title, data);
    container.appendChild(card);
  });
  
  if (!hasResults) {
    container.innerHTML = '<div class="no-results">لا توجد نتائج 🔍</div>';
  }
}

function createHisnCard(title, data) {
  const card = document.createElement('div');
  card.className = 'hisn-card fade-in-text';
  
  const isFavorite = hisnState.favorites.includes(title);
  const counter = hisnState.counters[title] || 0;
  
  const titleDiv = document.createElement('div');
  titleDiv.className = 'hisn-title';
  
  const titleSpan = document.createElement('span');
  titleSpan.textContent = title;
  
  const favBtn = document.createElement('button');
  favBtn.className = `hisn-fav-btn ${isFavorite ? 'favorited' : ''}`;
  favBtn.textContent = isFavorite ? '⭐ مفضل' : '☆ إضافة';
  favBtn.onclick = () => toggleHisnFavorite(title);
  
  titleDiv.appendChild(titleSpan);
  titleDiv.appendChild(favBtn);
  card.appendChild(titleDiv);
  
  if (data.text && Array.isArray(data.text)) {
    data.text.forEach(text => {
      const textDiv = document.createElement('div');
      textDiv.className = 'hisn-text';
      textDiv.textContent = text;
      card.appendChild(textDiv);
    });
  }
  
  if (data.footnote && Array.isArray(data.footnote) && data.footnote.length > 0) {
    const footnoteDiv = document.createElement('div');
    footnoteDiv.className = 'hisn-footnote';
    data.footnote.forEach(note => {
      const noteDiv = document.createElement('div');
      noteDiv.style.marginBottom = '.3rem';
      noteDiv.textContent = '• ' + note;
      footnoteDiv.appendChild(noteDiv);
    });
    card.appendChild(footnoteDiv);
  }
  
  const actionsDiv = document.createElement('div');
  actionsDiv.className = 'hisn-actions';
  
  const counterBox = document.createElement('div');
  counterBox.className = 'counter-box';
  
  const decrementBtn = document.createElement('button');
  decrementBtn.className = 'counter-btn';
  decrementBtn.textContent = '−';
  decrementBtn.onclick = () => decrementCounter(title);
  
  const counterDisplay = document.createElement('span');
  counterDisplay.className = 'counter-display';
  counterDisplay.textContent = counter;
  
  const incrementBtn = document.createElement('button');
  incrementBtn.className = 'counter-btn';
  incrementBtn.textContent = '+';
  incrementBtn.onclick = () => incrementCounter(title);
  
  const resetBtn = document.createElement('button');
  resetBtn.className = 'counter-btn reset-counter';
  resetBtn.textContent = '↻';
  resetBtn.title = 'إعادة تعيين';
  resetBtn.onclick = () => resetCounter(title);
  
  counterBox.appendChild(decrementBtn);
  counterBox.appendChild(counterDisplay);
  counterBox.appendChild(incrementBtn);
  counterBox.appendChild(resetBtn);
  actionsDiv.appendChild(counterBox);
  card.appendChild(actionsDiv);
  
  return card;
}

function toggleHisnFavorite(title) {
  const index = hisnState.favorites.indexOf(title);
  if (index > -1) {
    hisnState.favorites.splice(index, 1);
    showToast('❌ تم إزالة الذكر من المفضلة');
  } else {
    hisnState.favorites.push(title);
    showToast('⭐ تمت إضافة الذكر للمفضلة');
  }
  localStorage.setItem('hisnFavorites', JSON.stringify(hisnState.favorites));
  renderHisnContent();
  updateFavoritesHisn();
}

function incrementCounter(title) {
  hisnState.counters[title] = (hisnState.counters[title] || 0) + 1;
  localStorage.setItem('hisnCounters', JSON.stringify(hisnState.counters));
  renderHisnContent();
}

function decrementCounter(title) {
  if (hisnState.counters[title] > 0) {
    hisnState.counters[title]--;
    localStorage.setItem('hisnCounters', JSON.stringify(hisnState.counters));
    renderHisnContent();
  }
}

function resetCounter(title) {
  hisnState.counters[title] = 0;
  localStorage.setItem('hisnCounters', JSON.stringify(hisnState.counters));
  renderHisnContent();
  showToast('↻ تم إعادة تعيين العداد');
}

function searchHisn() {
  hisnState.searchTerm = document.getElementById('hisnSearchInput').value;
  hisnState.currentCategory = null;
  renderHisnContent();
}

function updateFavoritesHisn() {
  const favSection = document.getElementById('favoritesSection');
  if (!favSection) return;
  
  let favHisnContainer = document.getElementById('favHisnContainer');
  if (!favHisnContainer) {
    const favCard = favSection.querySelector('.card');
    if (favCard) {
      favHisnContainer = document.createElement('div');
      favHisnContainer.id = 'favHisnContainer';
      favHisnContainer.className = 'mt-4';
      favCard.appendChild(favHisnContainer);
    } else {
      return;
    }
  }
  
  if (hisnState.favorites.length === 0) {
    favHisnContainer.innerHTML = '';
    return;
  }
  
  let html = '<h3 class="font-semibold text-lg mb-3 mt-4" style="color:var(--gold)">🤲 الأذكار المفضلة</h3>';
  hisnState.favorites.forEach(title => {
    if (hisnData[title]) {
      const cardDiv = createHisnCard(title, hisnData[title]);
      html += cardDiv.outerHTML;
    }
  });
  favHisnContainer.innerHTML = html;
}

function initHisn() {
  const hisnSearchInput = document.getElementById('hisnSearchInput');
  if (hisnSearchInput) {
    hisnSearchInput.addEventListener('input', searchHisn);
  }
  
  loadHisnData();
}

window.addEventListener('load', initHisn);
</script>
</body>
</html>
