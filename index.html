<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ğŸ“– Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ… â€“ ØµØ¯Ù‚Ø© Ø¬Ø§Ø±ÙŠØ©</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
:root{--gold:#d4af37;}
body{font-family:"Noto Naskh Arabic UI","Segoe UI",system-ui,sans-serif;transition:background .25s,color .25s}

/* ===== Ø¹Ù†Ø§ØµØ± Ø¹Ø§Ù…Ø© ===== */
.card{border-radius:.75rem;box-shadow:0 4px 12px rgba(0,0,0,.12)}
.btn{padding:.45rem .9rem;border-radius:.65rem;font-weight:600}
.btn-ghost{background:transparent;border:1px solid rgba(0,0,0,.15)}
.btn-gold{background:var(--gold);color:#1f2937}.btn-gold:hover{filter:brightness(1.05)}
.btn-danger{background:#ef4444;color:#fff}.btn-danger:hover{background:#dc2626}

/* ===== Ø«ÙŠÙ…Ø§Øª ===== */
.theme-day{background:#f8fafc;color:#0f172a}
.theme-day .card{background:#fff;color:#0f172a}
.theme-night{background:#0f172a;color:#e5e7eb}
.theme-night .card{background:#1f2937;color:#e5e7eb}
.theme-special{background:#0b3a2b;color:#fff}
.theme-special .card{background:#0f4a33;color:#fefce8;border:1px solid rgba(212,175,55,.25)}
.tab-active{background:#1f2937;color:#f1f5f9}
.tab-inactive{background:#e5e7eb;color:#1f2937}

/* ===== Ù‡ÙŠØ¯Ø± (Ø£ÙƒØ¨Ø± 20% + Ø´ÙØ§Ù) ===== */
header#appHeader{
  padding:.9rem 1rem!important; /* ÙƒØ§Ù† ~ .75 â†’ Ø§Ù„Ø¢Ù† Ø£ÙƒØ¨Ø± ~20% */
  background:transparent;        /* Ø´ÙØ§Ù */
}
#themeToggle{
  width:2.4rem;height:2.4rem;display:inline-flex;align-items:center;justify-content:center;
  border-radius:.65rem;background:var(--gold);color:#1f2937
}
#title{font-size:1.05rem;line-height:1.25}

/* Ø§Ù„ØªØ§Ø±ÙŠØ®: Ø§Ù„Ù‡Ø¬Ø±ÙŠ Ø³Ø·Ø± Ù…Ø³ØªÙ‚Ù„ ÙÙˆÙ‚ØŒ Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ÙŠ+Ø§Ù„ÙˆÙ‚Øª Ø³Ø·Ø± ØªØ­ØªÙ‡ */
.clock-box{line-height:1.2;text-align:end;font-size:.9rem}
.clock-box .hijri{font-weight:700}
.clock-box .greg{font-variant-numeric:tabular-nums;opacity:.9}

/* ===== Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… ===== */
#progressBar{width:100%;height:6px;background:#e5e7eb;border-radius:999px;cursor:pointer}
#progressFill{height:100%;width:0;background:#10b981;border-radius:999px}

/* ===== Ø­Ø¬Ù… Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø¹Ø§Ù… Ø£ÙƒØ¨Ø± Ù„ÙŠØ³ØªÙˆØ¹Ø¨ Ø§Ù„Ù…ØµØ­Ù ===== */
main{max-width:80rem}                /* ÙƒØ§Ù† ~4xlØŒ Ø§Ù„Ø¢Ù† Ø£ÙˆØ³Ø¹ */
nav.top-tabs{max-width:80rem;margin-inline:auto}

/* ===== Ø§Ù„Ù…ØµØ­Ù Ø§Ù„Ù…ØµÙˆÙ‘Ø± (ØªÙƒØ¨ÙŠØ± Ø§Ù„Ù…Ø³Ø§Ø­Ø©) ===== */
#imagesSection{background:#fff!important;color:#000!important;border-radius:12px;padding:10px}
#imageWrapper{
  /* ØªÙƒØ¨ÙŠØ± Ø£Ù‚ØµÙ‰ Ø§Ø±ØªÙØ§Ø¹ Ù„ÙŠÙ„ØºÙŠ Ø§Ù„Ø­Ø§Ø¬Ø© Ù„Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø© ØºØ§Ù„Ø¨Ø§Ù‹ */
  max-height:calc(100vh - 120px);     /* ÙƒØ§Ù† Ø£Ø¹Ù„Ù‰Ø› Ø§Ù„Ø¢Ù† Ø£ÙƒØ¨Ø± Ù„Ù„ØµÙˆØ±Ø© */
  overflow:auto;                       /* ÙŠØ³Ù…Ø­ Ø¨Ø³ÙƒØ±ÙˆÙ„ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø­Ø§ÙˆÙŠØ© */
  touch-action: pan-y pinch-zoom;      /* Ø³ÙƒØ±ÙˆÙ„ Ø¹Ù…ÙˆØ¯ÙŠ Ø·Ø¨ÙŠØ¹ÙŠ + ÙŠØ³Ù…Ø­ Ø¨Ø²ÙˆÙ… Ø§Ù„Ù…ØªØµÙØ­ Ø§Ù„Ø¹Ø§Ù… */
  border-radius:12px;background:#fff;
}
#quranPage{
  display:block;margin:auto;
  max-width:100%;height:auto;
  background:#fff;padding:4px;border-radius:8px;
  box-shadow:0 2px 10px rgba(0,0,0,.15);
  transform-origin:center center;transition:transform .2s ease;
  touch-action: manipulation;          /* Ù†Ù‚Ø±/Ø³Ø­Ø¨ Ø®ÙÙŠÙ Ø¨Ø¯ÙˆÙ† ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø³ÙƒØ±ÙˆÙ„ */
  -webkit-user-drag:none;user-select:none;
}

/* âœ… fullscreen Ù…ØªÙ†Ø§Ø³Ù‚ (Ø³Ø­Ø¨ Ø£ÙÙ‚ÙŠ Ø³ÙŠØªÙ… ØªÙØ¹ÙŠÙ„Ù‡ ÙÙŠ JS) */
#imageWrapper:fullscreen img{
  width:auto!important;height:100vh!important;max-width:100%;
  object-fit:contain!important;display:block;margin:auto
}
@supports (-webkit-touch-callout: none){
  /* iOS: svh Ù„Ø§Ø±ØªÙØ§Ø¹ Ø¢Ù…Ù† */
  #imageWrapper:fullscreen img{height:100svh!important}
}

/* ===== Ø²Ø± ÙˆØ§ØªØ³Ø§Ø¨ Ø¹Ø§Ø¦Ù… (Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ØµÙˆØ±Ø©) ===== */
#whatsappFab{
  position:fixed; inset-inline-end:1rem; inset-block-end:1rem; z-index:50;
  width:3.2rem;height:3.2rem;border-radius:999px;background:#25D366;
  display:flex;align-items:center;justify-content:center;
  box-shadow:0 10px 24px rgba(0,0,0,.18)
}
#whatsappFab img{width:1.75rem;height:1.75rem;display:block}
#whatsappFab:hover{filter:brightness(1.08)}
</style>
</head>

<body class="theme-day min-h-screen">

<header id="appHeader" class="sticky top-0 z-10 border-b border-slate-200 flex items-center justify-between gap-3 backdrop-blur-md">
  <div class="flex items-center gap-2">
    <button id="themeToggle" class="btn" title="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ (Ù†Ù‡Ø§Ø±ÙŠ/Ù„ÙŠÙ„ÙŠ/Ø®Ø§Øµ)">
      <span id="themeIcon" aria-hidden="true">ğŸŒ</span>
    </button>
    <h1 id="title" class="font-bold">ğŸ“– Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ… â€“ <span class="font-normal">ØµØ¯Ù‚Ø© Ø¬Ø§Ø±ÙŠØ©</span></h1>
  </div>
  <div class="clock-box pr-1">
    <!-- Ø³Ø·Ø± Ù„Ù„Ù‡Ø¬Ø±ÙŠØŒ Ø³Ø·Ø± Ù„Ù„Ù…ÙŠÙ„Ø§Ø¯ÙŠ+Ø§Ù„ÙˆÙ‚Øª (24h) -->
    <div id="hijriLine" class="hijri">â€”</div>
    <div id="gregLine" class="greg">â€”</div>
  </div>
</header>

<!-- Ø²Ø± ÙˆØ§ØªØ³Ø§Ø¨ Ø¹Ø§Ø¦Ù… Ø¨ØµÙˆØ±Ø© Ø§Ù„Ø±Ù…Ø² -->
<a id="whatsappFab" href="https://wa.me/905533331339" target="_blank" aria-label="Ø§Ù„ØªÙˆØ§ØµÙ„ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨" title="ÙˆØ§ØªØ³Ø§Ø¨">
  <img src="https://i.imgur.com/9fHveoY.png" alt="WhatsApp">
</a>

<!-- Tabs -->
<nav class="top-tabs p-4 flex gap-2">
  <button id="tabAudio" class="btn tab-active">ğŸ”Š Ø§Ù„ØµÙˆØª</button>
  <button id="tabImages" class="btn tab-inactive">ğŸ–¼ï¸ Ø§Ù„Ù…ØµØ­Ù Ø§Ù„Ù…ØµÙˆÙ‘ÙØ±</button>
</nav>

<main class="mx-auto p-4 space-y-6">

  <!-- AUDIO SECTION -->
  <section id="audioSection" class="space-y-4">
    <section class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div class="card p-4">
        <h2 class="mb-2 font-semibold">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø³ÙˆØ±Ø©</h2>
        <select id="surahSelect" class="w-full p-2 rounded border text-black"></select>
      </div>
      <div class="card p-4">
        <h2 class="mb-2 font-semibold">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù‚Ø§Ø±Ø¦</h2>
        <select id="reciterSelect" class="w-full p-2 rounded border text-black"></select>
      </div>
    </section>

    <section class="card p-4">
      <h2 class="font-semibold mb-2">ÙˆØ¶Ø¹ Ø§Ù„ØªØ´ØºÙŠÙ„</h2>
      <div class="flex flex-wrap items-center gap-4 text-sm">
        <label class="inline-flex items-center gap-1">
          <input type="radio" name="mode" value="single" checked> Ù‚Ø§Ø±Ø¦ ÙˆØ§Ø­Ø¯
        </label>
        <label class="inline-flex items-center gap-1">
          <input type="radio" name="mode" value="multi"> Ø¹Ø¯Ø© Ù‚Ø±Ø§Ø¡
        </label>
        <label class="inline-flex items-center gap-1 ml-2">
          <input type="checkbox" id="loopToggle"> ØªÙƒØ±Ø§Ø± Ø§Ù„Ø³ÙˆØ±Ø©
        </label>
      </div>

      <div class="mt-3 flex flex-wrap gap-2 items-center text-sm">
        <label for="sleepMinutes">â±ï¸ Ù…Ø¤Ù‚Ù‘Øª Ø§Ù„Ù†ÙˆÙ…</label>
        <input id="sleepMinutes" type="number" min="1" step="1" placeholder="Ø¯Ù‚Ø§Ø¦Ù‚" class="w-20 p-1 border rounded text-black">
        <button id="sleepSet" class="px-3 py-1 bg-slate-600 text-white rounded">ØªÙØ¹ÙŠÙ„</button>
        <button id="sleepCancel" class="px-3 py-1 bg-red-500 text-white rounded">Ø¥Ù„ØºØ§Ø¡</button>
        <span id="sleepStatus" class="text-sm"></span>
      </div>
    </section>

    <section class="flex gap-3">
      <button id="addBtn" class="flex-1 btn btn-gold">â• Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù…Ø´ØºÙ„</button>
      <button id="favBtn" class="flex-1 btn btn-ghost">â­ Ù…ÙØ¶Ù„Ø©</button>
    </section>

    <section class="card p-4">
      <h2 class="font-semibold mb-2 flex items-center justify-between">
        <span>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ´ØºÙŠÙ„</span>
        <button id="clearBtn" class="btn btn-danger text-sm">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>
      </h2>
      <ul id="playlist" class="space-y-2"></ul>
    </section>

    <section class="card p-4">
      <h2 class="font-semibold mb-2">Ø§Ù„Ù…Ø´ØºÙ‘Ù„</h2>
      <div id="playerBox"></div>
      <div id="progressBar" class="mt-2"><div id="progressFill"></div></div>
      <div class="flex items-center justify-center gap-2 mt-2">
        <button id="back10" class="btn">âª 10Ø«</button>
        <button id="playPause" class="btn">â¯ï¸ ØªØ´ØºÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù</button>
        <button id="fwd10" class="btn">â© 10Ø«</button>
      </div>
      <div class="text-center mt-1 text-sm">
        <span id="timeNow">00:00</span> / <span id="timeTotal">00:00</span>
      </div>
    </section>

    <section class="card p-4">
      <h2 class="font-semibold mb-2 flex items-center justify-between">
        <span>â­ Ø§Ù„Ù…ÙØ¶Ù„Ø©</span>
        <button id="clearFavBtn" class="btn btn-danger text-sm">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>
      </h2>
      <ul id="favorites" class="space-y-2"></ul>
    </section>
  </section>

  <!-- IMAGES SECTION (Ù…ÙƒØ¨Ù‘Ø± Ù„ÙŠØ³ØªØºÙ†ÙŠ Ø¹Ù† Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø© ØºØ§Ù„Ø¨Ø§Ù‹) -->
  <section id="imagesSection" class="space-y-4 hidden">
    <div class="card p-4">
      <h2 class="font-semibold mb-2">ğŸ“– Ø§Ù„Ù…ØµØ­Ù Ø¨Ø§Ù„ØµÙˆØ±</h2>

      <div class="mb-3 flex flex-wrap items-center gap-2">
        <label class="font-medium">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø³ÙˆØ±Ø©</label>
        <select id="surahImageSelect" class="p-2 rounded border text-black"></select>

        <div class="ms-auto flex items-center gap-2">
          <button id="prevPage" class="btn">â¡ Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
          <input id="pageNum" type="number" min="1" max="604" value="1" class="w-20 p-1 border rounded text-black">
          <span>/ 604</span>
          <button id="nextPage" class="btn">Ø§Ù„ØªØ§Ù„ÙŠ â¬…</button>

          <button id="fullscreenBtn" class="btn btn-gold" title="Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø©">ğŸ“º</button>
        </div>
      </div>

      <div id="imageWrapper">
        <img id="quranPage"
             src="https://easyquran.com/wp-content/uploads/2022/09/1-scaled.jpg"
             alt="ØµÙØ­Ø© Ø§Ù„Ù…ØµØ­Ù" loading="lazy">
      </div>
    </div>
  </section>

  <!-- â¬‡ï¸ Ø§Ù„Ø¯ÙØ¹Ø© 2 (Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ø¬Ø§ÙØ§Ø³ÙƒØ±Ø¨Øª) Ø³ØªØ¶Ø§Ù Ù‡Ù†Ø§ -->
</main>
<script>
/* ============ Ø«ÙˆØ§Ø¨Øª ÙˆØªÙ‡ÙŠØ¦Ø© ============ */
const THEMES = ["day","night","special"];
let currentThemeIndex = 0;

const RECITERS = [
  {slug:"maher", name:"Ø§Ù„Ø´ÙŠØ® Ù…Ø§Ù‡Ø± Ø§Ù„Ù…Ø¹ÙŠÙ‚Ù„ÙŠ", base:"https://server12.mp3quran.net/maher"},
  {slug:"ajm", name:"Ø§Ù„Ø´ÙŠØ® Ø£Ø­Ù…Ø¯ Ø¨Ù† Ø¹Ù„ÙŠ Ø§Ù„Ø¹Ø¬Ù…ÙŠ", base:"https://server10.mp3quran.net/ajm"},
  {slug:"afs", name:"Ø§Ù„Ø´ÙŠØ® Ù…Ø´Ø§Ø±ÙŠ Ø§Ù„Ø¹ÙØ§Ø³ÙŠ", base:"https://server8.mp3quran.net/afs"},
  {slug:"sgmd", name:"Ø§Ù„Ø´ÙŠØ® Ø³Ø¹Ø¯ Ø§Ù„ØºØ§Ù…Ø¯ÙŠ", base:"https://server7.mp3quran.net/s_gmd"},
  {slug:"shur", name:"Ø§Ù„Ø´ÙŠØ® Ø³Ø¹ÙˆØ¯ Ø§Ù„Ø´Ø±ÙŠÙ…", base:"https://server7.mp3quran.net/shur"},
  {slug:"sds", name:"Ø§Ù„Ø´ÙŠØ® Ø¹Ø¨Ø¯Ø§Ù„Ø±Ø­Ù…Ù† Ø§Ù„Ø³Ø¯ÙŠØ³", base:"https://server11.mp3quran.net/sds"},
];
const pad3 = n => String(n).padStart(3,"0");

let chapters = [];
const state = {
  playlist: [],
  favorites: [],
  idx: 0,
  mode: "single",
  loop: false,
  resume: {},
  sleepTimeout: null,
  sleepTicker: null,
  sleepEndTs: null
};

/* ============ DOM helpers ============ */
const $ = id => document.getElementById(id);

/* ============ Ø³Ø§Ø¹Ø© + ØªØ§Ø±ÙŠØ® Ù‡Ø¬Ø±ÙŠ/Ù…ÙŠÙ„Ø§Ø¯ÙŠ ============ */
async function updateClock(){
  const d = new Date();
  const g = `${String(d.getDate()).padStart(2,"0")}-${String(d.getMonth()+1).padStart(2,"0")}-${d.getFullYear()}`;
  const t = `${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`; // 24h

  try{
    const r = await fetch(`https://api.aladhan.com/v1/gToH?date=${g}`);
    const j = await r.json();
    const h = j?.data?.hijri;
    const hijri = h ? `${h.day} ${h.month.ar} ${h.year} Ù‡Ù€` : "";
    $("hijriLine").textContent = hijri || "â€”";
    $("gregLine").innerHTML = `${g} | <span class="time">${t}</span>`;
  }catch{
    $("hijriLine").textContent = "â€”";
    $("gregLine").innerHTML = `${g} | <span class="time">${t}</span>`;
  }
}
setInterval(updateClock, 60000);

/* ============ Ø«ÙŠÙ…Ø§Øª ============ */
function applyTheme(t){
  document.body.classList.remove("theme-day","theme-night","theme-special");
  document.body.classList.add("theme-"+t);
  localStorage.setItem("theme_choice", t);
  $("themeIcon").textContent = t==="day" ? "ğŸŒ" : t==="night" ? "ğŸŒ™" : "ğŸ’š";
}
function initTheme(){
  const saved = localStorage.getItem("theme_choice");
  if(saved && THEMES.includes(saved)){
    applyTheme(saved);
    currentThemeIndex = THEMES.indexOf(saved);
  }else{
    applyTheme("day");
    currentThemeIndex = 0;
  }
}
$("themeToggle").onclick = () => {
  currentThemeIndex = (currentThemeIndex + 1) % THEMES.length;
  applyTheme(THEMES[currentThemeIndex]);
};

/* ============ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³ÙˆØ± ============ */
async function fetchChapters(){
  try{
    const res = await fetch("https://api.quran.com/api/v4/chapters");
    const data = await res.json();
    chapters = data.chapters || [];
    localStorage.setItem("chapters_cache", JSON.stringify(chapters));
  }catch{
    const cache = localStorage.getItem("chapters_cache");
    chapters = cache ? JSON.parse(cache) : [...Array(114)].map((_,i)=>({id:i+1,name_arabic:`Ø³ÙˆØ±Ø© ${i+1}`}));
  }

  $("surahSelect").innerHTML = chapters.map(c=>`<option value="${c.id}">${c.id}. ${c.name_arabic}</option>`).join("");
  $("reciterSelect").innerHTML = RECITERS.map(r=>`<option value="${r.slug}">${r.name}</option>`).join("");

  $("surahImageSelect").innerHTML =
    `<option value="0">ğŸ“– ÙƒØ§Ù…Ù„ Ø§Ù„Ù‚Ø±Ø¢Ù†</option>`+
    chapters.map(c=>`<option value="${c.id}">${c.id}. ${c.name_arabic}</option>`).join("");
}

/* ============ ØªØ¨ÙˆÙŠØ¨Ø§Øª ============ */
function setTab(tab){
  if(tab==="audio"){ $("tabAudio").classList.add("tab-active"); $("tabImages").classList.remove("tab-active"); $("audioSection").classList.remove("hidden"); $("imagesSection").classList.add("hidden"); }
  else{ $("tabImages").classList.add("tab-active"); $("tabAudio").classList.remove("tab-active"); $("imagesSection").classList.remove("hidden"); $("audioSection").classList.add("hidden"); }
}
$("tabAudio").onclick = ()=>setTab("audio");
$("tabImages").onclick = ()=>setTab("images");

/* ============ Ø§Ù„ØµÙˆØª ============ */
function persist(){
  localStorage.setItem("playlist", JSON.stringify(state.playlist));
  localStorage.setItem("favorites", JSON.stringify(state.favorites));
  localStorage.setItem("resume", JSON.stringify(state.resume));
  localStorage.setItem("mode", state.mode);
  localStorage.setItem("loop", JSON.stringify(state.loop));
}
function loadPersist(){
  try{
    state.playlist = JSON.parse(localStorage.getItem("playlist")||"[]");
    state.favorites = JSON.parse(localStorage.getItem("favorites")||"[]");
    state.resume   = JSON.parse(localStorage.getItem("resume")||"{}");
    state.mode     = localStorage.getItem("mode") || "single";
    state.loop     = JSON.parse(localStorage.getItem("loop")||"false");
  }catch{}
  document.querySelectorAll("input[name='mode']").forEach(r=>r.checked = (r.value===state.mode));
  $("loopToggle").checked = state.loop;
}

const SURAH_PAGES = {1:1,2:2,3:50,4:77,5:106,6:128,7:151,8:177,9:187,10:208,11:221,12:235,13:249,14:255,15:262,16:267,17:282,18:293,19:305,20:312,21:322,22:332,23:342,24:350,25:359,26:367,27:377,28:385,29:396,30:404,31:411,32:415,33:418,34:428,35:434,36:440,37:446,38:453,39:458,40:467,41:477,42:483,43:489,44:496,45:499,46:502,47:507,48:511,49:515,50:518,51:520,52:523,53:526,54:528,55:531,56:534,57:537,58:542,59:545,60:549,61:551,62:553,63:554,64:556,65:558,66:560,67:562,68:564,69:566,70:568,71:570,72:572,73:574,74:575,75:577,76:578,77:580,78:582,79:583,80:585,81:586,82:587,83:589,84:590,85:591,86:592,87:593,88:594,89:595,90:596,91:597,92:598,93:599,94:599,95:600,96:600,97:601,98:601,99:602,100:602,101:603,102:603,103:603,104:604,105:604,106:604,107:604,108:604,109:604,110:604,111:604,112:604,113:604,114:604};

function formatTime(s){ if(!s||!isFinite(s)) return "00:00"; const m=Math.floor(s/60),sec=Math.floor(s%60); return `${String(m).padStart(2,"0")}:${String(sec).padStart(2,"0")}`; }
function getAudio(){ return $("player"); }

function attachAudioEvents(a, src){
  a.loop = state.loop;
  a.onloadedmetadata = ()=>{
    $("timeTotal").textContent = formatTime(a.duration);
    if(state.resume[src]) a.currentTime = state.resume[src];
  };
  a.ontimeupdate = ()=>{
    if(!isFinite(a.duration)) return;
    $("progressFill").style.width = (a.currentTime/a.duration*100)+"%";
    $("timeNow").textContent = formatTime(a.currentTime);
    state.resume[src] = a.currentTime; localStorage.setItem("resume", JSON.stringify(state.resume));
  };
  a.onended = ()=>{
    if(state.loop){ a.currentTime=0; a.play(); }
    else if(state.idx+1 < state.playlist.length){ state.idx++; render(true); }
  };
}

function render(auto=false){
  const cur = state.playlist[state.idx];
  if(cur){
    $("playerBox").innerHTML = `<div class="mb-2 font-medium">${cur.title} â€” <span class="text-emerald-600">${cur.reciter}</span></div><audio id="player" src="${cur.src}" controls ${auto?'autoplay':''}></audio>`;
    const a = getAudio(); if(a) attachAudioEvents(a, cur.src);
  }else{
    $("playerBox").innerHTML = `<div class="text-slate-500">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ´ØºÙŠÙ„</div>`;
  }

  $("playlist").innerHTML = state.playlist.map((t,i)=>`
    <li class="flex justify-between items-center bg-white/60 rounded px-3 py-2">
      <span>${t.title} - ${t.reciter}</span>
      <span class="flex gap-2">
        <button onclick="_addFav(${i})" title="Ø£Ø¶Ù Ù„Ù„Ù…ÙØ¶Ù„Ø©">â­</button>
        <button onclick="_playAt(${i})" title="ØªØ´ØºÙŠÙ„">â–¶ï¸</button>
        <button onclick="_removeAt(${i})" class="text-red-500" title="Ø­Ø°Ù">ğŸ—‘ï¸</button>
      </span>
    </li>`).join("");

  renderFav();
  persist();
}

/* Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù…Ø´ØºÙ‘Ù„ Ù…Ø¹ Ø§Ø­ØªØ±Ø§Ù… ÙˆØ¶Ø¹ single/multi */
function addToPlaylist(auto=false){
  const recSlug = $("reciterSelect").value;
  const rec = RECITERS.find(r=>r.slug===recSlug);
  const surId = parseInt($("surahSelect").value);
  if(!rec || !surId) return alert("Ø§Ø®ØªØ± Ø§Ù„Ø³ÙˆØ±Ø© ÙˆØ§Ù„Ù‚Ø§Ø±Ø¦ Ø£ÙˆÙ„Ø§Ù‹");

  if(state.mode==="single" && state.playlist.length>0 && state.playlist[0].reciter!==rec.name){
    return alert("ÙÙŠ ÙˆØ¶Ø¹ Ù‚Ø§Ø±Ø¦ ÙˆØ§Ø­Ø¯ ÙÙ‚Ø· ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø³ÙˆØ± Ù„Ù†ÙØ³ Ø§Ù„Ù‚Ø§Ø±Ø¦.");
  }
  const sur = chapters.find(c=>c.id===surId) || {name_arabic:`Ø³ÙˆØ±Ø© ${surId}`};
  const item = {title: sur.name_arabic, reciter: rec.name, src: `${rec.base}/${pad3(surId)}.mp3`};
  state.playlist.push(item); state.idx = state.playlist.length-1; render(auto);
}

/* ØªØ­ÙƒÙ… */
$("addBtn").onclick = ()=>addToPlaylist(true);
$("clearBtn").onclick = ()=>{ if(confirm("Ù…Ø³Ø­ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ØŸ")){ state.playlist=[]; state.idx=0; render(false);} };
$("playPause").onclick = ()=>{ const a=getAudio(); if(a) a.paused ? a.play() : a.pause(); };
$("back10").onclick = ()=>{ const a=getAudio(); if(a) a.currentTime = Math.max(0, a.currentTime-10); };
$("fwd10").onclick  = ()=>{ const a=getAudio(); if(a) a.currentTime = Math.min((a.duration||a.currentTime+10), a.currentTime+10); };
$("progressBar").onclick = (e)=>{ const a=getAudio(); if(!a||!isFinite(a.duration))return; const r=e.currentTarget.getBoundingClientRect(); const ratio=(e.clientX-r.left)/r.width; a.currentTime = a.duration * Math.max(0,Math.min(1,ratio)); };

document.querySelectorAll("input[name='mode']").forEach(r=>r.onchange = (e)=>{ state.mode = e.target.value; persist(); });
$("loopToggle").onchange = (e)=>{ state.loop = e.target.checked; persist(); const a=getAudio(); if(a) a.loop = state.loop; };

/* Ø§Ù„Ù…ÙØ¶Ù„Ø© */
$("favBtn").onclick = ()=>{ const cur=state.playlist[state.idx]; if(!cur) return; if(!state.favorites.some(f=>f.src===cur.src && f.reciter===cur.reciter)){ state.favorites.push(cur); persist(); renderFav(); } };
$("clearFavBtn").onclick = ()=>{ if(confirm("Ù…Ø³Ø­ Ø§Ù„Ù…ÙØ¶Ù„Ø©ØŸ")){ state.favorites=[]; persist(); renderFav(); } };

function renderFav(){
  $("favorites").innerHTML = state.favorites.map((f,i)=>`
    <li class="flex justify-between items-center px-3 py-2 bg-white/60 rounded">
      <span>${f.title} - ${f.reciter}</span>
      <span class="flex gap-2">
        <button onclick="_playFav(${i})" title="ØªØ´ØºÙŠÙ„">â–¶ï¸</button>
        <button onclick="_delFav(${i})" class="text-red-500" title="Ø­Ø°Ù">ğŸ—‘ï¸</button>
      </span>
    </li>`).join("");
}
window._playAt = (i)=>{ state.idx=i; render(true); };
window._removeAt = (i)=>{ state.playlist.splice(i,1); state.idx = Math.max(0, Math.min(state.idx, state.playlist.length-1)); render(false); };
window._addFav = (i)=>{ const it=state.playlist[i]; if(!it) return; if(!state.favorites.some(f=>f.src===it.src && f.reciter===it.reciter)){ state.favorites.push(it); persist(); renderFav(); } };
window._playFav = (i)=>{ const it=state.favorites[i]; if(!it) return; if(state.mode==="single" && state.playlist.length>0 && state.playlist[0].reciter !== it.reciter){ return alert("ÙÙŠ ÙˆØ¶Ø¹ Ù‚Ø§Ø±Ø¦ ÙˆØ§Ø­Ø¯ ÙÙ‚Ø· Ù„Ù†ÙØ³ Ø§Ù„Ù‚Ø§Ø±Ø¦."); } state.playlist.push(it); state.idx=state.playlist.length-1; render(true); };
window._delFav = (i)=>{ state.favorites.splice(i,1); persist(); renderFav(); };

/* Ù…Ø¤Ù‚Ù‘Øª Ø§Ù„Ù†ÙˆÙ… */
$("sleepSet").onclick = ()=>{
  const min = parseInt($("sleepMinutes").value);
  if(isNaN(min)||min<=0) return alert("Ø£Ø¯Ø®Ù„ Ø¯Ù‚Ø§Ø¦Ù‚ ØµØ­ÙŠØ­Ø©");
  if(state.sleepTimeout) clearTimeout(state.sleepTimeout);
  if(state.sleepTicker) clearInterval(state.sleepTicker);

  const a = getAudio();
  state.sleepEndTs = Date.now() + min*60000;

  state.sleepTimeout = setTimeout(()=>{ if(a) a.pause(); $("sleepStatus").textContent="â¹ï¸ ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ´ØºÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹"; clearInterval(state.sleepTicker); state.sleepTicker=null; }, min*60000);

  state.sleepTicker = setInterval(()=>{
    const remain = Math.max(0, state.sleepEndTs - Date.now());
    const m = Math.floor(remain/60000), s = Math.floor((remain%60000)/1000);
    $("sleepStatus").textContent = `Ø³ÙŠØªÙ… Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù Ø¨Ø¹Ø¯ ${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
    if(remain<=0){ clearInterval(state.sleepTicker); state.sleepTicker=null; }
  }, 1000);
};
$("sleepCancel").onclick = ()=>{ if(state.sleepTimeout) clearTimeout(state.sleepTimeout); if(state.sleepTicker) clearInterval(state.sleepTicker); state.sleepTimeout=null; state.sleepTicker=null; state.sleepEndTs=null; $("sleepStatus").textContent="ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡"; };

/* ============ Ø§Ù„Ù…ØµØ­Ù Ø§Ù„Ù…ØµÙˆÙ‘Ø± ============ */
const TOTAL_PAGES = 604;
const EASYQURAN_BASE = "https://easyquran.com/wp-content/uploads/2022/09/";
const imgEl = $("quranPage");
const pageInput = $("pageNum");
const wrapper = $("imageWrapper");

function buildUrl(p){ return `${EASYQURAN_BASE}${p}-scaled.jpg`; }
function loadPage(n){
  const p = Math.max(1, Math.min(TOTAL_PAGES, parseInt(n)||1));
  pageInput.value = p;
  imgEl.src = buildUrl(p);
}
$("nextPage").onclick = ()=>loadPage(+pageInput.value + 1);
$("prevPage").onclick = ()=>loadPage(+pageInput.value - 1);
pageInput.onchange = ()=>loadPage(pageInput.value);

$("surahImageSelect").onchange = (e)=>{
  const id = parseInt(e.target.value);
  if(id===0) loadPage(1);
  else if(SURAH_PAGES[id]) loadPage(SURAH_PAGES[id]);
};

/* Ø³Ø­Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„: ÙŠÙ…ÙŠÙ† = Ø§Ù„Ø³Ø§Ø¨Ù‚ØŒ ÙŠØ³Ø§Ø± = Ø§Ù„ØªØ§Ù„ÙŠ */
let touchStartX = 0;
imgEl.addEventListener("touchstart",(e)=>{ touchStartX = e.changedTouches[0].screenX; }, {passive:true});
imgEl.addEventListener("touchend",(e)=>{
  const dx = e.changedTouches[0].screenX - touchStartX;
  if(Math.abs(dx) > 50){
    if(dx > 0) loadPage(+pageInput.value - 1); // ÙŠÙ…ÙŠÙ† â†’ Ø§Ù„Ø³Ø§Ø¨Ù‚
    else       loadPage(+pageInput.value + 1); // ÙŠØ³Ø§Ø± â†’ Ø§Ù„ØªØ§Ù„ÙŠ
  }
}, {passive:true});

/* Ø³Ø­Ø¨ Ø¨Ø§Ù„Ù…Ø§ÙˆØ³ (pan) Ø¯Ø§Ø®Ù„ Ø§Ù„Ø­Ø§ÙˆÙŠØ© (ÙŠØ´Ù…Ù„ Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø©) */
let isPanning = false, startClientX=0, startScrollLeft=0;
wrapper.addEventListener("pointerdown",(e)=>{
  isPanning = true;
  startClientX = e.clientX;
  startScrollLeft = wrapper.scrollLeft;
  wrapper.setPointerCapture(e.pointerId);
});
wrapper.addEventListener("pointermove",(e)=>{
  if(!isPanning) return;
  wrapper.scrollLeft = startScrollLeft - (e.clientX - startClientX);
});
wrapper.addEventListener("pointerup",()=>{ isPanning=false; });
wrapper.addEventListener("pointercancel",()=>{ isPanning=false; });

/* Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø© Ù…Ø¹ Ø¯Ø¹Ù… webkit */
$("fullscreenBtn").onclick = ()=>{
  if(wrapper.requestFullscreen) wrapper.requestFullscreen();
  else if(wrapper.webkitRequestFullscreen) wrapper.webkitRequestFullscreen();
};
document.addEventListener("fullscreenchange",()=>{
  // Ù„Ø§ Ù†ØºÙŠÙ‘Ø± object-fit Ù…Ù† CSSØŒ ÙÙ‚Ø· Ù†Ø¶Ù…Ù† Ø§Ù„Ø³Ù„ÙˆÙƒ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
  // Ø§Ù„Ø³Ø­Ø¨ Ø¨Ø§Ù„Ù…Ø§ÙˆØ³ Ø³ÙŠØ¨Ù‚Ù‰ Ø¹Ø¨Ø± wrapper.scrollLeft
});

/* Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØ¯ÙˆÙŠØ± Ø§Ù„Ø´Ø§Ø´Ø©: Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø£Ù‚ØµÙ‰ Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø­Ø§ÙˆÙŠØ© */
function adjustWrapperMaxHeight(){
  // Ù†ÙØ³ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ CSS Ù„ÙƒÙ† Ù†Ø¹ÙŠØ¯ ØªÙØ¹ÙŠÙ„Ù‡Ø§ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¯ÙˆÙŠØ±
  wrapper.style.maxHeight = "calc(100vh - 120px)";
}
window.addEventListener("orientationchange", ()=> setTimeout(adjustWrapperMaxHeight, 300));
window.addEventListener("resize", ()=> setTimeout(adjustWrapperMaxHeight, 200));

/* ============ Ø¥Ù‚Ù„Ø§Ø¹ ============ */
window.addEventListener("DOMContentLoaded", ()=>{
  initTheme();
  updateClock();

  loadPersist();
  render(false); renderFav();

  fetchChapters();
  loadPage(1);

  setTab("audio");
  adjustWrapperMaxHeight();
});
</script>
