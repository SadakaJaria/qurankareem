<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>📖 القرآن الكريم – صدقة جارية</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
:root{
  --gold:#d4af37;
  --ink:#0f172a;
  --soft:#f1f5f9;
}

/* أساس */
body{
  font-family:"Noto Naskh Arabic UI","Segoe UI",system-ui,sans-serif;
  transition:background .3s,color .3s;
}

/* البطاقات والأزرار */
.card{border-radius:.75rem;box-shadow:0 4px 12px rgba(0,0,0,.1)}
.btn{padding:.45rem .85rem;border-radius:.6rem;font-weight:600;transition:.2s}
.btn-gold{background:var(--gold);color:#1f2937}
.btn-danger{background:#ef4444;color:#fff}
.btn-ghost{background:transparent;border:1px solid rgba(0,0,0,.15)}
.btn-contrast{background:#f1f5f9;color:#0f172a;border:1px solid #cbd5e1}

/* الثيمات */
.theme-day{background:#f8fafc;color:#0f172a}
.theme-day .card{background:#ffffff;color:#0f172a}
.theme-night{background:#0f172a;color:#f1f5f9}
.theme-night .card{background:#111827;color:#f1f5f9}
.theme-special{background:#0b3a2b;color:#fefce8}
.theme-special .card{background:#0f4a33;color:#fefce8;border:1px solid rgba(212,175,55,.25)}

/* الهيدر */
header#appHeader{
  padding:1rem;background:transparent;backdrop-filter:blur(6px);
  border-bottom:1px solid rgba(0,0,0,.08);
}
#themeToggle, #whatsappTop{
  width:2.3rem;height:2.3rem;border-radius:.65rem;
  display:flex;align-items:center;justify-content:center;
}
#themeToggle{background:var(--gold);color:#1f2937}
#whatsappTop{background:#25D366}
#whatsappTop img{width:20px;height:20px}

/* الساعة */
.clock-box{text-align:end;line-height:1.25}
.clock-box div{font-size:.9rem}

/* التبويبات (واضحة في كل الثيمات) */
nav.top-tabs{max-width:80rem;margin:auto}
.top-tabs .btn{border-radius:1.1rem;padding:.55rem 1.1rem;font-weight:700}
.tab-active{background:var(--gold);color:#1f2937}
.tab-inactive{background:#e5e7eb;color:#111;opacity:.9}
.theme-night .tab-active{background:var(--gold);color:#1f2937}
.theme-night .tab-inactive{background:#374151;color:#f9fafb;opacity:.95}
.theme-special .tab-inactive{background:#0e5a40;color:#eafff3;opacity:.95}

/* المصحف المصوّر */
.quran-controls{
  display:flex;flex-wrap:wrap;align-items:center;gap:.45rem;
  padding:.35rem .6rem;background:#eef2f7;border-radius:8px;
  border:1px solid #cbd5e1;
}
.quran-controls select{
  padding:.34rem .55rem;border-radius:8px;border:1px solid #cbd5e1;
  background:#fff;color:#0b1423
}
.quran-controls .btn-tv{background:var(--gold);color:#1f2937;padding:.34rem .6rem;border-radius:.5rem}

.quran-stage{background:#e8edf5;border-radius:10px;padding:.4rem}
#imageWrapper{
  width:100%;height:calc(100vh - 165px);overflow:auto;
  display:flex;align-items:center;justify-content:center;
  background:#fff;border-radius:8px;scroll-behavior:smooth;
}
#quranPage{
  display:block;max-width:100%;max-height:100%;height:auto;margin:auto;
  border-radius:6px;user-select:none;-webkit-user-drag:none;
  box-shadow:0 2px 10px rgba(0,0,0,.12);
}
#imageWrapper:fullscreen img{width:auto!important;height:100vh!important;object-fit:contain}

/* ألوان عداد الصفحات حسب الثيم */
#totalPages{color:#111;transition:color .3s}
.theme-night #totalPages{color:#f1f5f9}
.theme-special #totalPages{color:var(--gold)}

/* الصوت */
#progressBar{width:100%;height:6px;background:#e5e7eb;border-radius:999px;cursor:pointer}
#progressFill{height:100%;width:0;background:#10b981;border-radius:999px}
.sleep-row input{
  width:4.8rem;padding:.32rem;border-radius:.5rem;border:1px solid #cbd5e1;background:#fff;color:#0b1423
}

/* موبايل */
@media (max-width:640px){
  #imageWrapper{height:calc(100dvh - 140px)}
}
</style>
</head>

<body class="theme-day min-h-screen">
<header id="appHeader" class="sticky top-0 z-10 flex items-center justify-between gap-3">
  <div class="flex items-center gap-2">
    <!-- زر الثيم -->
    <button id="themeToggle" title="تبديل الوضع"><span id="themeIcon">🌞</span></button>

    <!-- واتساب بجانب الثيم -->
    <a id="whatsappTop" href="https://wa.me/905533331339" target="_blank" title="واتساب">
      <img src="https://i.imgur.com/XC8wuji.png" alt="WhatsApp">
    </a>

    <!-- العنوان (يبقى نص) -->
    <h1 class="font-bold text-base sm:text-lg">📖 القرآن الكريم – <span class="font-normal">صدقة جارية</span></h1>
  </div>
  <div class="clock-box">
    <div id="hijriLine">—</div>
    <div id="gregLine">—</div>
  </div>
</header>

<!-- Tabs -->
<nav class="top-tabs p-4 flex gap-2">
  <button id="tabAudio" class="btn tab-inactive">الصوت 🔊</button>
  <button id="tabImages" class="btn tab-active">المصحف المصوّر 🖼️</button>
</nav>

<main class="space-y-6">
  <!-- المصحف المصوّر -->
  <section id="imagesSection" class="space-y-3">
    <div class="card p-3">
      <h2 class="font-semibold mb-2">📖 المصحف المصوّر</h2>

      <div class="quran-controls">
        <label class="opacity-80 text-sm">السورة:</label>
        <select id="surahImageSelect" class="text-black"></select>

        <div class="flex items-center gap-2 ms-auto">
          <div class="flex items-center gap-1">
            <input id="pageNum" type="number" min="1" max="604" value="1" class="w-20 p-1 rounded border text-black bg-white">
            <span id="totalPages" class="font-semibold">/ 604</span>
          </div>
          <button id="fullscreenBtn" class="btn btn-tv" title="ملء الشاشة">📺</button>
        </div>
      </div>

      <div class="quran-stage">
        <div id="imageWrapper">
          <img id="quranPage"
               src="https://easyquran.com/wp-content/uploads/2022/09/1-scaled.jpg"
               alt="صفحة المصحف" loading="lazy">
        </div>
      </div>
    </div>
  </section>

  <!-- الصوت -->
  <section id="audioSection" class="hidden space-y-4">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div class="card p-4">
        <h2 class="mb-2 font-semibold">اختيار السورة</h2>
        <select id="surahSelect" class="w-full p-2 rounded border text-black"></select>
      </div>
      <div class="card p-4">
        <h2 class="mb-2 font-semibold">اختيار القارئ</h2>
        <select id="reciterSelect" class="w-full p-2 rounded border text-black"></select>
      </div>
    </div>

    <div class="card p-4">
      <h2 class="font-semibold mb-2">وضع التشغيل</h2>
      <div class="flex flex-wrap items-center gap-4 text-sm">
        <label><input type="radio" name="mode" value="single" checked> قارئ واحد</label>
        <label><input type="radio" name="mode" value="multi"> عدة قراء</label>
        <label><input type="checkbox" id="loopToggle"> تكرار السورة</label>
      </div>

      <div class="mt-3 flex flex-wrap gap-2 items-center text-sm sleep-row">
        <label>⏱️ مؤقّت النوم</label>
        <input id="sleepMinutes" type="number" min="0" step="1" placeholder="دقائق">
        <button id="sleepSet" class="px-3 py-1 bg-slate-600 text-white rounded">تفعيل</button>
        <button id="sleepCancel" class="px-3 py-1 bg-red-500 text-white rounded">إلغاء</button>
        <span id="sleepStatus" class="text-sm"></span>
      </div>
    </div>

    <div class="flex gap-3">
      <button id="addBtn" class="flex-1 btn btn-gold">➕ إضافة للمشغل</button>
      <button id="favBtn" class="flex-1 btn btn-ghost">⭐ مفضلة</button>
    </div>

    <div class="card p-4">
      <h2 class="font-semibold mb-2 flex items-center justify-between">
        <span>قائمة التشغيل</span>
        <button id="clearBtn" class="btn btn-danger text-sm">🗑️ مسح الكل</button>
      </h2>
      <ul id="playlist" class="space-y-2"></ul>
    </div>

    <div class="card p-4">
      <h2 class="font-semibold mb-2">المشغّل</h2>
      <div id="playerBox"></div>
      <div id="progressBar" class="mt-2"><div id="progressFill"></div></div>
      <div class="flex items-center justify-center gap-2 mt-2">
        <button id="back10" class="btn btn-contrast">⏪ 10ث</button>
        <button id="playPause" class="btn btn-contrast">⏯️ تشغيل/إيقاف</button>
        <button id="fwd10" class="btn btn-contrast">⏩ 10ث</button>
      </div>
      <div class="text-center mt-1 text-sm">
        <span id="timeNow">00:00</span> / <span id="timeTotal">00:00</span>
      </div>
    </div>

    <div class="card p-4">
      <h2 class="font-semibold mb-2 flex items-center justify-between">
        <span>⭐ المفضلة</span>
        <button id="clearFavBtn" class="btn btn-danger text-sm">🗑️ مسح الكل</button>
      </h2>
      <ul id="favorites" class="space-y-2"></ul>
    </div>
  </section>

<!-- 🔽 الدفعة الثانية (JavaScript) تُلصق هنا قبل </body> 🔽 -->

</main>
<script>
// ========== الإعدادات العامة ==========
const RECITERS = [
  { slug: "maher", name: "الشيخ ماهر المعيقلي", base: "https://server12.mp3quran.net/maher" },
  { slug: "ajm", name: "الشيخ أحمد بن علي العجمي", base: "https://server10.mp3quran.net/ajm" },
  { slug: "basit_mj", name: "الشيخ عبدالباسط عبدالصمد (المجوّد)", base: "https://server7.mp3quran.net/basit/Almusshaf-Al-Mojawwad" },
  { slug: "afs", name: "الشيخ مشاري بن راشد العفاسي", base: "https://server8.mp3quran.net/afs" },
  { slug: "sgmd", name: "الشيخ سعد الغامدي", base: "https://server7.mp3quran.net/s_gmd" },
  { slug: "husr", name: "الشيخ محمود خليل الحصري", base: "https://server13.mp3quran.net/husr" },
  { slug: "shur", name: "الشيخ سعود الشريم", base: "https://server7.mp3quran.net/shur" },
  { slug: "shatri", name: "الشيخ أبو بكر الشاطري", base: "https://server11.mp3quran.net/shatri" },
  { slug: "minsh", name: "الشيخ محمد صديق المنشاوي", base: "https://server10.mp3quran.net/minsh" },
  { slug: "sds", name: "الشيخ عبدالرحمن السديس", base: "https://server11.mp3quran.net/sds" }
];
const pad3 = n => String(n).padStart(3, "0");
let chapters = [];
const state = { playlist: [], favorites: [], idx: 0, mode: "single", loop: false, resume: {}, sleepTimeout: null };

// ========== تحميل السور ==========
async function fetchChapters(){
  try {
    const res = await fetch("https://api.quran.com/api/v4/chapters");
    const data = await res.json();
    chapters = data.chapters || [];
  } catch {
    chapters = [...Array(114)].map((_, i) => ({ id: i + 1, name_arabic: `سورة ${i + 1}` }));
  }
  document.getElementById("surahSelect").innerHTML =
    chapters.map(c => `<option value="${c.id}">${c.id}. ${c.name_arabic}</option>`).join("");
  document.getElementById("reciterSelect").innerHTML =
    RECITERS.map(r => `<option value="${r.slug}">${r.name}</option>`).join("");
  document.getElementById("surahImageSelect").innerHTML =
    `<option value="0">📖 كامل القرآن (604 صفحة)</option>` +
    chapters.map(c => `<option value="${c.id}">${c.id}. ${c.name_arabic}</option>`).join("");
}

// ========== الساعة ==========
async function updateClock(){
  const d = new Date();
  const gDate = `${String(d.getDate()).padStart(2,"0")}-${String(d.getMonth()+1).padStart(2,"0")}-${d.getFullYear()}`;
  const t = `${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;
  try {
    const r = await fetch(`https://api.aladhan.com/v1/gToH?date=${gDate}`);
    const j = await r.json();
    const h = j.data.hijri;
    document.getElementById("hijriLine").textContent = `${h.day} ${h.month.ar} ${h.year} هـ`;
  } catch {
    document.getElementById("hijriLine").textContent = "(الهجري غير متاح)";
  }
  document.getElementById("gregLine").textContent = `${gDate} | ${t}`;
}
setInterval(updateClock, 60000);

// ========== الثيم ==========
const THEMES = ["day","night","special"];
let currentThemeIndex = 0;
function applyTheme(t){
  document.body.classList.remove("theme-day","theme-night","theme-special");
  document.body.classList.add("theme-"+t);
  document.getElementById("themeIcon").textContent = t==="night"?"🌙":t==="special"?"💚":"🌞";
  localStorage.setItem("theme_choice",t);
}
function initTheme(){
  const s = localStorage.getItem("theme_choice");
  s ? applyTheme(s) : applyTheme("day");
}
document.getElementById("themeToggle").onclick = () => {
  currentThemeIndex = (currentThemeIndex+1)%THEMES.length;
  applyTheme(THEMES[currentThemeIndex]);
};

// ========== التبويبات ==========
function setTab(tab){
  const tabA=document.getElementById("tabAudio"), tabI=document.getElementById("tabImages");
  const secA=document.getElementById("audioSection"), secI=document.getElementById("imagesSection");
  if(tab==="audio"){
    tabA.classList.add("tab-active"); tabA.classList.remove("tab-inactive");
    tabI.classList.add("tab-inactive"); tabI.classList.remove("tab-active");
    secA.classList.remove("hidden"); secI.classList.add("hidden");
  }else{
    tabI.classList.add("tab-active"); tabI.classList.remove("tab-inactive");
    tabA.classList.add("tab-inactive"); tabA.classList.remove("tab-active");
    secI.classList.remove("hidden"); secA.classList.add("hidden");
  }
}
document.getElementById("tabAudio").onclick=()=>setTab("audio");
document.getElementById("tabImages").onclick=()=>setTab("images");

// ========== المصحف المصوّر ==========
const TOTAL_PAGES=604;
const imgEl=document.getElementById("quranPage");
const pageInput=document.getElementById("pageNum");
function loadPage(n){
  const p=Math.max(1,Math.min(TOTAL_PAGES,parseInt(n)||1));
  pageInput.value=p;
  imgEl.src=`https://easyquran.com/wp-content/uploads/2022/09/${p}-scaled.jpg`;
}
pageInput.onchange=()=>loadPage(pageInput.value);
document.getElementById("fullscreenBtn").onclick=()=>document.getElementById("imageWrapper").requestFullscreen();

// السحب اليدوي والماوس
let touchStartX=0;
imgEl.addEventListener("touchstart",e=>touchStartX=e.changedTouches[0].screenX);
imgEl.addEventListener("touchend",e=>{
  const dx=e.changedTouches[0].screenX-touchStartX;
  if(Math.abs(dx)>50){
    if(dx>0)loadPage(pageInput.value-1); else loadPage(parseInt(pageInput.value)+1);
  }
});
const wrapper=document.getElementById("imageWrapper");
let isDragging=false,startX=0,scrollLeft=0;
wrapper.addEventListener("mousedown",e=>{isDragging=true;startX=e.pageX-wrapper.offsetLeft;scrollLeft=wrapper.scrollLeft;});
wrapper.addEventListener("mouseleave",()=>isDragging=false);
wrapper.addEventListener("mouseup",()=>isDragging=false);
wrapper.addEventListener("mousemove",e=>{
  if(!isDragging)return;
  e.preventDefault();
  const x=e.pageX-wrapper.offsetLeft;
  const walk=(x-startX)*0.3;
  wrapper.scrollLeft=scrollLeft-walk;
});
wrapper.addEventListener("wheel",e=>e.stopPropagation(),{passive:true});

// الأسهم يمين/يسار
document.addEventListener("keydown",e=>{
  if(!document.getElementById("imagesSection").classList.contains("hidden")){
    if(e.key==="ArrowRight")loadPage(parseInt(pageInput.value)+1);
    if(e.key==="ArrowLeft")loadPage(pageInput.value-1);
  }
});

// ========== الصوت ==========
function persist(){
  localStorage.setItem("playlist",JSON.stringify(state.playlist));
  localStorage.setItem("favorites",JSON.stringify(state.favorites));
  localStorage.setItem("resume",JSON.stringify(state.resume));
}
function add(auto=false){
  const recSlug=document.getElementById("reciterSelect").value;
  const rec=RECITERS.find(r=>r.slug===recSlug);
  const surId=parseInt(document.getElementById("surahSelect").value);
  if(!rec||!surId)return;
  const sur=chapters.find(c=>c.id===surId);
  const newItem={title:sur.name_arabic,reciter:rec.name,src:`${rec.base}/${pad3(surId)}.mp3`};
  if(state.mode==="single"&&state.playlist.length>0){
    if(state.playlist[0].reciter!==rec.name){alert("❌ لا يمكن خلط القراء في وضع قارئ واحد.");return;}
  }
  state.playlist.push(newItem);state.idx=state.playlist.length-1;persist();render(auto);
}
function render(auto){
  const cur=state.playlist[state.idx];
  const box=document.getElementById("playerBox");
  if(cur){
    box.innerHTML=`<div class="mb-2 font-medium">${cur.title} — <span class="text-emerald-400">${cur.reciter}</span></div>
    <audio id="player" src="${cur.src}" controls ${auto?"autoplay":""}></audio>`;
    const a=document.getElementById("player");
    a.loop=state.loop;
    a.ontimeupdate=()=>{updateProgress();state.resume[cur.src]=a.currentTime;persist();};
    a.onloadedmetadata=()=>document.getElementById("timeTotal").textContent=formatTime(a.duration);
    a.onended=()=>{if(state.loop)a.play();else if(state.idx+1<state.playlist.length){state.idx++;render(true);}};
  }else box.innerHTML="<div class='text-slate-500'>لا يوجد تشغيل</div>";
  document.getElementById("playlist").innerHTML=state.playlist.map((t,i)=>`
    <li class="flex justify-between items-center bg-white/70 px-3 py-2 rounded">
      <span>${t.title} - ${t.reciter}</span>
      <span>
        <button onclick="addFavFromList(${
</body>
</html>
